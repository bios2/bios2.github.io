<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pedro Peres-Neto">
<meta name="dcterms.date" content="2021-05-17">
<meta name="description" content="In this workshop we will explore, discuss, and apply generalized linear models to combine information on species distributions, traits, phylogenies, environmental and landscape variation. We will also discuss inference under spatial and phylogenetic autocorrelation under fixed and random effects implementations. We will discuss technical elements and cover implementations using R.">

<title>Generalized Linear Models for Community Ecology – BIOS² Education resources</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ecb778d5ef56ea6a42975469c354c5e4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: [{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../Bios2_reverse.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">BIOS² Education resources</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-intensive-courses" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Intensive courses</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-intensive-courses">    
        <li>
    <a class="dropdown-item" href="../../summer-schools/v2024/BiodiversityModelling2024.html">
 <span class="dropdown-text">Biodiversity Modelling Summer School 2024</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../summer-schools/v2022/BiodiversityModelling2022.html">
 <span class="dropdown-text">Biodiversity Modelling Summer School 2022</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://bios2.github.io/biodiversity_modelling_2021/">
 <span class="dropdown-text">Biodiversity Modelling Summer School 2021</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../summer-schools/v2019/BiodiversityModelling2019.html">
 <span class="dropdown-text">Biodiversity Modelling Summer School 2019</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://bios2.usherbrooke.ca/"> 
<span class="menu-text">About BIOS²</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bios2/bios2.github.io"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/_bios2"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Generalized Linear Models for Community Ecology</h1>
                  <div>
        <div class="description">
          In this workshop we will explore, discuss, and apply generalized linear models to combine information on species distributions, traits, phylogenies, environmental and landscape variation. We will also discuss inference under spatial and phylogenetic autocorrelation under fixed and random effects implementations. We will discuss technical elements and cover implementations using R.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Technical</div>
                <div class="quarto-category">EN</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Pedro Peres-Neto </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Concordia University
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 17, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><span style="font-size:2em;">Generalized Linear Model for Community Ecology</span></p>
<span style="color:black">Pedro Peres-Neto, Concordia University</span><br>
<span style="color:black">BIOS2 workshop, May 17 to 21, 2021</span><br>
<span style="color:black">This document was put together for the first time for this workshop.</span><br>
<span style="color:black">Let me know if you have suggestions or find any issues in the document.</span><br>

<hr style="border:1px solid gray">

<p><span style="color:firebrick"><strong>Tentative schedule</strong></span></p>
<ul>
<li><p>Day 1:<br>
Introduction to types of data and approaches using GLMs in community ecology.<br>
Types of patterns in species distributions involving trait and environmental variation.<br>
Simulating data as a path to understand GLMs in community ecology.<br>
The simplest GLM: widely used bivariate correlations.<br>
The challenges of statistical inference regarding linking different types of information from communities and species.<br>
Understanding estimators and their properties in GLMs.</p></li>
<li><p>Day 2:<br>
From bivariate correlations to a variety of more complex GLMs: the case of Binomial and Poisson.<br>
The role of latents in specifying GLMs for community ecology.<br>
The issues underlying autocorrelation in ecological data: the cases of spatial and phylogenetic autocorrelation.<br>
Simple GLMM approaches (Generalized Linear Mixed Models).</p></li>
<li><p>Day 3:<br>
More complex GLMM approaches.<br>
Potential approaches for incorporating intraspecific data on traits.<br>
Discussion with participants: your research interests, your questions or your data (or anything really).</p></li>
</ul>
<p><span style="color:firebrick"><strong>Philosophy:</strong></span> We can’t cover everything with extreme details. I’ve chosen a level that should be interesting enough and cover many different important aspects of GLMs applied to community ecology.</p>
<p><span style="color:firebrick"><strong>Note:</strong></span> I mostly apply here base functions so that participants without strong knowledge of certain packages (e.g., ggplot, dplyr) can follow the code more easily.</p>
<p><span style="color:firebrick"><strong>Questions:</strong></span> Participants should feel free to ask questions either directly or in the zoom chat. I’ve also set a good doc where participants can put questions there during the week when we are not connected. I’ll read them and try to provide an answer or cover the question somehow:</p>
<p><a href="https://docs.google.com/document/d/17GQvGkBFs9MmLv6Yn473_Dr1t1Ps03VdHOHMhbZhBKk/edit">https://docs.google.com/document/d/17GQvGkBFs9MmLv6Yn473_Dr1t1Ps03VdHOHMhbZhBKk/edit</a></p>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Simulating data</strong></span>
</div>
<p><span style="color:firebrick">Simulating a single species</span></p>
<p>One way to develop good intuition underlying quantitative methods is to be able to simulate data according to certain desired characteristics. We can then apply methods (GLMs here) to see how well they retrieve the data characteristics.</p>
<p>Let’s start with a very simple GLM, the logistic regression for one single species. Here, for simplicity, we considered one predictor. In many ecological simulations, this single predictor is considered an “environmental gradient” containing many environmental predictors. We can consider more gradients and we will discuss that later on in the workshop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>n.sites <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.sites)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># controls the max prob. values</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>prob.presence <span class="ot">&lt;-</span> <span class="fl">1.</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>(b0<span class="sc">+</span><span class="dv">3</span><span class="sc">*</span>X)))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(prob.presence <span class="sc">~</span> X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>This model is pretty simple and its form is:</p>
<p><span class="math display">\[p=\frac{1}{1+e^{-(\beta_0+\beta_1X_1)}} = \frac{1}{1+e^{-(0.5+3X_1)}}\]</span></p>
<p>Now let’s generate presences and absences according to the logistic model expectation. Since is a logistic model, we use <code>rbinom</code>,i.e., binomial trials:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n.sites,<span class="dv">1</span>,prob.presence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>View(cbind(prob.presence,Distribution))</code></pre>
<p>Let’s model the data using logistic regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Distribution <span class="sc">~</span> X,<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>logit))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)           X 
 0.09200133  3.66168492 </code></pre>
</div>
</div>
<pre><code>View(cbind(prob.presence,Distribution,model$fitted.values))</code></pre>
<p>Plotting the predicted versus the observed presence-absence values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model<span class="sc">$</span>fitted.values <span class="sc">~</span> Distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>At this point, we won’t cover model diagnostics. Data were simulated according to the model and, as such, assumptions hold well. Plus, this is a single-species model; and this workshop is about community data, i.e., multiple species :).</p>
<p><a href="http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/">This is a good blog explaining how to check for assumptions of logistic regressions.</a></p>
<p><span style="color:firebrick">Simulating a more realistic single species</span></p>
<p>Species don’t tend to respond linearly to environmental features:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Gaussian.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now that we understand some basics of presence-absence data, let’s concentrate on more realistic species distribution data and multi-species data. There are many ways (found in the ecological literature) in which we can simulate these type of data. Below we will generate data using a standard Gaussian model for presence-absence data according to a trait and environmental feature (we will cover abundance data later on). This is a commonly used way to simulate data. Let’s start with a single species and one environmental variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>n.sites <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.sites)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>optimum <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>niche.breadth <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># controls the max prob. values</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a logistic model:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>prob.presence <span class="ot">&lt;-</span> <span class="fl">1.</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>(b0<span class="sc">+</span>(b1<span class="sc">*</span>(X<span class="sc">-</span>optimum)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>niche.breadth<span class="sc">^</span><span class="dv">2</span>)))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This more “complex” model has the following form:</p>
<p><span class="math display">\[p=\frac{1}{1+e^{-(\beta_0+\beta_1\frac{(X-\mu)^2}{2\sigma^2})}}=\frac{1}{1+e^{-(1+2\frac{(X-0.2)^2}{2\cdot0.5^2})}}\]</span> where <span class="math inline">\(\mu\)</span> represents the species optimum and <span class="math inline">\(\sigma\)</span> its niche breadth.</p>
<p>Let’s plot these probabilities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X,prob.presence,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot optimum</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>optimum,<span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s simulate the distribution, i.e., presences and absences according to the model. Since is a logistic, we use <code>rbinom</code>,i.e., binomial trials:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n.sites,<span class="dv">1</span>,prob.presence)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot the species distribution against the environmental variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(X,prob.presence,<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sites.present <span class="ot">&lt;-</span> <span class="fu">which</span>(Distribution<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X[sites.present],Distribution[sites.present],<span class="at">col=</span><span class="st">"green"</span>,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>sites.absent <span class="ot">&lt;-</span> <span class="fu">which</span>(Distribution<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(X[sites.absent],Distribution[sites.absent],<span class="at">col=</span><span class="st">"red"</span>,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The parameters can be then estimated from the data using a logistic regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>predictor <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X,X<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Distribution <span class="sc">~</span> predictor,<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>logit))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>coeffs <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(model)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> coeffs[<span class="dv">1</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> coeffs[<span class="dv">2</span>]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">&lt;-</span> coeffs[<span class="dv">3</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>estimated.optimum <span class="ot">&lt;-</span> <span class="sc">-</span>b1<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>b2) <span class="co"># as in ter Braak and Looman 1986</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>estimated.niche.breadth <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>b2)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(estimated.optimum,estimated.niche.breadth) <span class="co"># estimated by the glm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>predictorX  predictor 
 0.3317377  0.3922625 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(optimum,niche.breadth) <span class="co"># set in our simulations above</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2 0.5</code></pre>
</div>
</div>
<p>We can demonstrate computationally that the parameter estimations are unbiased as they are maximum likelihood via the GLM. Here we will be showing the sampling variation only for niche optimum and breadth. The other two parameters, <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> can be placed in the code below as well, demonstrating that they are also not biased.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>n.samples <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>estimation.matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,n.samples,<span class="dv">2</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(estimation.matrix) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"optimum"</span>,<span class="st">"niche.breadth"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remember that we already set the parameters for the model above, i.e., optimum and niche breadth</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.samples){</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>   X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.sites)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>   prob.presence <span class="ot">&lt;-</span> <span class="fl">1.</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>((<span class="sc">-</span>b0<span class="sc">+</span>((X<span class="sc">-</span>optimum)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>niche.breadth<span class="sc">^</span><span class="dv">2</span>)))) <span class="co"># this is a logistic model</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>   Distribution <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n.sites,<span class="dv">1</span>,prob.presence)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>   predictor <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X,X<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>   model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Distribution <span class="sc">~</span> predictor,<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>logit))</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>   coeffs <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(model)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>   intercept <span class="ot">&lt;-</span> coeffs[<span class="dv">1</span>]</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>   b1 <span class="ot">&lt;-</span> coeffs[<span class="dv">2</span>]</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>   b2 <span class="ot">&lt;-</span> coeffs[<span class="dv">3</span>]</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>   estimation.matrix[i,<span class="st">"optimum"</span>] <span class="ot">&lt;-</span> <span class="sc">-</span>b1<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>b2)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>   estimation.matrix[i,<span class="st">"niche.breadth"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>b2)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There may be warnings “glm.fit: fitted probabilities numerically 0 or 1 occurred”. But that is not a problem per se. It just tells us that the for some species, their models capture the distribution values perfectly. By the way, that also happens with real data.</p>
<p>Let’s observe the random variation around the parameter estimates and the average values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(estimation.matrix)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">apply</span>(estimation.matrix,<span class="dv">2</span>,mean),<span class="at">col=</span><span class="st">"firebrick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(estimation.matrix,<span class="dv">2</span>,mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      optimum niche.breadth 
    0.2016913     0.4834230 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(optimum,niche.breadth) <span class="co"># set in our simulations above</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2 0.5</code></pre>
</div>
</div>
<p>Note how the mean values are pretty close to the true values used to generate the data. This small simulation helps one understand the principles of sampling variation and unbiased estimation.</p>
<p><span style="color:firebrick">Simulating multiple species</span></p>
<p>Now, let’s generalize our code to multiple species. We will create a function that allow us to make sure that all sites have at least one species present and all species are present at least in one site; this is a common (but not necessary) characteristic of data used in community ecology.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>generate_communities <span class="ot">&lt;-</span> <span class="cf">function</span>(tolerance,E,T,n.species,n.communities){</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># generates variation in niche breadth across species</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        niche.breadth <span class="ot">&lt;-</span> <span class="fu">runif</span>(n.species)<span class="sc">*</span>tolerance </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        b0 <span class="ot">&lt;-</span> <span class="fu">runif</span>(n.species,<span class="at">min=</span><span class="sc">-</span><span class="dv">4</span>,<span class="at">max=</span><span class="dv">4</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        prob.presence <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="dv">0</span>,<span class="at">nrow=</span>n.communities,<span class="at">ncol=</span>n.species)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        Dist.matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="dv">0</span>,<span class="at">nrow=</span>n.communities,<span class="at">ncol=</span>n.species)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.species){</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>          <span class="co"># species optima are trait values; which makes sense ecologically</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>          prob.presence[,j] <span class="ot">&lt;-</span> <span class="fl">1.</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>((<span class="sc">-</span>b0[j]<span class="sc">+</span>((E<span class="sc">-</span>T[j])<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>niche.breadth[j]<span class="sc">^</span><span class="dv">2</span>)))) </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>          Dist.matrix[,j] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n.communities,<span class="dv">1</span>,prob.presence[,j])</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        n_species_c <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">colSums</span>(Dist.matrix)<span class="sc">!=</span><span class="dv">0</span>) <span class="co"># _c for check</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        n_communities_c <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">rowSums</span>(Dist.matrix)<span class="sc">!=</span><span class="dv">0</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ((n_species_c <span class="sc">==</span> n.species) <span class="sc">&amp;</span> (n_communities_c<span class="sc">==</span>n.communities)){<span class="cf">break</span>}</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Dist.matrix=</span>Dist.matrix,<span class="at">prob.presence=</span>prob.presence)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(result)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s generate a community. Note that we are using one environmental gradient and one trait. We could consider more variables (trait or environmental features) by adding terms to the logistic equation above. But for the time being, that will suffice. Note, thout, that in many ecological simulations, this single predictor is considered an “environmental gradient” containing many environmental predictors. We can consider more gradients and we will discuss that later on in the workshop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12351</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>Dist <span class="ot">&lt;-</span> <span class="fu">generate_communities</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>Probs <span class="ot">&lt;-</span> Dist<span class="sc">$</span>prob.presence</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> Dist<span class="sc">$</span>Dist.matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the probability values across environmental values. To do that nicely, we need to order the communities according to their environmental values as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>E.sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(E, <span class="at">index.return=</span><span class="cn">TRUE</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Probs.sorted <span class="ot">&lt;-</span> Probs[E.sorted<span class="sc">$</span>ix,]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>E.sorted <span class="ot">&lt;-</span> E.sorted<span class="sc">$</span>x</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(E.sorted, Probs.sorted, <span class="at">cex.lab=</span><span class="fl">1.5</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Enviroment"</span>, <span class="at">ylab =</span> <span class="st">"Probability of presence"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>And let’s plot presences and absences against ordered environmental and trait values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">heatmap</span>(<span class="fu">as.matrix</span>(Distribution),<span class="at">scale=</span><span class="st">"none"</span>,<span class="at">Rowv=</span>E,<span class="at">Colv=</span>T,<span class="at">col=</span><span class="fu">c</span>(<span class="st">"white"</span>,<span class="st">"black"</span>),<span class="at">labCol=</span><span class="st">"species"</span>,<span class="at">labRow=</span><span class="st">"communities"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Classic and simple GLMs for one trait and one environment (bivariate correlations)</strong></span>
</div>
<p>Now that we have a basic understanding of one GLM (logistic) and how they can model different types of community ecology data, i.e., species distributions, traits and environmental variation, we can start looking into approaches that that are used by ecologists to estimate the importance of environmental and trait variation to species distributions.</p>
<p>Let’s start by calculating the simplest and widely used metric of the community weighted trait mean:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>CWM <span class="ot">&lt;-</span> Distribution <span class="sc">%*%</span> T <span class="sc">/</span> <span class="fu">rowSums</span>(Distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For data that are based on presence-absence, this is simply the average of species trait values within communities.</p>
<p>Let’s now correlate CWM with the environment, i.e., community weighted means correlation. This is a widely used approach by ecologists:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CWM <span class="sc">~</span> E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(CWM,E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] 0.9296338</code></pre>
</div>
</div>
<p>Again, the community weighted means correlation is likely the most commonly used approach with 1000s of studies having been published with it.</p>
<p>Another approach is to calculate the species weighted environment means and correlate with trait values. This approach is less common (but still quite used in the ecological literature) and is sometimes referred as to species niche centroid (SNC):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>SNC <span class="ot">&lt;-</span> <span class="fu">t</span>(E <span class="sc">%*%</span> Distribution) <span class="sc">/</span> <span class="fu">colSums</span>(Distribution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now correlate SNC with species traits:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(T <span class="sc">~</span> SNC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(T,SNC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] 0.7700065</code></pre>
</div>
</div>
<p>Note that the two correlations (CWM- and SNC-based) differ. That’s odd as they were both calculated on exactly the same information: the same Species Matrix, Environment and Trait. Peres-Neto, Dray &amp; ter Braak (2017) demonstrated (mathematically) that this issue is related to the fact that although CWM and SNC are based on weights, they don’t standardized and correlate them with the proper weights. CWM is based on averages calculated based on the sum of species (richness or total abundance per community) and SNC is based on averages calculated based on the number of communities in which species are presence (prevalence) or their total abundance.</p>
<p>Because of that, we have found (Peres-Neto et al.&nbsp;2017) a few undesirable properties of these two correlations (CWM and SNC-based correlations). One is that when the correlation is expected to be zero, the sampling variation of these correlations are quite large (i.e., low precision). Let’s evaluate this issue: Below we generate data with structure, but then use a false trait completely independent of the original one, thus destroying the link between trait and environmental variation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">120</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>n.samples <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># set to larger later</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>CWM.cor <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">0</span>,n.samples)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.samples){</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  Dist <span class="ot">&lt;-</span> <span class="fu">generate_communities</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  T.false <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  CWM <span class="ot">&lt;-</span> Dist<span class="sc">$</span>Dist.matrix <span class="sc">%*%</span> T.false <span class="sc">/</span> <span class="fu">rowSums</span>(Dist<span class="sc">$</span>Dist.matrix)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  CWM.cor[i] <span class="ot">&lt;-</span> <span class="fu">cor</span>(CWM,E)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the correlations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(CWM.cor)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(CWM.cor),<span class="at">col=</span><span class="st">"firebrick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Note that the variation is quite large for correlations based on a random trait (i.e., T.false). For example, some correlations were greater than 0.7 and smaller than -0.60. We showed that although the variation is quite large, the expected value is zero; we would need 10000 or more simulations to make <code>mean(CWM.cor)</code> approach almost zero. A similar issue (i.e., large variation, low precision) happens for correlations based on SNO but we won’t simulate here for brevity. One can easily adapt the code above to do so though.</p>
<p>We have shown that precision is much increased when using the 4th corner statistic. Originally described in matrix form by Legendre et al.&nbsp;(1997), we (Peres-Neto et al.&nbsp;2017) demonstrated that the 4th corner statisticit is a GLM assuming an identity link, i.e., normally distributed residuals.</p>
<p>The basis of the 4th corner correlation is that it starts by the standardization of the trait by the sum of their species abundances (or number of sites occupied for presence-absence data), and the standardization of the environment by the sum of their community abundances. The default standardization (function <code>scale</code>) transforms the variable (trait or environment) in a way that its mean and standard deviation are 0 and 1, respectively. A weighted standardization makes the weighted mean and weighted standard deviation to be 0 and 1, respectively.</p>
<p>R doesn’t have a default function for weighted standardization. But this can be done using the follow function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>standardize_w <span class="ot">&lt;-</span> <span class="cf">function</span>(X,w){</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>   ones <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="fu">length</span>(w))</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>   Xc <span class="ot">&lt;-</span> X <span class="sc">-</span> ones <span class="sc">%*%</span> <span class="fu">t</span>(w)<span class="sc">%*%</span> X</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>   Xc <span class="sc">/</span> ones<span class="sc">%*%</span><span class="fu">sqrt</span>(<span class="fu">t</span>(ones)<span class="sc">%*%</span>(Xc<span class="sc">*</span>Xc<span class="sc">*</span>w)) </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s get back to the original data used to calculate CWM and SNC based correlations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12351</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>Dist <span class="ot">&lt;-</span> <span class="fu">generate_communities</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> Dist<span class="sc">$</span>Dist.matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then standardize environment and trait by their respective abundance sums (rows for environment &amp; columns for trait).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make distribution matrix relative to its total sum; it makes calculations easier</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>Dist.rel <span class="ot">&lt;-</span> Distribution<span class="sc">/</span><span class="fu">sum</span>(Distribution)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>Wn <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(Dist.rel)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>Ws <span class="ot">&lt;-</span> <span class="fu">colSums</span>(Dist.rel)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>E.std_w <span class="ot">&lt;-</span> <span class="fu">standardize_w</span>(E,Wn)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>T.std_w <span class="ot">&lt;-</span>  <span class="fu">standardize_w</span>(T,Ws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: In the future, include here the calculation of the weighted mean and standard deviation of E.std_w and T.std_w to show that they are zero and one, respectively (when weighted).</p>
<p>We then calculate the community average trait (weighted standardized) or the species niche centroid (weighted standardized):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>CWM.w <span class="ot">&lt;-</span> Dist.rel <span class="sc">%*%</span> T.std_w <span class="sc">/</span> Wn</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>SNC.w <span class="ot">&lt;-</span> <span class="fu">t</span>(E.std_w) <span class="sc">%*%</span> Dist.rel <span class="sc">/</span> Ws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then calculate the weighted correlation between the two vectors above but their appropriate weights. In the case of CWM.w:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># either using weighted correlation:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(CWM.w) <span class="sc">%*%</span> (E.std_w<span class="sc">*</span>Wn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] 0.2813709</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or the same value using weighted regression:</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(CWM.w <span class="sc">~</span> E.std_w,<span class="at">weights =</span> Wn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = CWM.w ~ E.std_w, weights = Wn)

Coefficients:
(Intercept)      E.std_w  
  8.804e-17    2.814e-01  </code></pre>
</div>
</div>
<p>In the case of SNC.w:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># either using weighted correlation:</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>SNC.w <span class="sc">%*%</span> (T.std_w<span class="sc">*</span>Ws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]
[1,] 0.2813709</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or the same value using weighted regression:</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="fu">t</span>(SNC.w)<span class="sc">~</span>T.std_w,<span class="at">weights =</span> Ws)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = t(SNC.w) ~ T.std_w, weights = Ws)

Coefficients:
(Intercept)      T.std_w  
 -5.000e-17    2.814e-01  </code></pre>
</div>
</div>
<p>Note that regardless whether SNC or CWM were used, the 4th corner correlation gives the same result, which makes sense mathematically as both correlations use the exact same information. The reason (again) that the CWM and SNC standard correlation approaches differ is because they don’t use appropriate weights in their standardization and weighted correlation.</p>
<p>Another issue to notice is that the 4th corner values are smaller than their standard CWM values. Whereas the CWM correlation was 0.9296, the 4th corner was 0.2814. The issue here is that the CWM correlation refers only to the trait variation among communities (trait beta-diversity), whereas the 4th corner refers to the total variation in traits (within, i.e., trait alpha diversity, and among communities, i.e., trait beta-diversity). This was demonstrated by algebraic proofs in Peres-Neto et al.&nbsp;(2017) but we won’t get into these details here.</p>
<p>This does bring an interesting point for the analysis of trait in a community ecology context. The relative trait variation among communities (i.e., total trait beta-diversity) and within communities (i.e., gamma trait diversity) can be estimated as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Among communities </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>Among.Variation <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(<span class="fu">t</span>(CWM.w)<span class="sc">%*%</span>(CWM.w<span class="sc">*</span> Wn))) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Within communities </span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>Within.Variation <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">-</span> Among.Variation</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(Among.Variation,Within.Variation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  9.460287 90.539713</code></pre>
</div>
</div>
<p>The standard CWM correlation is high because it pertains to only 9.46% of the total variation, whereas the 4th corner correlation pertains to all variation, i.e., both within and among. As the among communities component become large, the two correlations become somewhat more similar.</p>
<p>Let’s now investigate the sampling properties of the 4th corner correlation as we did above for the CWM correlation, i.e., when the trait-environment correlation is expected to be zero:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">120</span>) <span class="co"># so that we all have the same results and the same communities and traits are generated as before</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>n.samples <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># set to larger later</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>CWM<span class="fl">.4</span>th.cor <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="dv">0</span>,n.samples)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.samples){</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>   E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>   T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>   Dist <span class="ot">&lt;-</span> <span class="fu">generate_communities</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>   T.false <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species) <span class="co"># destroys the original generated relationship</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>   Dist.rel <span class="ot">&lt;-</span> Dist<span class="sc">$</span>Dist.matrix<span class="sc">/</span><span class="fu">sum</span>(Distribution)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>   Wn <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(Dist.rel)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>   E.std_w <span class="ot">&lt;-</span> <span class="fu">standardize_w</span>(E,Wn)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>   T.std_w.false <span class="ot">&lt;-</span>  <span class="fu">standardize_w</span>(T.false,Ws)</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>   CWM.w.false <span class="ot">&lt;-</span> Dist.rel <span class="sc">%*%</span> T.std_w.false <span class="sc">/</span> Wn</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">t</span>(CWM.w.false) <span class="sc">%*%</span> (E.std_w<span class="sc">*</span>Wn)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>   CWM<span class="fl">.4</span>th.cor[i] <span class="ot">&lt;-</span> <span class="fu">cor</span>(CWM,E)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s compare the two statistics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">cbind</span>(CWM.cor,CWM<span class="fl">.4</span>th.cor))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note how the 4th corner correlation is a much more precise predictor around the true value of zero.</p>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Statistical hypothesis testing</strong></span>
</div>
<p>We know for a while that the bivariate correlations discussed so far have elevated type I error rates based on parametric testing and under certain permutation schemes (Dray and Legendre 2008; and Dray et al.&nbsp;2014). That means that when the statistical null hypothesis of no link between trait and environment will be rejected more often than the preset alpha level (significance level, e.g., 0.05 or 0.01). More recently, this was also established for more complex models (more on this later). Resolving these issues are challenging and remain a very active field of research.</p>
<p>The code so far has helped to build some intuition underlying the different bivariate correlations. We will now use a more complete utility function that allows calculating these different metrics using one single function. This function is part of Peres-Neto et al.&nbsp;(2017).</p>
<p>Download the utility function file:</p>
<p><a href="UtilityFunctions.R" download="">Click here to download it</a></p>
<p>Load the functions into R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"UtilityFunctions.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s use the function that calculates a number of the bivariate correlations, which are essentially simple GLMs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">125</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>Dist <span class="ot">&lt;-</span> <span class="fu">generate_communities</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>TraitEnv.res <span class="ot">&lt;-</span> <span class="fu">TraitEnvCor</span>(Distribution,E,T, <span class="at">Chessel =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>TraitEnv.res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               CWM.cor               wCWM.cor                SNC.cor 
           0.016601826            0.054714685            0.288779046 
              wSNC.cor           Fourthcorner         Chessel.4thcor 
           0.039080469            0.006235766            0.015313259 
 Among Wn-variance (%) Within Wn-variance (%) 
           1.298888497           98.701111503 </code></pre>
</div>
</div>
<p>If we want to isolate the 4th corner correlation, we can simply:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>TraitEnv.res[<span class="st">"Fourthcorner"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fourthcorner 
 0.006235766 </code></pre>
</div>
</div>
<p>Let’s now run permutation Model 2, Model 4 and p.max for data without a link between trait and environment. We first create the data with no link:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">125</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>Dist <span class="ot">&lt;-</span> <span class="fu">generate_communities</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> Dist<span class="sc">$</span>Dist.matrix</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>T.false <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>TraitEnv.res <span class="ot">&lt;-</span> <span class="fu">TraitEnvCor</span>(Distribution,E,T.false, <span class="at">Chessel =</span> <span class="cn">FALSE</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>TraitEnv.res[<span class="st">"Fourthcorner"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fourthcorner 
  0.04168433 </code></pre>
</div>
</div>
<p>Note how the 4th corner correlation is quite low, i.e., 0.0417. Now let’s check this value with permutations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">125</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>nrepet <span class="ot">&lt;-</span> <span class="dv">99</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> TraitEnv.res[<span class="st">"Fourthcorner"</span>]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>sim.row <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> nrepet, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>sim.col <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> nrepet, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nrepet){</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>   per.row <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(Distribution)) <span class="co"># permute communities</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>   per.col <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">ncol</span>(Distribution)) <span class="co"># permute species</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>   sim.row[i] <span class="ot">&lt;-</span> <span class="fu">TraitEnvCor</span>(Distribution,E[per.row],T.false)[<span class="st">"Fourthcorner"</span>]</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>   sim.col[i] <span class="ot">&lt;-</span> <span class="fu">TraitEnvCor</span>(Distribution,E,T.false[per.col])[<span class="st">"Fourthcorner"</span>]</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>pval.row <span class="ot">&lt;-</span> (<span class="fu">length</span>(<span class="fu">which</span>(<span class="fu">abs</span>(sim.row) <span class="sc">&gt;=</span> <span class="fu">abs</span>(obs))) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> (nrepet <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>pval.col <span class="ot">&lt;-</span> (<span class="fu">length</span>(<span class="fu">which</span>(<span class="fu">abs</span>(sim.col) <span class="sc">&gt;=</span> <span class="fu">abs</span>(obs))) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">/</span> (nrepet <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>p.max <span class="ot">&lt;-</span> <span class="fu">max</span>(pval.row,pval.col)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(pval.row,pval.col,p.max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01 0.47 0.47</code></pre>
</div>
</div>
<p>As we can see, although only environmental features were important but not traits, the row permutation (across commmunities) detected the relationship as significant. Note, however, that the permutation across species did not. ter Braak et al.&nbsp;(2012) determined that the maximum value between the two p-values (row and column based) assures appropriate type I error rate as expected alpha.</p>
<p>The function above allows understanding the permutation procedures. That said, the utility function file has a more complete function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">125</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">CorPermutationTest</span>(Distribution, E, T.false, <span class="at">nrepet =</span> <span class="dv">99</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    cor prow pcol pmax
CWM.cor      0.36605145 0.01 0.33 0.33
wCWM.cor     0.28014652 0.01 0.44 0.44
SNC.cor      0.14836877 0.39 0.36 0.39
wSNC.cor     0.09492897 0.26 0.47 0.47
Fourthcorner 0.04168433 0.01 0.47 0.47</code></pre>
</div>
</div>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Bivariate correlations in practice</strong></span>
</div>
<p>I hope by now you are convinced that the 4th corner is a more robust metric of bivariate correlation (one trait and one environment). Here we will use the <code>Aravo</code> community plant data set (Massif du Grand Gabilier, France; Choler 2005) contained in the package <code>ade4</code>. We provide more explanation on the data in Dray et al.&nbsp;(2012). Here we will replicate the analysis in that paper. The data contain species abundances for 82 species distributed into 75 sites. Sites are described by 6 environmental variables: mean snowmelt date over the period 1997–1999, slope inclination, aspect, index of microscale landform, index of physical disturbance due to cryoturbation and solifluction, and an index of zoogenic disturbance due to trampling and burrowing activities of the Alpine marmot. All variables are quantitative except the landform and zoogenic disturbance indexes that are categorical variables with five and three categories, respectively. And eight quantitative functional traits (i.e., vegetative height, lateral spread, leaf elevation angle, leaf area, leaf thickness, specific leaf area, mass-based leaf nitrogen content, and seed mass) were measured on the 82 most abundant plant species (out of a total of 132 recorded species).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="aravo.png" class="img-fluid figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>Load the package and the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("ade4") in case you don't have it installed</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ade4)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(aravo)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(aravo<span class="sc">$</span>spe)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 75 82</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(aravo<span class="sc">$</span>env)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 75  6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(aravo<span class="sc">$</span>trait)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 82  8</code></pre>
</div>
</div>
<p>Let’s estimate the 4th corner correlations between each trait and environmental variable. <code>nrept</code> is the number of permutations and should be set to a reasonable high number (say 9999). Here we will use 999 to speed calculations. Note that all permutation tests (not only the ones for the 4th corner) include the observed correlation as part of the null distribution (i.e., permuted); hence the use of <code>nrept</code> as 999, i.e., 1000 possible permutations (the observed correlation is a possible permutation if we run the test infinite times; which is not possible; so we consider it as default. <code>modeltype</code> is set to 6, which is the largest p-value between model 2 permutation (entire communities in the distribution matrix) and model 4 (entire species in the distribution matrix). The p-max procedure is detailed in ter Braak et. 2012. Finally, p-values are adjusted using the <code>false discovery rate</code> for multiple testing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>four.comb.aravo.adj <span class="ot">&lt;-</span> <span class="fu">fourthcorner</span>(aravo<span class="sc">$</span>env, aravo<span class="sc">$</span>spe,</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>aravo<span class="sc">$</span>traits, <span class="at">modeltype =</span> <span class="dv">6</span>, <span class="at">p.adjust.method.G =</span> <span class="st">"none"</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="at">p.adjust.method.D =</span> <span class="st">"fdr"</span>, <span class="at">nrepet =</span> <span class="dv">999</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results can be retrieved by simply typing:</p>
<pre><code>four.comb.aravo </code></pre>
<p>The ‘classic’ table of results can be produced as follows. D2 indicates that the 4th corner correlation is to be used between the quantitative variable and each category of the qualitative variables. Other bivariate metrics of 4th corner association are also described in Dray and Legendre (2008) for qualitative-quantitative associations. In the default plot, blue cells correspond to negative signicant relationships while red cells correspond to positive signicant relationships (this can be modified using the argument col in the function fourthcorner).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(four.comb.aravo.adj, <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">stat =</span> <span class="st">"D2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Stacking species information as a way to understand how to build more complex GLMs</strong></span>
</div>
<p>Although widely used (1000s of studies published using them), bivariate correlations are the simplest forms of GLMs for community data. That said, the 4th corner correlation can be calculated in a way that allows us (hopefully) to understand how more complex GLMs can be produced. They allow us understanding species stacking. Perhaps I should have considered this presentation before the calculations based on weights and standardizations (will inverst in the next version of the workshop). Let’s build a small data so that we understand this principle. Consider a very artificial distribution matrix with 4 communities and 4 species. It was made artificial so that we can understand well its structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>Distribution</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4]
[1,]    1    1    0    0
[2,]    1    0    0    0
[3,]    0    0    1    1
[4,]    0    0    1    0</code></pre>
</div>
</div>
<p>Let’s create some traits and environmental features:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">8</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">12</span>,<span class="dv">100</span>,<span class="dv">112</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s calculate its 4th corner correlation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">TraitEnvCor</span>(Distribution,E,T)[<span class="st">"Fourthcorner"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fourthcorner 
   0.8902989 </code></pre>
</div>
</div>
<p>The 4th corner correlation is pretty high given the highly structured data. Another way to calculate a 4th corner correlation is by using what we refer to as an “inflated approach”. This approach allows understanding the structure of stacked information. This figure demonstrates the process and calculation:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="InflatedApproach4thcorner.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>Next we stack species distributions, environment and trait information:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Distribution)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>n.sites <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Distribution)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>Dist.stacked <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(Distribution)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>E.stacked <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, n.species) <span class="sc">%x%</span> E</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>T.stacked <span class="ot">&lt;-</span> T <span class="sc">%x%</span> <span class="fu">rep</span>(<span class="dv">1</span>, n.sites)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>View(cbind(Dist.stacked,E.stacked,T.stacked))</code></pre>
<p>We then eliminatate the cells for which the distribution is zero and calculate the correlation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>zeros.dist <span class="ot">&lt;-</span> <span class="fu">which</span>(Dist.stacked<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(E.stacked[<span class="sc">-</span>zeros.dist],T.stacked[<span class="sc">-</span>zeros.dist])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8902989</code></pre>
</div>
</div>
<p>Note: perhaps I should have started with this explanation and then move to the more complicated way of using weights. The inflated approach is in fact a way to see how weights are given.</p>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Simulating abundance data and understanding link functions in GLMs</strong></span>
</div>
<p><span style="color:firebrick">Simple model</span></p>
<p>Although community ecologists commonly work with presence-absence data, abundance data are also commonly used in many approaches. Here we will use a Poisson model to simulate community data involving species distributions, traits and environment. Although link functions are used in all families of GLMs (poisson, binomial, negative binomial, gamma, etc), we will try to provide an explanation here of what they mean using abundance data. But the same rationale will apply to all families.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>n.sites <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.sites)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">exp</span>(b0 <span class="sc">+</span> b1<span class="sc">*</span>X)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>Abundance <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n.sites,Y)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Abundance <span class="sc">~</span> X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>This Poisson model has the following form. Note that multiple predictors can be considered. Here, for simplicity, we considered one predictor. Again, in many ecological simulations, this single predictor is considered an “environmental gradient” containing many environmental predictors. We can consider more gradients and we will discuss that later on in the workshop.</p>
<p><span class="math display">\[Y={e^{(\beta_0+\beta_1X_1)}}=e^{(0.05+1.2X_1)}=log(Y)=0.05+1.2X_1\]</span> The model can be estimated as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Abundance <span class="sc">~</span> X, <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)           X 
 0.03095719  2.02323099 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model<span class="sc">$</span>fitted.values <span class="sc">~</span> Abundance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>GLMs are linear models because they use link-functions to map non-linear relationships to a linear one. In this way, the link function connects the predictors in a model with the expected (mean) value of the response variable (dependent variable). In other words, the link-functions transforms the response values into new values that can be then regressed using linear approaches (Maximum Likelihood-based approaches and not simple OLS, ordinary least square approaches as in linear regression) against the X values. As we saw in the first example of the Poisson regression above, the relationship is not linear. The link-function for the Poisson distribution is <code>ln</code> of the response. Let’s understand this point by plotting the log(Y) and X. Note that Y has no error and Abundance has error (i.e., based on the <code>rpois</code>, i.e., poisson trials)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># without error:</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(Y) <span class="sc">~</span> X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with error</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(Abundance) <span class="sc">~</span> X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-50-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>What does the passage “the link-function connects the predictors in a model with the expected (mean) value of the response variable (dependent variable)” mean? As you can notice, we used Poisson trials to generate error around the initial Y values. Let’s create a 100 possible trials:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>mult.Y <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="at">n=</span><span class="dv">100</span>,<span class="at">expr=</span><span class="fu">rpois</span>(n.sites,Y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>View(mult.Y)</code></pre>
<p>Each column in <code>mult.Y</code> contains one single trial. This would mimic, for instance, your error in estimating abundances when sampling real populations and assuming that a Poisson GLM would model your abundances across sites well. As such, in real data, obviously, we only have one “trial”. But this small demonstration hopefully helps you understand what the GLM is trying to estimate via the link-function.</p>
<p>Let’s repeat the predictor <code>X</code> 100 times`so that it becomes compatible in size with the multiple trials; and we can then plot them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>rep.X <span class="ot">&lt;-</span> <span class="fu">rep</span>(X, <span class="at">times =</span> <span class="dv">100</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.vector</span>(mult.Y) <span class="sc">~</span> rep.X,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">cex=</span><span class="fl">0.5</span>,<span class="at">col=</span><span class="st">"firebrick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Note that larger values of abundances tend to have more error under the poisson model (which is also ecologically plausible).</p>
<p>Now we can understand what the passage “the link-function connects the predictors in a model with the expected (mean) value of the response”. Let’s first increase the number of trials to 10000 and for each site (for which we have an X value), calculate its mean:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>mult.Y <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="at">n=</span><span class="dv">10000</span>,<span class="at">expr=</span><span class="fu">rpois</span>(n.sites,Y))</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>mean.mult.Y <span class="ot">&lt;-</span> <span class="fu">apply</span>(mult.Y,<span class="dv">1</span>,mean)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mean.mult.Y <span class="sc">~</span> Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>As we can observe, the mean across all trials (errors) equal the response variable Y, i.e., without error. Hopefully this provides a general understanding of what link functions are. A similar explanation can be given for the logistic regression (i.e., binomial error). In there we use a <code>logit</code> link function (transformation) instead.</p>
<p><span style="color:firebrick">Missing predictors in GLMs as a source of error</span></p>
<p>Obviously the fit is great, particularly because we considered all the important predictors in the model. We don’t usually have all predictors in a model and this can be simulated as well. Considering the following example where two environmental predictors were used to generate the abundance data but only was used in the regression model:</p>
<p><span class="math display">\[p={e^{(\beta_0+\beta_1X_1+\beta_1X_2)}}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>n.sites <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n.sites<span class="sc">*</span><span class="dv">2</span>),n.sites,<span class="dv">2</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">&lt;-</span> <span class="fl">1.2</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">exp</span>(b0 <span class="sc">+</span> b1<span class="sc">*</span>X[,<span class="dv">1</span>] <span class="sc">+</span> b1<span class="sc">*</span>X[,<span class="dv">2</span>]) <span class="co"># there are more direct matricial ways to do that</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>Abundance <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n.sites,Y)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Abundance <span class="sc">~</span> X[,<span class="dv">1</span>], <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = Abundance ~ X[, 1], family = "poisson")

Coefficients:
(Intercept)       X[, 1]  
     2.0472       0.5294  

Degrees of Freedom: 99 Total (i.e. Null);  98 Residual
Null Deviance:      532.1 
Residual Deviance: 258.8    AIC: 637.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model<span class="sc">$</span>fitted.values <span class="sc">~</span> Abundance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 637.7152</code></pre>
</div>
</div>
<p>Note that the errors around predicted and true values are much greater because only one predictor was included in the GLM even though two predictors were important. Now considering both predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Abundance <span class="sc">~</span> X, <span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = Abundance ~ X, family = "poisson")

Coefficients:
(Intercept)           X1           X2  
     1.9808       0.5300       0.4931  

Degrees of Freedom: 99 Total (i.e. Null);  97 Residual
Null Deviance:      532.1 
Residual Deviance: 119  AIC: 500</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model<span class="sc">$</span>fitted.values <span class="sc">~</span> Abundance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 500.0011</code></pre>
</div>
</div>
<p>This is a critical empirical (ecological) consideration because we can’t measure everything. The error is much smaller and, as a consequence, the model fit is much improved (i.e., smaller AIC values) because it considers the two predictors. It can’t be perfect because of the error related to the poisson trials that will always result in random variation (residual variation).</p>
<p><span style="color:firebrick">A more realistic Gaussian Poisson model</span></p>
<p>As for the logistic model, we can also consider a more realistic Poisson model based on a Gaussian distribution:</p>
<p><span class="math display">\[Y={h\cdot e^{-(\beta_0+\beta_1\frac{(X-\mu)^2}{2\sigma^2})}}\]</span> As before, <span class="math inline">\(\mu\)</span> represents the species optimum and <span class="math inline">\(\sigma\)</span> its niche breadth. <span class="math inline">\(h\)</span> represents the expected abundance in the optimum environmental value. Using code to simulate this model for one species; for simplicity, we will set <span class="math inline">\(\beta_0=0\)</span> and <span class="math inline">\(\beta_1=1\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">110</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.sites)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>optimum <span class="ot">&lt;-</span> <span class="fl">1.2</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>niche.breadth <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">104</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> h <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>(X<span class="sc">-</span>optimum)<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>niche.breadth<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>Abundance <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n.sites,Y)</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Abundance<span class="sc">~</span>X)</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fl">1.2</span>,<span class="at">col=</span><span class="st">"firebrick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Let’s fit the Poisson model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>predictor <span class="ot">&lt;-</span> <span class="fu">cbind</span>(X,X<span class="sc">^</span><span class="dv">2</span>) </span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Abundance <span class="sc">~</span> predictor,<span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model<span class="sc">$</span>fitted <span class="sc">~</span> X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>coeffs <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, parameters used to simulate the species distribution can be estimated as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> coeffs[<span class="dv">1</span>]</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> coeffs[<span class="dv">2</span>]</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">&lt;-</span> coeffs[<span class="dv">3</span>]</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>estimated.optimum <span class="ot">&lt;-</span> <span class="sc">-</span>b1<span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>b2) </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>estimated.niche.breadth <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>b2)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">exp</span>(b0 <span class="sc">+</span> b1<span class="sc">*</span>estimated.optimum <span class="sc">+</span> b2<span class="sc">*</span>estimated.optimum<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(estimated.optimum,estimated.niche.breadth,h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           estimated.optimum estimated.niche.breadth        h
predictorX          1.179753               0.4726181 104.8035</code></pre>
</div>
</div>
<p>Now we can generalize the code to generate abundance data for multiple species:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>generate_community_abundance <span class="ot">&lt;-</span> <span class="cf">function</span>(tolerance,E,T,preset_nspecies,preset_ncommunities){</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># one trait, one environmental variable</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>        h <span class="ot">&lt;-</span> <span class="fu">runif</span>(preset_nspecies,<span class="at">min=</span><span class="fl">0.3</span>,<span class="at">max=</span><span class="dv">1</span>)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>        sigma <span class="ot">&lt;-</span> <span class="fu">runif</span>(preset_nspecies)<span class="sc">*</span>tolerance</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>        L <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="dv">0</span>,<span class="at">nrow=</span>preset_ncommunities,<span class="at">ncol=</span>preset_nspecies)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>preset_nspecies){</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>            L[,j] <span class="ot">&lt;-</span> <span class="dv">30</span><span class="sc">*</span>h[j]<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>(E<span class="sc">-</span>T[j])<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span>(<span class="dv">2</span><span class="sc">*</span>sigma[j]<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>              <span class="co">#rpois(preset_ncommunities,30*h[j]*exp(-(E-T[j])^2/(2*sigma[j]^2)))</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>        n_species_c <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">colSums</span>(L)<span class="sc">!=</span><span class="dv">0</span>) <span class="co"># _c for check</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>        n_communities_c <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">rowSums</span>(L)<span class="sc">!=</span><span class="dv">0</span>)</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ((n_species_c <span class="sc">==</span> preset_nspecies) <span class="sc">&amp;</span> (n_communities_c<span class="sc">==</span>preset_ncommunities)){<span class="cf">break</span>}</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(L)</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">120</span>) <span class="co"># so that we all have the same results</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.communities)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n.species)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">generate_community_abundance</span>(<span class="at">tolerance =</span> <span class="fl">1.5</span>, E, T, n.species, n.communities)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the expected abundance values across environmental values. To do that nicely, we need to order the communities according to their environmental values as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>E.sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(E, <span class="at">index.return=</span><span class="cn">TRUE</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>Y.sorted <span class="ot">&lt;-</span> Y[E.sorted<span class="sc">$</span>ix,]</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>E.sorted <span class="ot">&lt;-</span> E.sorted<span class="sc">$</span>x</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(E.sorted, Y.sorted, <span class="at">cex.lab=</span><span class="fl">1.5</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Enviroment"</span>, <span class="at">ylab =</span> <span class="st">"Abundance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Y, however, has no error and to create abundance values for each species (i.e., each column of Y; MARGIN = 2) according to a poisson model we can simply:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>Abundances <span class="ot">&lt;-</span> <span class="fu">apply</span>(Y,<span class="at">MARGIN=</span><span class="dv">2</span>,<span class="cf">function</span>(x) <span class="fu">rpois</span>(n.communities,x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s plot the abundance values across environmental values. With erorr, they don’t look as nice, obviously:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>E.sorted <span class="ot">&lt;-</span> <span class="fu">sort</span>(E, <span class="at">index.return=</span><span class="cn">TRUE</span>)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>Abundances.sorted <span class="ot">&lt;-</span> Abundances[E.sorted<span class="sc">$</span>ix,]</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>E.sorted <span class="ot">&lt;-</span> E.sorted<span class="sc">$</span>x</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="fu">matplot</span>(E.sorted, Abundances.sorted, <span class="at">cex.lab=</span><span class="fl">1.5</span>,<span class="at">cex.axis=</span><span class="dv">2</span>,<span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">xlab =</span> <span class="st">"Enviroment"</span>, <span class="at">ylab =</span> <span class="st">"Abundance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Finally, let’s calculate the 4th corner statistics for these data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">TraitEnvCor</span>(Abundances,E,T, <span class="at">Chessel =</span> <span class="cn">TRUE</span>)[<span class="st">"Fourthcorner"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fourthcorner 
   0.5365449 </code></pre>
</div>
</div>
<p>And now for the data without error, i.e., before the poisson trials:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">TraitEnvCor</span>(Y,E,T, <span class="at">Chessel =</span> <span class="cn">TRUE</span>)[<span class="st">"Fourthcorner"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fourthcorner 
   0.5333836 </code></pre>
</div>
</div>
<p>Despite the error we observed once we transformed Y (values without error) into abundances (with error via the poisson trials), the bivariate correlations are pretty similar, indicating that these metrics are robust against sampling error in abundances. Note, however, that we only used one predictor which was the one used to simulate the data to begin with; empirical data are much more complex than that.</p>
<p>Finally, note that, as such, bivariate correlations are calculated in the same way regardless if the data are presence-absence or abundance; biomass data could be also considered.</p>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Moving to more complex GLMs - the bilinear model</strong></span>
</div>
<p>Let’s go back to our stacked model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bilinear.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
</div>
</div>
<p>And now let’s get back to our stacked approach using again the simplest example we used earlier. Let’s enter the data again to make sure that we have the same data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>Distribution <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>),<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)))</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">8</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">12</span>,<span class="dv">100</span>,<span class="dv">112</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="fu">ncol</span>(Distribution)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>n.sites <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Distribution)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>Dist.stacked <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(Distribution)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>E.stacked <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, n.species) <span class="sc">%x%</span> <span class="fu">scale</span>(E)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>T.stacked <span class="ot">&lt;-</span> <span class="fu">scale</span>(T) <span class="sc">%x%</span> <span class="fu">rep</span>(<span class="dv">1</span>, n.sites)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are two ways in which we can code the analysis. Using the stacked way or using a kronecker product. The kronecker product stacks the data in the same way but it’s a bit more “cryptic” and demonstrating the stacking is then easier by using simple coding. The stacked GLM below estimates the statistical interaction between Environment and Traits only. Note that the distribution for our ficitional example above is for presence and absences, hence we will use a binomial link-function (i.e., logistic regression). This can be referred as to the bilinear model by Gabriel (1998) which is rarely used in ecology but can provide a good introduction to what “stacking” means which is critical to understand more complex GLMs.</p>
<p>Using the stacked vectors above, we have:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a> predictor <span class="ot">&lt;-</span> E.stacked <span class="sc">*</span> T.stacked</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a> model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Dist.stacked <span class="sc">~</span> predictor,<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>logit))</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Dist.stacked ~ predictor, family = binomial(link = logit))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.1282  -0.5101  -0.2570   0.7417   1.3162  

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)  
(Intercept)  -0.9160     0.7681  -1.193   0.2330  
predictor     2.4991     1.1975   2.087   0.0369 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 21.170  on 15  degrees of freedom
Residual deviance: 13.597  on 14  degrees of freedom
AIC: 17.597

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>The stacking we saw can be easily done using matrix algebra (the early presentation is helpful to understand the principles though). To do it in algebra, we use the kronecker product as follows:</p>
<p><span class="math display">\[Y= T\otimes E\]</span></p>
<p>As such, the bilinear model is testing the statistical interaction between traits and environmental variables.</p>
<p>which in R becomes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>predictor2 <span class="ot">&lt;-</span> T <span class="sc">%x%</span> E</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm</span>(Dist.stacked <span class="sc">~</span> predictor,<span class="at">family=</span><span class="fu">binomial</span>(<span class="at">link=</span>logit))</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = Dist.stacked ~ predictor, family = binomial(link = logit))

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-2.1282  -0.5101  -0.2570   0.7417   1.3162  

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)  
(Intercept)  -0.9160     0.7681  -1.193   0.2330  
predictor     2.4991     1.1975   2.087   0.0369 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 21.170  on 15  degrees of freedom
Residual deviance: 13.597  on 14  degrees of freedom
AIC: 17.597

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Note that the two ways to run the model results in the exact same estimates. Here we should interpret the slope for the model as the strength between trait and environment, i.e., <span class="math inline">\(\beta_1 = 2.4991\)</span>. Obviously the bilinear model can be easily extended to any class of GLMs as well depending on the nature of the response variable (e.g., poisson, negative binomial, etc; more on these below).</p>
<p>Note also that we could have considered multiple traits and environments (as long as we have enough degrees of freedom).</p>
<p><span style="color:firebrick">Stacked or bilinear model on the Aravo data set</span></p>
<p>Let’s apply the Aravo data set we saw early here. We will reduce the environmental matrix by removing the qualitative variables. These can be easily accommodated but for the sake of speed, we will reduce it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> aravo<span class="sc">$</span>env[,<span class="fu">c</span>(<span class="st">"Aspect"</span>,<span class="st">"Slope"</span>,<span class="st">"Snow"</span>)]</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(E)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(aravo<span class="sc">$</span>trait)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we apply the kronecker product using the base function <code>kronecker</code> rather than <code>%x%</code> that we saw early. This function generate names for each column of the matrix (i.e., interactions between each trait and predictor). The columns contain all possible two by two (pairwise) combinations of traits and environmental features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>TE <span class="ot">&lt;-</span> <span class="fu">kronecker</span>(T, E, <span class="at">make.dimnames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(TE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6150   24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(TE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Height:Aspect" "Height:Slope"  "Height:Snow"   "Spread:Aspect"
 [5] "Spread:Slope"  "Spread:Snow"   "Angle:Aspect"  "Angle:Slope"  
 [9] "Angle:Snow"    "Area:Aspect"   "Area:Slope"    "Area:Snow"    
[13] "Thick:Aspect"  "Thick:Slope"   "Thick:Snow"    "SLA:Aspect"   
[17] "SLA:Slope"     "SLA:Snow"      "N_mass:Aspect" "N_mass:Slope" 
[21] "N_mass:Snow"   "Seed:Aspect"   "Seed:Slope"    "Seed:Snow"    </code></pre>
</div>
</div>
<p>Because we have abundance data, let’s run the GLM using the poisson model (log link function) and the negative binomial which may work better when data are overdispersed (e.g., too many zeros, i.e., absences).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>Dist.stacked <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">as.matrix</span>(aravo<span class="sc">$</span>spe))</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>ColNames <span class="ot">&lt;-</span> <span class="fu">colnames</span>(TE)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>TE <span class="ot">&lt;-</span> <span class="fu">scale</span>(TE) <span class="co"># so that slopes can be compared directly to one another</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(TE) <span class="ot">&lt;-</span> ColNames</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>model.bilinear.poisson <span class="ot">&lt;-</span> <span class="fu">glm</span>(Dist.stacked <span class="sc">~</span> TE,<span class="at">family=</span><span class="st">"poisson"</span>)</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>model.bilinear.negBinom <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Dist.stacked  <span class="sc">~</span> TE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s compare the two models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">BIC</span>(model.bilinear.poisson),<span class="fu">BIC</span>(model.bilinear.negBinom))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9310.771 8784.627</code></pre>
</div>
</div>
<p>The BIC suggests that negative binomial fits the data better (smaller BIC, better fit).</p>
<p>Model diagnostics for non-Gaussian models are challenging and often standard tools don’t provide a good way to assess quality of models. Let’s check model residuals using the more classic approach. <code>sppVec</code> below will be used to create a different color for each species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a vector of species names compatible with the stacked model:</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>sppVec <span class="ot">=</span> <span class="fu">rep</span>(<span class="fu">row.names</span>(aravo<span class="sc">$</span>traits),<span class="at">each=</span><span class="fu">nrow</span>(aravo<span class="sc">$</span>spe))</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">residuals</span>(model.bilinear.negBinom),<span class="fu">log</span>(<span class="fu">fitted</span>(model.bilinear.negBinom)),<span class="at">col=</span><span class="fu">as.numeric</span>(<span class="fu">factor</span>(sppVec)),<span class="at">xlab=</span><span class="st">"Fitted values [log scale]"</span>,<span class="at">ylab=</span><span class="st">"residuals"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-74-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>As we can see, the plot is pretty bad; and that’s a common feature for GLMs.</p>
<p>Dunn and Smyth (1996) developed a new class of residuals that allows a much better way to diagnose whether the model fits the data well. The package <code>DHARMa</code> implements the approach. A tutorial for this package and the package features can be found at: &lt;a href = “https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html”https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("DHARMa")</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"DHARMa"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This is DHARMa 0.4.6. For overview type '?DHARMa'. For recent changes, type news(package = 'DHARMa')</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>DunnSmyth.res <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model.bilinear.negBinom, <span class="at">plot =</span> F)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DunnSmyth.res<span class="sc">$</span>scaledResiduals<span class="sc">~</span><span class="fu">log</span>(<span class="fu">fitted</span>(model.bilinear.negBinom)),<span class="at">col=</span><span class="fu">as.numeric</span>(<span class="fu">factor</span>(sppVec)),<span class="at">xlab=</span><span class="st">"Fitted values [log scale]"</span>,<span class="at">ylab=</span><span class="st">"residuals"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>And now the Q-Q plot to assess residual normality:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQQunif</span>(DunnSmyth.res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-76-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Just for illustration, let’s compare it with the Q-Q plot for the poisson model which had smaller support:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>DunnSmyth.res.poisson <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> model.bilinear.poisson, <span class="at">plot =</span> F)</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQQunif</span>(DunnSmyth.res.poisson)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>DHARMa:testOutliers with type = binomial may have inflated Type I error rates for integer-valued distributions. To get a more exact result, it is recommended to re-run testOutliers with type = 'bootstrap'. See ?testOutliers for details</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The poisson model doesn’t fit as well the expected line as the negative binomial model. As such, the negative binomial model fits better also with the assumption of normality.</p>
<p>We can use the package <code>jtools</code> to create model summaries and visualization for GLMs. You can find a good introduction to this package here:</p>
<p><a href="https://cran.r-project.org/web/packages/jtools/vignettes/summ.html">https://cran.r-project.org/web/packages/jtools/vignettes/summ.html</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("jtools")</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("ggstance")</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("broom.mixed")</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(model.bilinear.negBinom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in glm.control(...) : 
  unused argument (family = list("Negative Binomial(0.5278)", "log", function (mu) 
log(mu), function (eta) 
pmax(exp(eta), .Machine$double.eps), function (mu) 
mu + mu^2/.Theta, function (y, mu, wt) 
2 * wt * (y * log(pmax(1, y)/mu) - (y + .Theta) * log((y + .Theta)/(mu + .Theta))), function (y, n, mu, wt, dev) 
{
    term &lt;- (y + .Theta) * log(mu + .Theta) - y * log(mu) + lgamma(y + 1) - .Theta * log(.Theta) + lgamma(.Theta) - lgamma(.Theta + y)
    2 * sum(term * wt)
}, function (eta) 
pmax(exp(eta), .Machine$double.eps), expression({
    if (any(y &lt; 0)) stop("negative values not allowed for the negative binomial family")
    n &lt;- rep(1, nobs)
    mustart &lt;- y + (y == 0)/6
}), function (mu) 
all(mu &gt; 0), function (eta) 
TRUE, function (object, nsim) 
{
    ftd &lt;- fitted(object)
    rnegbin(nsim * length(ftd), ftd, .Theta)
}))</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Something went wrong when calculating the pseudo R-squared. Returning NA
instead.</code></pre>
</div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">6150</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">Dist.stacked</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">Generalized linear model</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Family</td>
<td style="text-align: right;">Negative Binomial(0.5278)</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Link</td>
<td style="text-align: right;">log</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">𝛘²(NA)</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (Cragg-Uhler)</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (McFadden)</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">AIC</td>
<td style="text-align: right;">8609.80</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">BIC</td>
<td style="text-align: right;">8784.63</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">-1.27</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">-40.67</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEHeight:Aspect</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">0.42</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEHeight:Slope</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.56</td>
<td style="text-align: right;">0.12</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEHeight:Snow</td>
<td style="text-align: right;">-0.07</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">-0.69</td>
<td style="text-align: right;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESpread:Aspect</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.56</td>
<td style="text-align: right;">0.58</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TESpread:Slope</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">1.18</td>
<td style="text-align: right;">0.24</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESpread:Snow</td>
<td style="text-align: right;">-0.38</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-3.82</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEAngle:Aspect</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.62</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEAngle:Slope</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">2.99</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEAngle:Snow</td>
<td style="text-align: right;">-0.35</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-3.52</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEArea:Aspect</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.72</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEArea:Slope</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.87</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEArea:Snow</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">-1.90</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEThick:Aspect</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-0.09</td>
<td style="text-align: right;">0.93</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEThick:Slope</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">2.09</td>
<td style="text-align: right;">0.04</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEThick:Snow</td>
<td style="text-align: right;">-0.17</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-1.91</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESLA:Aspect</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">2.43</td>
<td style="text-align: right;">0.02</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TESLA:Slope</td>
<td style="text-align: right;">-0.31</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right;">-2.19</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESLA:Snow</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">-2.81</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEN_mass:Aspect</td>
<td style="text-align: right;">-0.60</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">-3.10</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEN_mass:Slope</td>
<td style="text-align: right;">-0.06</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">-0.38</td>
<td style="text-align: right;">0.70</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEN_mass:Snow</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">4.54</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESeed:Aspect</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">2.80</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TESeed:Slope</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">2.21</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESeed:Snow</td>
<td style="text-align: right;">-0.50</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">-4.39</td>
<td style="text-align: right;">0.00</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> Standard errors: MLE</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
</div>
</div>
<p>The package <code>jtools</code> offers a variety of table and graphical outputs and is worth exploring. Here we will produce a confidence interval plot for each slope. This will take a moment (one minute or less):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_summs</span>(model.bilinear.negBinom, <span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in glm.control(...) : 
  unused argument (family = list("Negative Binomial(0.5278)", "log", function (mu) 
log(mu), function (eta) 
pmax(exp(eta), .Machine$double.eps), function (mu) 
mu + mu^2/.Theta, function (y, mu, wt) 
2 * wt * (y * log(pmax(1, y)/mu) - (y + .Theta) * log((y + .Theta)/(mu + .Theta))), function (y, n, mu, wt, dev) 
{
    term &lt;- (y + .Theta) * log(mu + .Theta) - y * log(mu) + lgamma(y + 1) - .Theta * log(.Theta) + lgamma(.Theta) - lgamma(.Theta + y)
    2 * sum(term * wt)
}, function (eta) 
pmax(exp(eta), .Machine$double.eps), expression({
    if (any(y &lt; 0)) stop("negative values not allowed for the negative binomial family")
    n &lt;- rep(1, nobs)
    mustart &lt;- y + (y == 0)/6
}), function (mu) 
all(mu &gt; 0), function (eta) 
TRUE, function (object, nsim) 
{
    ftd &lt;- fitted(object)
    rnegbin(nsim * length(ftd), ftd, .Theta)
}))</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Something went wrong when calculating the pseudo R-squared. Returning NA
instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 methods overwritten by 'broom':
  method            from  
  tidy.glht         jtools
  tidy.summary.glht jtools</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: broom.mixed</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>One needs to be careful when interpreting these confidence intervals as they were produced parametrically and they may be biased as we discussed in the section on statistical hypothesis testing. Again, this is a strong area of development among quantitative ecologists; but we haven’t yet derived unified views on this issue.</p>
<p>We can also plot the coefficients building:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>cf <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(model.bilinear.negBinom)[<span class="sc">-</span><span class="dv">1</span>] <span class="co"># removes the intercept</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>cfInter <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">t</span>(cf),<span class="at">nrow=</span><span class="fu">ncol</span>(E))</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(cfInter) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(T)</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(cfInter) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(E)</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>cfInter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Height      Spread       Angle        Area        Thick        SLA
Aspect  0.08562528  0.05659044  0.05406318  0.04512061 -0.008000594  0.4512878
Slope   0.08477186  0.06555292  0.20518548  0.01057746  0.101762893 -0.3083102
Snow   -0.07428183 -0.37726596 -0.35230429 -0.23652105 -0.174573655 -0.4210057
            N_mass       Seed
Aspect -0.59525146  0.2977853
Slope  -0.05644061  0.1137532
Snow    0.67458707 -0.5011741</code></pre>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("lattice")</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(cfInter))</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>colort <span class="ot">=</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"blue"</span>,<span class="st">"white"</span>,<span class="st">"red"</span>))</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="fu">levelplot</span>(cfInter, <span class="at">xlab=</span><span class="st">"traits"</span>,<span class="at">ylab=</span><span class="st">"environment"</span>, <span class="at">col.regions=</span><span class="fu">colort</span>(<span class="dv">100</span>), <span class="at">at=</span><span class="fu">seq</span>(<span class="sc">-</span>a, a, <span class="at">length=</span><span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-80-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>Considering main effects of trait and environment, and their interactions - predicting and explaining species distributions</strong></span>
</div>
<p>The bilinear model estimates and test for the interactions between traits and environmental features in a single model. That allows for partial slopes to be estimated (i.e., in which the effects of one trait-environment interaction is independent of the others as in standard linear regression models and GLMs). Understanding partial slopes is essential for inference and usually covered in Intro statistics for biologists/ecologists under multiple regression. A standard definition is “The partial slope in multiple regression (or GLM) is the slope of the relationship between a predictor variable that is independent of the other predictor variables and the criterion. It is also the regression coefficient for the predictor variable in question.” (<a href="https://onlinestatbook.com/2/glossary/partial_slope.html">https://onlinestatbook.com/2/glossary/partial_slope.html</a>).</p>
<p>Now, we may want to consider also the main effects of each environmental feature and traits in addition to their interactions. This is the model implemented in Jamil et al.&nbsp;(2013) and Brown et al.&nbsp;(2014). The Brown model et al.&nbsp;model is:</p>
<p><span class="math display">\[{ln(Y_{ij}) = \beta_0\ +\beta_1env_i\ +\beta_2env_i^2\ +\beta_3spp_j\ +\beta_4(env \times\ trait)_{ij}\ }\]</span> where <span class="math inline">\(\beta_0\)</span> is the overall intercept for the model, <span class="math inline">\(\beta_1env_i\)</span> contains the slopes for each environmental variable, the model also consider square terms for the environmental variables <span class="math inline">\(\beta_2env_i^2\)</span>, <span class="math inline">\(\beta_3spp_j\)</span> contains species-specific intercept terms which allows predictions for each species separately, <span class="math inline">\(\beta_4(env \times\ trait)_{ij}\)</span> contains the slopes for each trait by environment interaction (the 4th corner slopes). Whereas Brown et al.&nbsp;treated <span class="math inline">\(spp_j\)</span> as fixed, Jamil et al.&nbsp;(2013) treated as random (more on this later). I’ve followed the formulation notation given in Brown et al.&nbsp;to facilitate understanding their paper; but we could easily change by the notation used in the mixed model selection (following Gelman and Hill 2007).</p>
<p>By setting species-specific intercept terms (i.e., <span class="math inline">\(\beta_3spp_j\)</span>) we can predict species in their appropriate scale of abundance variation. As such, we can use these types of models to predict species distributions. This sort of modelling is becoming the standard for predicting multiple species because it considers multiple types of predictors (trait, environments, non-linearities) and their interactions. Single species models, for instance, can’t consider trait variation and the interactions of traits and environment. As such, stacked models are extremely powerful tools even for modelling single species distributions.</p>
<p>The Brown et al.&nbsp;model can be fit using the package <code>mvabund</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("mvabund")</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvabund)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>glm.trait.res <span class="ot">&lt;-</span> <span class="fu">traitglm</span>(<span class="fu">as.matrix</span>(aravo<span class="sc">$</span>spe),E,T,<span class="at">family=</span><span class="st">"negative.binomial"</span>,<span class="at">col.intercepts=</span><span class="cn">TRUE</span>)</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(glm.trait.res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       l 
8104.818 </code></pre>
</div>
</div>
<p>All coefficients of the model can be retrieved by:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefficients</span>(glm.trait.res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                         l
(Intercept)   -1.939671753
sppAlch.glau  -0.054831143
sppAlch.pent   0.024330521
sppAlch.vulg  -0.155929316
sppAlop.alpi   0.069840352
sppAndr.brig  -0.144086942
sppAndr.vita  -0.117405506
sppAnte.carp  -0.105193294
sppAnte.dioi  -0.259135963
sppAnth.alpe  -0.404567216
sppAnth.nipp  -0.069393787
sppArni.mont  -0.265964212
sppAste.alpi  -0.324558310
sppAven.vers  -0.108786793
sppBart.alpi  -0.332898371
sppCamp.sche  -0.008108304
sppCard.alpi  -0.136528887
sppCare.foet   0.027908430
sppCare.parv  -0.174556575
sppCare.rosa  -0.091371379
sppCare.rupe  -0.182772040
sppCare.semp  -0.112095430
sppCera.cera  -0.171760014
sppCera.stri  -0.021497460
sppCirs.acau  -0.188888639
sppDrab.aizo  -0.118690070
sppDrya.octo  -0.358279264
sppErig.unif  -0.059293913
sppFest.laev  -0.365739677
sppFest.quad  -0.105113832
sppFest.viol  -0.058339848
sppGent.acau  -0.181050369
sppGent.camp  -0.134520188
sppGent.vern  -0.044346876
sppGeum.mont   0.064963289
sppHeli.sede  -0.217416821
sppHier.pili  -0.138692435
sppHomo.alpi  -0.207003373
sppKobr.myos  -0.028361647
sppLeon.pyre   0.029558348
sppLeuc.alpi  -0.003570705
sppLigu.muto  -0.064014046
sppLloy.sero  -0.284035626
sppLotu.alpi  -0.144194010
sppLuzu.lute  -0.193109208
sppMinu.sedo   0.021602219
sppMinu.vern  -0.137286811
sppMyos.alpe  -0.092884602
sppOmal.supi   0.033812911
sppOxyt.camp  -0.233480701
sppOxyt.lapp  -0.201732614
sppPhyt.orbi  -0.327727501
sppPlan.alpi   0.066971460
sppPoa.alpi    0.095801892
sppPoa.supi   -0.203286074
sppPoly.vivi  -0.016324658
sppPote.aure   0.053779431
sppPote.cran  -0.126165407
sppPote.gran  -0.231501706
sppPuls.vern  -0.096096734
sppRanu.kuep  -0.020389979
sppSagi.glab  -0.011366535
sppSali.herb   0.053863437
sppSali.reti  -0.286340876
sppSali.retu  -0.255645078
sppSali.serp  -0.283448058
sppSaxi.pani  -0.185168997
sppScab.luci  -0.331712183
sppSedu.alpe  -0.065750719
sppSemp.mont  -0.074418068
sppSene.inca  -0.162375900
sppSesl.caer  -0.205203677
sppSibb.proc   0.019139245
sppSile.acau  -0.179836450
sppTara.alpi  -0.250167730
sppThym.poly  -0.280189375
sppTrif.alpi  -0.134717635
sppTrif.badi  -0.322563479
sppTrif.thal  -0.225527793
sppVero.alli  -0.293989557
sppVero.alpi  -0.100779079
sppVero.bell  -0.011889063
Aspect         0.014997588
Slope          0.064347175
Snow          -0.303043451
Aspect.squ     0.013997280
Slope.squ     -0.047627887
Snow.squ      -0.274070121
Aspect.Height -0.010645817
Aspect.Spread -0.070752741
Aspect.Angle  -0.083977548
Aspect.Area   -0.040276747
Aspect.Thick  -0.082064700
Aspect.SLA     0.065782084
Aspect.N_mass -0.138709436
Aspect.Seed    0.042758169
Slope.Height  -0.020464655
Slope.Spread   0.023128427
Slope.Angle   -0.018699260
Slope.Area    -0.027960323
Slope.Thick   -0.012369639
Slope.SLA     -0.108694248
Slope.N_mass   0.021179434
Slope.Seed     0.014142823
Snow.Height   -0.209648151
Snow.Spread    0.049505713
Snow.Angle    -0.188496204
Snow.Area     -0.046298194
Snow.Thick     0.099956790
Snow.SLA       0.309130472
Snow.N_mass    0.317287032
Snow.Seed     -0.169753499</code></pre>
</div>
</div>
<p>The overall intercept <span class="math inline">\(\beta_0=-1.9397\)</span>, the individual intercept for each species <span class="math inline">\(\beta_3spp_j\)</span> are the coefficients above starting with <code>spp</code>; for instance, the individual slope for <code>Alch.glau</code> (1st species in the list) is <span class="math inline">\(\beta_3spp_1=-0.055\)</span>. The slopes for each environmental variable appear under the names we gave. For instance, the slope for aspect is <span class="math inline">\(\beta_1env_aspect=0.015\)</span>. Note that <code>.squ</code> in the coefficients are the slopes for the squared environmental terms; for instance <span class="math inline">\(\beta_2env_{snow}^2=-0.274\)</span>. Finally we have the 4th corner slopes. For instance, <span class="math inline">\(\beta_4(env \times\ trait)_{snow,seed\_mass}=-0.1698\)</span>. Remember that snow here refers to the mean snowmelt date. As such, communities with large seed masses (in average) are found in sites that have early snowmelt dates compared to sites with late snowmelt dates; these sites have communities that tend to have small seed masses in average.</p>
<p>Let’s understand this model by programming it from scratch. That’s really the best way to understand models; and whenever possible I try to demonstrate them from ‘scratch’; not always possible depending on the amount of operations (e.g., mixed models) and our abilities to understand large codes . But this one is simple enough that we can do it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="fu">ncol</span>(aravo<span class="sc">$</span>spe)</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="fu">nrow</span>(aravo<span class="sc">$</span>spe)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>n.env.variables <span class="ot">&lt;-</span> <span class="fu">ncol</span>(E)</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="co"># repeats each trait to make it compatible (vectorized) with the stacked species distributions</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>traitVec <span class="ot">&lt;-</span> T[<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n.species,<span class="at">each=</span>n.communities),]</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="co"># repeats each environmental variable to make it compatible  (vectorized) with the stacked species distributions:</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>envVec <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">t</span>(E),n.species),<span class="at">ncol=</span><span class="fu">NCOL</span>(E),<span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="co"># creates an intercept for each species:</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>species.intercepts <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n.species,<span class="at">each=</span>n.communities)</span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>species.intercepts <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(species.intercepts)</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"~species.intercepts-1"</span>)</span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>species.intercepts <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(mod)[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a><span class="co"># the interaction terms:</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>TE <span class="ot">&lt;-</span> <span class="fu">kronecker</span>(T, E, <span class="at">make.dimnames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a><span class="co"># combining the predictors in a single matrix:</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">cbind</span>(species.intercepts,envVec,envVec<span class="sc">^</span><span class="dv">2</span>,TE)</span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="co"># running the model</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>model.bilinear.negBinom.Brown <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(Dist.stacked  <span class="sc">~</span> preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And as we can see, they are exactly the same model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(glm.trait.res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       l 
8104.818 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(model.bilinear.negBinom.Brown)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8104.818</code></pre>
</div>
</div>
<p>We can easily adapt the graphical and diagnostic outputs for this model as well, but we won’t for simplicity.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(model.bilinear.negBinom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error in glm.control(...) : 
  unused argument (family = list("Negative Binomial(0.5278)", "log", function (mu) 
log(mu), function (eta) 
pmax(exp(eta), .Machine$double.eps), function (mu) 
mu + mu^2/.Theta, function (y, mu, wt) 
2 * wt * (y * log(pmax(1, y)/mu) - (y + .Theta) * log((y + .Theta)/(mu + .Theta))), function (y, n, mu, wt, dev) 
{
    term &lt;- (y + .Theta) * log(mu + .Theta) - y * log(mu) + lgamma(y + 1) - .Theta * log(.Theta) + lgamma(.Theta) - lgamma(.Theta + y)
    2 * sum(term * wt)
}, function (eta) 
pmax(exp(eta), .Machine$double.eps), expression({
    if (any(y &lt; 0)) stop("negative values not allowed for the negative binomial family")
    n &lt;- rep(1, nobs)
    mustart &lt;- y + (y == 0)/6
}), function (mu) 
all(mu &gt; 0), function (eta) 
TRUE, function (object, nsim) 
{
    ftd &lt;- fitted(object)
    rnegbin(nsim * length(ftd), ftd, .Theta)
}))</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Something went wrong when calculating the pseudo R-squared. Returning NA
instead.</code></pre>
</div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">6150</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">Dist.stacked</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">Generalized linear model</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Family</td>
<td style="text-align: right;">Negative Binomial(0.5278)</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Link</td>
<td style="text-align: right;">log</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">𝛘²(NA)</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (Cragg-Uhler)</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (McFadden)</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">AIC</td>
<td style="text-align: right;">8609.80</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">BIC</td>
<td style="text-align: right;">8784.63</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">-1.27</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">-40.67</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEHeight:Aspect</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">0.42</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEHeight:Slope</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.56</td>
<td style="text-align: right;">0.12</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEHeight:Snow</td>
<td style="text-align: right;">-0.07</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">-0.69</td>
<td style="text-align: right;">0.49</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESpread:Aspect</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.56</td>
<td style="text-align: right;">0.58</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TESpread:Slope</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">1.18</td>
<td style="text-align: right;">0.24</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESpread:Snow</td>
<td style="text-align: right;">-0.38</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-3.82</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEAngle:Aspect</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.62</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEAngle:Slope</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">2.99</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEAngle:Snow</td>
<td style="text-align: right;">-0.35</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">-3.52</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEArea:Aspect</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.72</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEArea:Slope</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.87</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEArea:Snow</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">-1.90</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEThick:Aspect</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-0.09</td>
<td style="text-align: right;">0.93</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEThick:Slope</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">2.09</td>
<td style="text-align: right;">0.04</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEThick:Snow</td>
<td style="text-align: right;">-0.17</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-1.91</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESLA:Aspect</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">2.43</td>
<td style="text-align: right;">0.02</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TESLA:Slope</td>
<td style="text-align: right;">-0.31</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right;">-2.19</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESLA:Snow</td>
<td style="text-align: right;">-0.42</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">-2.81</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEN_mass:Aspect</td>
<td style="text-align: right;">-0.60</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">-3.10</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TEN_mass:Slope</td>
<td style="text-align: right;">-0.06</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">-0.38</td>
<td style="text-align: right;">0.70</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TEN_mass:Snow</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">4.54</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESeed:Aspect</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">2.80</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">TESeed:Slope</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">2.21</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">TESeed:Snow</td>
<td style="text-align: right;">-0.50</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">-4.39</td>
<td style="text-align: right;">0.00</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> Standard errors: MLE</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
</div>
</div>
<p>As mentioned earlier, we can get predicted models per species, making stacked models not only a community model but also considering information from multiple sources for single species distributions as well:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>fitted.by.species <span class="ot">&lt;-</span> <span class="fu">matrix</span>(glm.trait.res<span class="sc">$</span>fitted,n.communities,n.species)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predicted abundance values per species are in columns:</p>
<pre><code>View(fitted.by.species)</code></pre>
<hr style="border:1px solid gray">

<div style="text-align:center">
<span style="color:firebrick"><strong>A very brief way to understand mixed models: the Simpson’s paradox </strong></span>
</div>
<p>Species and sites are not likely to differ from one another randomly but rather have some sites more similar to others (or more different). We call this a hierarchical structure. For instance, sites that are more close to one another may have more similar values than sites further way. Or some species may be more similar in abundance than others, and so on.</p>
<p>When using linear models and GLMS, researchers often ignore the hierarchical structure of the data (some sites have more similar or differences in total abundances of species, some species have more similar or differences in their total abundances). As such, standard GLMs can generate biased variance estimates and increase the likelihood of committing type I errors (i.e., rejecting the statistical null hypothesis more often than set by alpha, i.e., significance level).</p>
<p>Although this is very interesting ecologically, it does bring some inferential challenges (parameter estimation and statistical hypothesis testing) when fitting statistical models. GLMM (Generalized Linear Mixed Models) are then used to deal with these issues. This paper by Harrison et al.&nbsp;(2018) provides a great Introduction to GLLMs for ecologists: <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5970551/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5970551/</a>.</p>
<p>One common feature here is that species may differ in the way they are structured by environmental and/or trait variation. This can be well described by the Simpson’s paradox (Simpson 1951), which is defined “as a phenomenon in probability and statistics in which a trend appears in several groups of data but disappears or reverses when the groups are combined.”</p>
<p>Let’s understand this paradox by simulating some data (code not show here) and graphing it. This sort of demonstration has become somewhat common when explaining the utility of mixed model.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-88-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>At first glance, the influence of temperature on abundance is positive if we consider the variation across all data points independent of the sites. However, within species, the influence of the environment is negative. As such, it is obvious that there is variation among species that can’t be explained by temperature alone. As such, we should consider a mixed model with temperature as a fixed factor (measured variable) and species as a random factor. Obviously one question of interest is why do species vary in their effects of temperature. But we don’t have other predictors that could assist in explaining these differences (e.g., physiology). Perhaps considering traits could assist in determining this variation (more on that later).</p>
<p>The data was saved in a matrix called <code>data.Simpson</code>. For simplicity, we will treat these data as normally distributed. The data were generated assuming normality any way; the goal here is just a demonstration.</p>
<p>Let’s analyze these data with a fixed model using a simple regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jtools)</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>lm.mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(abundance <span class="sc">~</span> <span class="fu">scale</span>(temperature),<span class="at">data=</span>data.Simpson)</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(lm.mod,<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">abundance</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">OLS linear regression</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">F(1,98)</td>
<td style="text-align: right;">15.13</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">R²</td>
<td style="text-align: right;">0.13</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Adj. R²</td>
<td style="text-align: right;">0.12</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">t val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">-0.08</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">-0.48</td>
<td style="text-align: right;">0.63</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">`scale(temperature)`</td>
<td style="text-align: right;">0.69</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">3.89</td>
<td style="text-align: right;">0.00</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> Standard errors: OLS; Continuous predictors are mean-centered and scaled by 1 s.d.</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
</div>
</div>
<p>As we can see, the overal influence of temperature is positive and significant, explaining 12% of the variation in abundance as a function of temperature (i.e., <span class="math inline">\(R^2=0.12\)</span>).</p>
<p>Let’s consider now a mixed effect model that we estimate the variation in intercepts but still assume a common slope for all species. This is a common procedure in mixed model effects, i.e., starting with the simplest model. This fixed effect is coded as usually and the random effect is coded as <code>(1|species)</code>, where 1 means the intercepts (common way to code the intercept in statistical models). As such, one intercept per species is estimated. The <code>scale=TRUE</code> in the function <code>summ</code> below reports the analysis with standardized predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("lme4")</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>lm.mod.intercept <span class="ot">&lt;-</span> <span class="fu">lmer</span>(abundance <span class="sc">~</span> temperature <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>species),<span class="at">data=</span>data.Simpson)</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(lm.mod.intercept,<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">abundance</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">Mixed effects linear regression</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">AIC</td>
<td style="text-align: right;">343.74</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">BIC</td>
<td style="text-align: right;">354.16</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (fixed effects)</td>
<td style="text-align: right;">0.30</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (total)</td>
<td style="text-align: right;">0.95</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th colspan="6" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Fixed Effects
</div></th>
</tr>
<tr class="even">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">t val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">d.f.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">-0.08</td>
<td style="text-align: right;">1.88</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">3.94</td>
<td style="text-align: right;">0.97</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">temperature</td>
<td style="text-align: right;">-2.84</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">-8.10</td>
<td style="text-align: right;">97.70</td>
<td style="text-align: right;">0.00</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> p values calculated using Kenward-Roger standard errors and d.f. ; Continuous predictors are mean-centered and scaled by 1 s.d.</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Random Effects
</div></th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Group</th>
<th data-quarto-table-cell-role="th">Parameter</th>
<th data-quarto-table-cell-role="th">Std. Dev.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>species</td>
<td>(Intercept)</td>
<td>4.20</td>
</tr>
<tr class="even">
<td>Residual</td>
<td></td>
<td>1.16</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Grouping Variables
</div></th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Group</th>
<th data-quarto-table-cell-role="th"># groups</th>
<th data-quarto-table-cell-role="th">ICC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>species</td>
<td>5</td>
<td>0.93</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Wow, what a change in the interpretation. By considering variation in intercepts across species, the fixed effect influence of temperature is now negative (as we should expect). Note, however, that we had information on a categorical factor, i.e, species, that could be used to estimate random effects related to variation among them. The variation (standard deviation) of intercepts among species is quite large in contrast to residuals; 4.20 against 1.16, respectively. The explanatory power of variation among intercepts make the <span class="math inline">\(R^2=0.95\)</span> increase dramatically in contrast to the fixed model, demonstrating that the species random effect has a huge effect and ability to improve the model predictive power. We also find the ICC (Intra Class Correlation) which measures how similar the abundance is within groups, i.e., species. The ICC is 0.93, indicating that abundance values are more similar within than among species.<br>
The variation in intercepts can be plotted as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>intercepts <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lm.mod.intercept)<span class="sc">$</span>species[,<span class="st">"(Intercept)"</span>]</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>slopes <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lm.mod.intercept)<span class="sc">$</span>species[,<span class="st">"temperature"</span>]</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(intercepts,slopes)</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>lines[<span class="st">"species"</span>] <span class="ot">&lt;-</span>  <span class="fu">unique</span>(data.Simpson[,<span class="st">"species"</span>])</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>data.Simpson<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm.mod.intercept)</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data=</span>data.Simpson,<span class="fu">aes</span>(<span class="at">x=</span>temperature,<span class="at">y=</span>abundance,<span class="at">color=</span>species),<span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, <span class="at">slope =</span> temperature),<span class="at">size =</span> <span class="fl">1.5</span>,<span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">fixef</span>(lm.mod.intercept)))) <span class="sc">+</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">intercept=</span>intercepts, <span class="at">slope=</span>slopes, <span class="at">color=</span>species)) <span class="sc">+</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a><span class="fu">xlab</span>(<span class="st">"Temperature"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"log(Abundance)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-91-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The black line represents the common model. Since only intercepts were allowed to vary, the species per slope are the same as the fixed model (after controlling for variation across species, which made the overall slope to be negative).<br>
Finally, let’s estimate the random intercept and slope model. Here we estimate variation due to differences in intercepts and slopes across species:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>lm.mod.interceptSlope <span class="ot">&lt;-</span> <span class="fu">lmer</span>(abundance <span class="sc">~</span> temperature <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> temperature<span class="sc">|</span>species),<span class="at">data=</span>data.Simpson)</span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(lm.mod.interceptSlope,<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">abundance</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">Mixed effects linear regression</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">AIC</td>
<td style="text-align: right;">336.10</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">BIC</td>
<td style="text-align: right;">351.73</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (fixed effects)</td>
<td style="text-align: right;">0.31</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (total)</td>
<td style="text-align: right;">0.96</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th colspan="6" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Fixed Effects
</div></th>
</tr>
<tr class="even">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">t val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">d.f.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">1.75</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">0.95</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">temperature</td>
<td style="text-align: right;">-2.91</td>
<td style="text-align: right;">0.84</td>
<td style="text-align: right;">-3.45</td>
<td style="text-align: right;">3.98</td>
<td style="text-align: right;">0.03</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> p values calculated using Kenward-Roger standard errors and d.f. ; Continuous predictors are mean-centered and scaled by 1 s.d.</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Random Effects
</div></th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Group</th>
<th data-quarto-table-cell-role="th">Parameter</th>
<th data-quarto-table-cell-role="th">Std. Dev.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>species</td>
<td>(Intercept)</td>
<td>3.84</td>
</tr>
<tr class="even">
<td>species</td>
<td>temperature</td>
<td>1.73</td>
</tr>
<tr class="odd">
<td>Residual</td>
<td></td>
<td>1.05</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Grouping Variables
</div></th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Group</th>
<th data-quarto-table-cell-role="th"># groups</th>
<th data-quarto-table-cell-role="th">ICC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>species</td>
<td>5</td>
<td>0.93</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The variation (standard deviation) in intercepts across species in much larger (3.84) than slopes (1.73). Is the predictive power between the two models significant? In order words, does a model that estimate independent slopes for each species explain more variation than one that only considers variation in intercepts? We can simply compare the BIC of both models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">BIC</span>(lm.mod),<span class="fu">BIC</span>(lm.mod.intercept),<span class="fu">BIC</span>(lm.mod.interceptSlope))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 408.7963 356.1764 353.7488</code></pre>
</div>
</div>
<p>There is more support for the mixed model that considers variation in intercepts and slopes. One can also estimate the p-value that one model fits better than the other:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lm.mod.intercept,lm.mod.interceptSlope)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>refitting model(s) with ML (instead of REML)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data.Simpson
Models:
lm.mod.intercept: abundance ~ temperature + (1 | species)
lm.mod.interceptSlope: abundance ~ temperature + (1 + temperature | species)
                      npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)
lm.mod.intercept         4 346.41 356.83 -169.21   338.41                     
lm.mod.interceptSlope    6 340.30 355.93 -164.15   328.30 10.114  2   0.006365
                        
lm.mod.intercept        
lm.mod.interceptSlope **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Finally, we can plot the intercept and slope variation. The common fixed effect slope has been now estimated by pooling the variation among species, hence it become negative in contrast to the original fixed effect slope.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>intercepts <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lm.mod.interceptSlope)<span class="sc">$</span>species[,<span class="st">"(Intercept)"</span>]</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>slopes <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(lm.mod.interceptSlope)<span class="sc">$</span>species[,<span class="st">"temperature"</span>]</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(intercepts,slopes)</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>lines[<span class="st">"species"</span>] <span class="ot">&lt;-</span>  <span class="fu">unique</span>(data.Simpson[,<span class="st">"species"</span>])</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>data.Simpson<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm.mod.intercept)</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data=</span>data.Simpson,<span class="fu">aes</span>(<span class="at">x=</span>temperature,<span class="at">y=</span>abundance,<span class="at">color=</span>species),<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, <span class="at">slope =</span> temperature),<span class="at">size =</span> <span class="dv">2</span>,<span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">fixef</span>(lm.mod.interceptSlope)))) <span class="sc">+</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">intercept=</span>intercepts, <span class="at">slope=</span>slopes, <span class="at">color=</span>species),<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a><span class="fu">xlab</span>(<span class="st">"Temperature"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"log(Abundance)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-95-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><span style="color:firebrick">An extreme example pf the Simpson’s paradox</span></p>
<p>Let’s consider (just visually) an even more extreme case. The fixed effect is very strong but the within species effect is almost zero. Hopefully the “Simpson’s” examples here provide a good intuition on the importance of mixed models.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-97-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<div style="text-align:center">
<span style="color:firebrick"><strong>Our first GLMM applied to the fourth corner problem treating species as a random effect - the MLML1 model</strong></span>
</div>
<p>There are different ways that we can account for the potential random effects in community ecology data. Here we will review a few of the latest developments.</p>
<p>MLM stands for multilevel (i.e., hierarchical) models (MLM). The simplest of these models is the one introduced by Pollock et al.&nbsp;(2012) and is often referred in the ecological literature as MLM1 (see Miller et al.&nbsp;2018). The model has the following form (following the notation of Gelman and Hill 2007; as in Miller et al.&nbsp;2018). This is a model that considers species as a random effect while estimating variation in both intercepts and slopes as the last model in the previous session (Simpson’s paradox)</p>
<p><span class="math display">\[{ln(Y_{i}) = \alpha\ +a_{spp[i]}\ +\beta_{12}env_{site[i]}\times trait_{spp[i]} + (\beta_1+c_{spp[i]})env_{site[i]}+e_i}\]</span> <span class="math inline">\(a,c \sim Gaussian(0,\sigma_a^2,\sigma_c^2,\rho_{ac})\)</span> <span class="math inline">\(e \sim Gaussian(0,\sigma_e^2)\)</span></p>
<p>Note that we changed the notation of Brown et al.&nbsp;<span class="math inline">\(ij\)</span> that served as an index for the <span class="math inline">\(i^{th}\)</span> site and <span class="math inline">\(j^{th}\)</span> species to simply one index <span class="math inline">\(i\)</span> since we are using a stacked model anyway, i.e., only rows for <span class="math inline">\(Y_{i}\)</span> and one column (i.e., stacked species distributions). As such, the functions <span class="math inline">\(spp[i]\)</span> and <span class="math inline">\(site[i]\)</span> map row i onto the corresponding species and sites. <span class="math inline">\(\beta_{12}\)</span> contains the slopes for the interactions between environment and trait. The fixed effect <span class="math inline">\(\alpha\)</span> gives the overall average abundance of species among sites (one overall intercept), and the fixed effect <span class="math inline">\(\beta_{1}\)</span> gives the mean response of species to the different environmental variables. Random effect <span class="math inline">\(a_{spp[i]}\)</span> allows different species to have different overall abundance (i.e., sum of abundances across species; random intercept model across species), and random effect <span class="math inline">\(c_{spp[i]}\)</span> allows different species to have different responses to the environmental variables (i.e., random slope model across species). <span class="math inline">\(a_{spp[i]}\)</span> and <span class="math inline">\(c_{spp[i]}\)</span> have means zero and variances <span class="math inline">\(\sigma_a^2\)</span> and <span class="math inline">\(\sigma_c^2\)</span> (referred as to hyperparameters in mixed model lingo), with <span class="math inline">\(\rho_{ac}\)</span> denoting the correlation between <span class="math inline">\(a_{spp[i]}\)</span> and <span class="math inline">\(c_{spp[i]}\)</span> (i.e., species intercepts and species slopes for the environment can correlate). Finally,random effect <span class="math inline">\(e_i\)</span> gives observation-level variance; this is necessary here to allow for overdispersion (Harisson, 2014). We can also use the negative binomial as we saw earlier. Note that we are assuming hierarchical variation in variance and not covariance (e.g., phylogenetic and spatial autocorrelation). One step at the time.</p>
<p>Let’s start by setting an appropriate data structure to run the mixed model. To make the coding more manageable we will consider here only one trait and one environment. The code can be easily generalized for multiple traits and environments. We found early a strong interaction between seed mass and snow in which species with greater seed mass tended to be found in sites with small levels of snow (i.e., a negative correlation between snow and seed mass).</p>
<p>For simplicity, let’s load the <code>aravo</code> data again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ade4)</span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(aravo)</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> aravo<span class="sc">$</span>env[,<span class="fu">c</span>(<span class="st">"Aspect"</span>,<span class="st">"Slope"</span>,<span class="st">"Snow"</span>)]</span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(E)</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(aravo<span class="sc">$</span>trait)</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>Dist.stacked <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">as.matrix</span>(aravo<span class="sc">$</span>spe))</span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>n.species <span class="ot">&lt;-</span> <span class="fu">ncol</span>(aravo<span class="sc">$</span>spe)</span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>n.communities <span class="ot">&lt;-</span> <span class="fu">nrow</span>(aravo<span class="sc">$</span>spe)</span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>n.env.variables <span class="ot">&lt;-</span> <span class="fu">ncol</span>(E)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to code for observation-level variance:</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>(n.species<span class="sc">*</span>n.communities)</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a><span class="co"># to code for species (as we saw earlier to plot residuals):</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">row.names</span>(aravo<span class="sc">$</span>traits),<span class="at">each=</span><span class="fu">nrow</span>(aravo<span class="sc">$</span>spe))</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>sites <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">row.names</span>(aravo<span class="sc">$</span>spe),<span class="at">each=</span><span class="fu">ncol</span>(aravo<span class="sc">$</span>spe))</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="co"># standardizing the data:</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>seed.mass <span class="ot">&lt;-</span> <span class="fu">scale</span>(T[<span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n.species,<span class="at">each=</span>n.communities),<span class="st">"Seed"</span>])</span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>snow.melt.days <span class="ot">&lt;-</span> <span class="fu">scale</span>(<span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">t</span>(E[,<span class="st">"Snow"</span>]),n.species),<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">byrow=</span><span class="cn">TRUE</span>))</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>data.df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">abundance=</span>Dist.stacked,snow.melt.days,seed.mass,species,sites,obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see the data frame:</p>
<pre><code>View(data.df)</code></pre>
<p>Let’s start by fitting a glm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>glm.mod <span class="ot">&lt;-</span> <span class="fu">glm</span>(abundance <span class="sc">~</span> snow.melt.days <span class="sc">+</span> snow.melt.days<span class="sc">:</span>seed.mass,<span class="at">data=</span>data.df, <span class="at">family =</span> <span class="st">"poisson"</span>)</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(glm.mod,<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">6150</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">abundance</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">Generalized linear model</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Family</td>
<td style="text-align: right;">poisson</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Link</td>
<td style="text-align: right;">log</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">𝛘²(2)</td>
<td style="text-align: right;">56.18</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (Cragg-Uhler)</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (McFadden)</td>
<td style="text-align: right;">0.01</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">AIC</td>
<td style="text-align: right;">9421.91</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">BIC</td>
<td style="text-align: right;">9442.08</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">-1.17</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">-50.74</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">snow.melt.days</td>
<td style="text-align: right;">-0.10</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">-4.20</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">snow.melt.days:seed.mass</td>
<td style="text-align: right;">-0.14</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">-6.39</td>
<td style="text-align: right;">0.00</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> Standard errors: MLE; Continuous predictors are mean-centered and scaled by 1 s.d.</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
</div>
</div>
<p>Despite the very low <span class="math inline">\(R^2=0.01\)</span>, the coefficiences are all significant and negative.</p>
<p>Let’s run the model. Below, both intercepts (coded as 1) and slopes for snow.melt.days (coded as env) are allowed to vary among species (i.e., (1 + env|species)) and we also allow</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>MLM1.mod <span class="ot">&lt;-</span> <span class="fu">glmer</span>(abundance <span class="sc">~</span> snow.melt.days <span class="sc">+</span> snow.melt.days<span class="sc">:</span>seed.mass <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> snow.melt.days<span class="sc">|</span>species) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> obs), <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">control=</span><span class="fu">glmerControl</span>(<span class="at">calc.derivs=</span>F), <span class="at">nAGQ =</span> <span class="dv">0</span>, <span class="at">data=</span>data.df)</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summ</span>(MLM1.mod,<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Observations</td>
<td style="text-align: right;">6150</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Dependent variable</td>
<td style="text-align: right;">abundance</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Type</td>
<td style="text-align: right;">Mixed effects generalized linear model</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Family</td>
<td style="text-align: right;">poisson</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Link</td>
<td style="text-align: right;">log</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">AIC</td>
<td style="text-align: right;">7335.48</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">BIC</td>
<td style="text-align: right;">7382.55</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (fixed effects)</td>
<td style="text-align: right;">0.09</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">Pseudo-R² (total)</td>
<td style="text-align: right;">0.65</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th colspan="5" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Fixed Effects
</div></th>
</tr>
<tr class="even">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Est.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">S.E.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z val.</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">(Intercept)</td>
<td style="text-align: right;">-2.12</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">-12.37</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: left; font-weight: bold;">snow.melt.days</td>
<td style="text-align: right;">-0.72</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">-5.51</td>
<td style="text-align: right;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: left; font-weight: bold;">snow.melt.days:seed.mass</td>
<td style="text-align: right;">-0.08</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">-0.84</td>
<td style="text-align: right;">0.40</td>
</tr>
</tbody><tfoot>
<tr class="odd">
<td style="text-align: left; padding: 0;"><sup></sup> ; Continuous predictors are mean-centered and scaled by 1 s.d.</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tfoot>

</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Random Effects
</div></th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Group</th>
<th data-quarto-table-cell-role="th">Parameter</th>
<th data-quarto-table-cell-role="th">Std. Dev.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>(Intercept)</td>
<td>0.47</td>
</tr>
<tr class="even">
<td>species</td>
<td>(Intercept)</td>
<td>1.46</td>
</tr>
<tr class="odd">
<td>species</td>
<td>snow.melt.days</td>
<td>1.08</td>
</tr>
</tbody>
</table>
</div>
 
<div class="table-responsive">
<table class="table table-striped table-hover table-condensed caption-top table-sm small" data-quarto-postprocess="true">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th colspan="3" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Grouping Variables
</div></th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Group</th>
<th data-quarto-table-cell-role="th"># groups</th>
<th data-quarto-table-cell-role="th">ICC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>6150</td>
<td>0.07</td>
</tr>
<tr class="even">
<td>species</td>
<td>82</td>
<td>0.63</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The variation among observations (residuals) is not relevant here; we used it to allow for potential overdispersion in abundance (i.e., variance of abundance much greater than the mean). Note that both the intercept and slopes contribute more or less to the same amount of variation (intercept sd=1.46 and slopes = 1.08), indicating that an intercept and slope mixed model is the most appropriate model. We could have fit the two models and tested as before we saw early in the Simpson’s paradox section. Note the huge increase in <span class="math inline">\(R^2=0.65\)</span>, demonstrating that considering a random structure is much better. The coefficient of <code>snow.melt.days</code> remains negative indicating that most species and their variation are negative despite the potential for some species to increase their abundances for large values of snow.melt.days. We will see this below.</p>
<p>The residual against the predicted values provide a good indication that the model is appropriate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DHARMa)</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>DunnSmyth.res <span class="ot">&lt;-</span> <span class="fu">simulateResiduals</span>(<span class="at">fittedModel =</span> MLM1.mod, <span class="at">plot =</span> F)</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DunnSmyth.res<span class="sc">$</span>scaledResiduals<span class="sc">~</span><span class="fu">log</span>(<span class="fu">fitted</span>(MLM1.mod)),<span class="at">col=</span><span class="fu">as.numeric</span>(<span class="fu">factor</span>(species)),<span class="at">xlab=</span><span class="st">"Fitted values [log scale]"</span>,<span class="at">ylab=</span><span class="st">"residuals"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-102-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>And now the Q-Q plot to assess residual normality:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQQunif</span>(DunnSmyth.res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>DHARMa:testOutliers with type = binomial may have inflated Type I error rates for integer-valued distributions. To get a more exact result, it is recommended to re-run testOutliers with type = 'bootstrap'. See ?testOutliers for details</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-103-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Note that the Kolmogorov-Smirnov (KS) provides indication that the residuals cannot be assumed to be normal. That said, the distribution of residuals looks somewhat on the expected. The KS becomes quite significant because of the large number of data points. Finally, GLMs and GLMMs tend to be quite robust even when residuals are not normal.</p>
<p>Intercepts in a poisson model are log of species abundances not explained by the predictors model, i.e., when we set them “manually” to take values of zero. Perhaps some sites are more productive than others and we did not measure trait or environmental variables that could account for the slope and intercept variation variation; but the random effects is telling us that there is something we are potentially missing to explain their variation.</p>
<p>Moreover, the random effect indicates that species slopes for the environment are strongly and positively correlated with the species intercepts (<span class="math inline">\(\rho_{ac}=0.73\)</span>). We can plot the intercepts against slopes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">coefficients</span>(MLM1.mod)<span class="sc">$</span>species[,<span class="st">"(Intercept)"</span>],<span class="fu">coefficients</span>(MLM1.mod)<span class="sc">$</span>species[,<span class="st">"snow.melt.days"</span>],<span class="at">xlab=</span><span class="st">"species intercepts"</span>, <span class="at">ylab=</span><span class="st">"species environmental slopes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-104-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p><span class="math inline">\(\rho_{ac}\)</span> does not appear in summ(MLM1.mod) but can be found in <code>summary(MLM1.mod)</code> intead or calculated directly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(MLM1.mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive
  Gauss-Hermite Quadrature, nAGQ = 0) [glmerMod]
 Family: poisson  ( log )
Formula: abundance ~ snow.melt.days + snow.melt.days:seed.mass + (1 +  
    snow.melt.days | species) + (1 | obs)
   Data: data.df
Control: glmerControl(calc.derivs = F)

     AIC      BIC   logLik deviance df.resid 
  7335.5   7382.6  -3660.7   7321.5     6143 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.6289 -0.4400 -0.2650 -0.0639  7.6016 

Random effects:
 Groups  Name           Variance Std.Dev. Corr
 obs     (Intercept)    0.2221   0.4712       
 species (Intercept)    2.1201   1.4560       
         snow.melt.days 1.1671   1.0803   0.73
Number of obs: 6150, groups:  obs, 6150; species, 82

Fixed effects:
                         Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)              -2.11504    0.17095 -12.372  &lt; 2e-16 ***
snow.melt.days           -0.71798    0.13037  -5.507 3.64e-08 ***
snow.melt.days:seed.mass -0.07552    0.09024  -0.837    0.403    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) snw.m.
snw.mlt.dys 0.730        
snw.mlt.d:. 0.010  0.015 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(<span class="fu">coefficients</span>(MLM1.mod)<span class="sc">$</span>species[,<span class="st">"(Intercept)"</span>],<span class="fu">coefficients</span>(MLM1.mod)<span class="sc">$</span>species[,<span class="st">"snow.melt.days"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7163168</code></pre>
</div>
</div>
<p>Although the fixed-only effect model run earlier (glm.mod) indicated a significant correlation between snowmelt date and seed mass in driving species distributions, this effect is no longer relevant once the random effects are considered:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm.mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = abundance ~ snow.melt.days + snow.melt.days:seed.mass, 
    family = "poisson", data = data.df)

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-1.2804  -0.7946  -0.7868  -0.6822   4.3659  

Coefficients:
                         Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)              -1.16767    0.02301 -50.744  &lt; 2e-16 ***
snow.melt.days           -0.09714    0.02313  -4.199 2.68e-05 ***
snow.melt.days:seed.mass -0.14286    0.02237  -6.387 1.70e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 6552.0  on 6149  degrees of freedom
Residual deviance: 6495.8  on 6147  degrees of freedom
AIC: 9421.9

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<p>This indicates that the random variation across species can account for the initial relationship between snow.melt.days and seed mass. Note that the importance of snow.melt.days remains relevant in driving species abundances across sites, but (again) not its interaction with seed mass.</p>
<p>Let’s plot regression models per species:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>intercepts <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(MLM1.mod)<span class="sc">$</span>species[,<span class="st">"(Intercept)"</span>]</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>slopes <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(MLM1.mod)<span class="sc">$</span>species[,<span class="st">"snow.melt.days"</span>]</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>lines <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(intercepts,slopes)</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>lines[<span class="st">"species"</span>] <span class="ot">&lt;-</span>  <span class="fu">unique</span>(data.df[,<span class="st">"species"</span>])</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>data.df<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(MLM1.mod)</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>data.df) <span class="sc">+</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_point</span>(<span class="at">data=</span>data.df,<span class="fu">aes</span>(<span class="at">x=</span>snow.melt.days,<span class="at">y=</span>pred,<span class="at">color=</span>species),<span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>(<span class="at">data =</span> lines, <span class="fu">aes</span>(<span class="at">intercept=</span>intercepts, <span class="at">slope=</span>slopes, <span class="at">color=</span>species),<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, <span class="at">slope =</span> snow.melt.days),<span class="at">size =</span> <span class="dv">2</span>,<span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">fixef</span>(MLM1.mod)))) <span class="sc">+</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a><span class="fu">xlab</span>(<span class="st">"snow.melt.days"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"log(Abundance)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-107-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, the GLMM has good predictive power (relative smaller confidence intervals and large <span class="math inline">\(R^2=0.51\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("ggeffects")</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggeffects)</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ggpredict</span>(MLM1.mod, <span class="st">"snow.melt.days"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-108-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, as we discussed during the workshop, one needs to be careful while interpreting the significance of interactions between trait and environment. There are bootstrap-based developments to do that for the MLML1 model but they have been show to have inflated type I errors (Miller et al.&nbsp;2019).</p>
<p>Function <code>glmer.nb</code> could have been used to fit the model using the negative binomial family instead.</p>
<p>Here is a good and simple introduction to mixed models for poisson regression:<br>
<a href="https://stats.idre.ucla.edu/r/faq/random-coefficient-poisson-models/         ">https://stats.idre.ucla.edu/r/faq/random-coefficient-poisson-models/</a></p>
<div style="text-align:center">
<span style="color:firebrick"><strong>Our second GLMM applied to the fourth corner problem treating species and sites as random effects - the MLML2 model</strong></span>
</div>
<p>Jamil et al.&nbsp;(2013) implemented a mixed model version in which in contrast to MLM1, it adds a fixed effect term for traits is included in the model (as in Brown et al.&nbsp;2014) and also an additional random effect (intercepts) for site:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>MLM2.mod <span class="ot">&lt;-</span> <span class="fu">glmer</span>(abundance <span class="sc">~</span> snow.melt.days <span class="sc">*</span> seed.mass <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> snow.melt.days<span class="sc">|</span>species) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> sites) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> obs), <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">control=</span><span class="fu">glmerControl</span>(<span class="at">calc.derivs=</span>F), <span class="at">nAGQ =</span> <span class="dv">0</span>, <span class="at">data=</span>data.df)</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(MLM2.mod,<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in summary.merMod(MLM2.mod, scale = TRUE): additional arguments ignored</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive
  Gauss-Hermite Quadrature, nAGQ = 0) [glmerMod]
 Family: poisson  ( log )
Formula: abundance ~ snow.melt.days * seed.mass + (1 + snow.melt.days |  
    species) + (1 | sites) + (1 | obs)
   Data: data.df
Control: glmerControl(calc.derivs = F)

     AIC      BIC   logLik deviance df.resid 
  7264.1   7324.6  -3623.0   7246.1     6141 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.5851 -0.4284 -0.2557 -0.0732  8.9436 

Random effects:
 Groups  Name           Variance Std.Dev. Corr
 obs     (Intercept)    0.1472   0.3837       
 species (Intercept)    1.6523   1.2854       
         snow.melt.days 1.0169   1.0084   0.71
 sites   (Intercept)    0.4344   0.6591       
Number of obs: 6150, groups:  obs, 6150; species, 82; sites, 75

Fixed effects:
                         Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)               -2.1239     0.1708 -12.436  &lt; 2e-16 ***
snow.melt.days            -0.6805     0.1228  -5.543 2.97e-08 ***
seed.mass                 -0.2050     0.1634  -1.255    0.210    
snow.melt.days:seed.mass  -0.1134     0.1281  -0.885    0.376    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) snw.m. sd.mss
snw.mlt.dys 0.630               
seed.mass   0.022  0.029        
snw.mlt.d:. 0.023  0.031  0.680 </code></pre>
</div>
</div>
<p>Let’s test the fit difference between MLM1 and MLM2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(MLM1.mod,MLM2.mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data.df
Models:
MLM1.mod: abundance ~ snow.melt.days + snow.melt.days:seed.mass + (1 + snow.melt.days | species) + (1 | obs)
MLM2.mod: abundance ~ snow.melt.days * seed.mass + (1 + snow.melt.days | species) + (1 | sites) + (1 | obs)
         npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)    
MLM1.mod    7 7335.5 7382.6 -3660.7   7321.5                         
MLM2.mod    9 7264.1 7324.6 -3623.0   7246.1 75.406  2  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">BIC</span>(MLM1.mod),<span class="fu">BIC</span>(MLM2.mod))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7382.551 7324.594</code></pre>
</div>
</div>
<p>We won’t diagnostics here for brevity and the code for the MLM1 can be easily adapted here.</p>
<p>Although the fixed effects for the trait (seed mass) and interaction (seed mass and snow.melt.day) were not significant, the random effect standard deviation for site is relative large (0.66) and improved the predictive power for abundances across species.</p>
<div style="text-align:center">
<span style="color:firebrick"><strong>Our last GLMM applied to the fourth corner problem treating species and sites as random effects - the MLML3 model</strong></span>
</div>
<p>ter Braak (2019) proposed yet another version that seems to work better than the previous ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>MLM3.mod <span class="ot">&lt;-</span> <span class="fu">glmer</span>(abundance <span class="sc">~</span> snow.melt.days <span class="sc">*</span> seed.mass <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> snow.melt.days<span class="sc">|</span>species) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> seed.mass<span class="sc">|</span>sites) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> obs), <span class="at">family =</span> <span class="st">"poisson"</span>, <span class="at">control=</span><span class="fu">glmerControl</span>(<span class="at">calc.derivs=</span>F), <span class="at">nAGQ =</span> <span class="dv">0</span>, <span class="at">data=</span>data.df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test the fit difference between MLM2 and MLM3:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(MLM2.mod,MLM3.mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: data.df
Models:
MLM2.mod: abundance ~ snow.melt.days * seed.mass + (1 + snow.melt.days | species) + (1 | sites) + (1 | obs)
MLM3.mod: abundance ~ snow.melt.days * seed.mass + (1 + snow.melt.days | species) + (1 + seed.mass | sites) + (1 | obs)
         npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)
MLM2.mod    9 7264.1 7324.6 -3623.0   7246.1                     
MLM3.mod   11 7267.0 7341.0 -3622.5   7245.0 1.0759  2     0.5839</code></pre>
</div>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">BIC</span>(MLM2.mod),<span class="fu">BIC</span>(MLM3.mod))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7324.594 7340.967</code></pre>
</div>
</div>
<p>For these data, the MLM3 does not improve the MLM2.</p>
<p><span style="font-size:1em;"><strong>This is not the end - we will keep updating this page after the workshop</strong></span><br>
<span style="color:firebrick"><strong>References (still being filled):</strong></span></p>
<p>AM Brown, DI Warton, NR Andrew, M Binns, G Cassis, H Gibb Methods in Ecology and Evolution 5 (4), 344-352</p>
<p>Choler, P. (2005) Consistent shifts in Alpine plant traits along a mesotopographical gradient. Arctic, Antarctic, and Alpine Research, 37,444–453.</p>
<p>Dray, S., &amp; Legendre, P. (2008) Testing the species traits-environment relationships : The fourth-corner problem revisited. Ecology, 89, 3400–3412.</p>
<p>Dunn, KP &amp; Smyth GK (1996) Randomized quantile residuals. Journal of Computational and Graphical Statistics, 5, 1-10.</p>
<p>Gabriel, KR. (1998) Generalised bilinear regression. Biometrika, 85, 689-700.</p>
<p>Gelman, A &amp; Hill, J (2007). Data analysis using regression and multi-level/hierarchical models. New York, NY: Cambridge University Press.</p>
<p>Harrison, XA (2014). Using observation-level random effects to model overdispersion in count data in ecology and evolution. PeerJ, 2, e616.</p>
<p>Jamil, T., Ozinga, W. A., Kleyer, M., &amp; ter Braak, C. J. F. (2013). Selecting traits that explain species-environment relationships: A generalized linear mixed model approach. Journal of Vegetation Science, 24, 988–1000.</p>
<p>Peres-Neto, P. R., Dray, S., &amp; ter Braak, C. J. F. (2017). Linking trait variation to the environment: Critical issues with community-weighted mean correlation resolved by the fourth-corner approach. Ecography, 40, 806–816.</p>
<p>Pollock, L. J., Morris, W. K., &amp; Vesk, P. A. (2012). The role of functional traits in species distributions revealed through a hierarchical model. Ecography, 35, 716–725.</p>
<p>Simpson, EH (1951). The Interpretation of Interaction in Contingency Tables. Journal of the Royal Statistical Society, Series B., 13, 238–241.</p>
<p>ter Braak, CJF, Cormont, A. &amp; Dray, S. (2012). Improved testing of species traits–environment relationships in the fourth‐corner problem. Ecology, 93, 1525-1526.</p>
<p>ter Braak, CJF &amp; Looman, CWN. (1986). Weighted averaging, logistic regression and the Gaussian response model. Plant Ecology, 65, 3-11.</p>
<p><span style="color:firebrick"><strong>useful sites for GLMs (will also expand on this later on):</strong></span></p>
<ul>
<li>Beyond Multiple Linear Regression: <a href="https://bookdown.org/roback/bookdown-BeyondMLR/">https://bookdown.org/roback/bookdown-BeyondMLR/</a></li>
</ul>




<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="listing-actions-group">
</div>
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{peres-neto2021,
  author = {Peres-Neto, Pedro},
  title = {Generalized {Linear} {Models} for {Community} {Ecology}},
  date = {2021-05-17},
  url = {https://bios2.github.io/posts/2021-07-19-glm-community-ecology/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-peres-neto2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Peres-Neto, Pedro. 2021. <span>“Generalized Linear Models for Community
Ecology.”</span> BIOS<sup>2</sup> Education Resources. May 17, 2021. <a href="https://bios2.github.io/posts/2021-07-19-glm-community-ecology/">https://bios2.github.io/posts/2021-07-19-glm-community-ecology/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/bios2\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>