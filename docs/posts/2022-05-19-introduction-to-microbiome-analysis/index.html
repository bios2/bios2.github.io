<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.253">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Steven Kembel">
<meta name="author" content="Zihui Wang">
<meta name="author" content="Salix Dubois">
<meta name="dcterms.date" content="2022-05-19">
<meta name="description" content="This workshop will give an overview of the theory and practice of using metabarcoding approaches to study the diversity of microbial communities. The workshop will give participants an understanding of 1) the current methods for microbiome diversity quantification using metabarcoding/amplicon sequencing approaches and 2) the normalization and diversity analysis approaches that can be used to quantify the diversity of microbial communities.">

<title>BIOS² Education resources - Introduction to Microbiome Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../Bios2_reverse.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">BIOS² Education resources</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-biodiversity-modelling-summer-schools" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Biodiversity Modelling Summer Schools</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-biodiversity-modelling-summer-schools">    
        <li>
    <a class="dropdown-item" href="https://bios2.github.io/biodiversity_modelling_2021/">
 <span class="dropdown-text">Biodiversity Modelling Summer School 2021</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../summer-schools/BiodiversityModelling2022.html">
 <span class="dropdown-text">Biodiversity Modelling Summer School 2022</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://bios2.usherbrooke.ca/">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/bios2/bios2.github.io"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/_bios2"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Introduction to Microbiome Analysis</h1>
                  <div>
        <div class="description">
          <p>This workshop will give an overview of the theory and practice of using metabarcoding approaches to study the diversity of microbial communities. The workshop will give participants an understanding of 1) the current methods for microbiome diversity quantification using metabarcoding/amplicon sequencing approaches and 2) the normalization and diversity analysis approaches that can be used to quantify the diversity of microbial communities.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Technical</div>
                <div class="quarto-category">EN</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading"></div>
    
      <div class="quarto-title-meta-contents">
      Steven Kembel 
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Université du Québec à Montréal
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      Zihui Wang 
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Université du Québec à Montréal
            </p>
        </div>
        <div class="quarto-title-meta-contents">
      Salix Dubois 
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Université du Québec à Montréal
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 19, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#workshop-instructors" id="toc-workshop-instructors" class="nav-link active" data-scroll-target="#workshop-instructors"><span class="toc-section-number">1</span>  Workshop instructors</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="toc-section-number">2</span>  Overview</a></li>
  <li><a href="#workshop-materials" id="toc-workshop-materials" class="nav-link" data-scroll-target="#workshop-materials"><span class="toc-section-number">3</span>  Workshop materials</a>
  <ul class="collapse">
  <li><a href="#day-1---microbiome-quantification-using-amplicon-sequencing-approaches" id="toc-day-1---microbiome-quantification-using-amplicon-sequencing-approaches" class="nav-link" data-scroll-target="#day-1---microbiome-quantification-using-amplicon-sequencing-approaches">Day 1 - Microbiome quantification using amplicon sequencing approaches</a></li>
  <li><a href="#day-2---data-normalization-and-ecological-analysis-of-microbiome-data" id="toc-day-2---data-normalization-and-ecological-analysis-of-microbiome-data" class="nav-link" data-scroll-target="#day-2---data-normalization-and-ecological-analysis-of-microbiome-data">Day 2 - Data normalization and ecological analysis of microbiome data</a></li>
  </ul></li>
  <li><a href="#requirements" id="toc-requirements" class="nav-link" data-scroll-target="#requirements"><span class="toc-section-number">4</span>  Requirements</a></li>
  <li><a href="#microbiome-quantification-using-amplicon-sequencing-approaches" id="toc-microbiome-quantification-using-amplicon-sequencing-approaches" class="nav-link" data-scroll-target="#microbiome-quantification-using-amplicon-sequencing-approaches"><span class="toc-section-number">5</span>  Microbiome quantification using amplicon sequencing approaches</a>
  <ul class="collapse">
  <li><a href="#about-the-data-set" id="toc-about-the-data-set" class="nav-link" data-scroll-target="#about-the-data-set">About the data set</a>
  <ul class="collapse">
  <li><a href="#data-file-setup-and-download" id="toc-data-file-setup-and-download" class="nav-link" data-scroll-target="#data-file-setup-and-download">Data file setup and download</a></li>
  <li><a href="#install-the-dada2-package" id="toc-install-the-dada2-package" class="nav-link" data-scroll-target="#install-the-dada2-package">Install the DADA2 package</a></li>
  </ul></li>
  <li><a href="#sequence-analysis-with-dada2" id="toc-sequence-analysis-with-dada2" class="nav-link" data-scroll-target="#sequence-analysis-with-dada2">Sequence analysis with DADA2</a>
  <ul class="collapse">
  <li><a href="#load-package" id="toc-load-package" class="nav-link" data-scroll-target="#load-package">Load package</a></li>
  <li><a href="#set-file-paths" id="toc-set-file-paths" class="nav-link" data-scroll-target="#set-file-paths">Set file paths</a></li>
  <li><a href="#find-data-files-and-extract-sample-names" id="toc-find-data-files-and-extract-sample-names" class="nav-link" data-scroll-target="#find-data-files-and-extract-sample-names">Find data files and extract sample names</a></li>
  <li><a href="#look-at-sequence-quality-profiles" id="toc-look-at-sequence-quality-profiles" class="nav-link" data-scroll-target="#look-at-sequence-quality-profiles">Look at sequence quality profiles</a></li>
  <li><a href="#trimming-and-quality-control" id="toc-trimming-and-quality-control" class="nav-link" data-scroll-target="#trimming-and-quality-control">Trimming and quality control</a></li>
  <li><a href="#inferring-asvs" id="toc-inferring-asvs" class="nav-link" data-scroll-target="#inferring-asvs">Inferring ASVs</a></li>
  <li><a href="#merge-denoised-forward-and-reverse-reads" id="toc-merge-denoised-forward-and-reverse-reads" class="nav-link" data-scroll-target="#merge-denoised-forward-and-reverse-reads">Merge denoised forward and reverse reads</a></li>
  <li><a href="#construct-sequence-table" id="toc-construct-sequence-table" class="nav-link" data-scroll-target="#construct-sequence-table">Construct sequence table</a></li>
  <li><a href="#remove-chimeras" id="toc-remove-chimeras" class="nav-link" data-scroll-target="#remove-chimeras">Remove chimeras</a></li>
  <li><a href="#tracking-read-fate-through-the-pipeline" id="toc-tracking-read-fate-through-the-pipeline" class="nav-link" data-scroll-target="#tracking-read-fate-through-the-pipeline">Tracking read fate through the pipeline</a></li>
  <li><a href="#taxonomic-annotation" id="toc-taxonomic-annotation" class="nav-link" data-scroll-target="#taxonomic-annotation">Taxonomic annotation</a></li>
  <li><a href="#final-steps---clean-up-and-save-data-objects-and-workspace" id="toc-final-steps---clean-up-and-save-data-objects-and-workspace" class="nav-link" data-scroll-target="#final-steps---clean-up-and-save-data-objects-and-workspace">Final steps - clean up and save data objects and workspace</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#data-normalization-and-ecological-analysis-of-microbiome-data" id="toc-data-normalization-and-ecological-analysis-of-microbiome-data" class="nav-link" data-scroll-target="#data-normalization-and-ecological-analysis-of-microbiome-data"><span class="toc-section-number">6</span>  Data normalization and ecological analysis of microbiome data</a>
  <ul class="collapse">
  <li><a href="#about-the-data-set-1" id="toc-about-the-data-set-1" class="nav-link" data-scroll-target="#about-the-data-set-1">About the data set</a></li>
  <li><a href="#install-and-load-required-packages-and-data" id="toc-install-and-load-required-packages-and-data" class="nav-link" data-scroll-target="#install-and-load-required-packages-and-data">Install and load required packages and data</a>
  <ul class="collapse">
  <li><a href="#load-dada2-results" id="toc-load-dada2-results" class="nav-link" data-scroll-target="#load-dada2-results">Load DADA2 results</a></li>
  <li><a href="#load-metadata" id="toc-load-metadata" class="nav-link" data-scroll-target="#load-metadata">Load metadata</a></li>
  </ul></li>
  <li><a href="#cleaning-and-summarizing-dada2-results" id="toc-cleaning-and-summarizing-dada2-results" class="nav-link" data-scroll-target="#cleaning-and-summarizing-dada2-results">Cleaning and summarizing DADA2 results</a>
  <ul class="collapse">
  <li><a href="#exploring-community-data" id="toc-exploring-community-data" class="nav-link" data-scroll-target="#exploring-community-data">Exploring community data</a></li>
  <li><a href="#subset-community-to-remove-host-dna" id="toc-subset-community-to-remove-host-dna" class="nav-link" data-scroll-target="#subset-community-to-remove-host-dna">Subset community to remove host DNA</a></li>
  <li><a href="#summary-statistics" id="toc-summary-statistics" class="nav-link" data-scroll-target="#summary-statistics">Summary statistics</a></li>
  <li><a href="#remove-negative-controls-and-samples-with-low-quality-data" id="toc-remove-negative-controls-and-samples-with-low-quality-data" class="nav-link" data-scroll-target="#remove-negative-controls-and-samples-with-low-quality-data">Remove negative controls and samples with low-quality data</a></li>
  <li><a href="#subset-community-to-remove-low-sequence-number-samples" id="toc-subset-community-to-remove-low-sequence-number-samples" class="nav-link" data-scroll-target="#subset-community-to-remove-low-sequence-number-samples">Subset community to remove low sequence number samples</a></li>
  </ul></li>
  <li><a href="#data-normalization-for-diversity-analysis" id="toc-data-normalization-for-diversity-analysis" class="nav-link" data-scroll-target="#data-normalization-for-diversity-analysis">Data normalization for diversity analysis</a>
  <ul class="collapse">
  <li><a href="#rarefaction" id="toc-rarefaction" class="nav-link" data-scroll-target="#rarefaction">Rarefaction</a></li>
  </ul></li>
  <li><a href="#community-analysis" id="toc-community-analysis" class="nav-link" data-scroll-target="#community-analysis">Community analysis</a>
  <ul class="collapse">
  <li><a href="#biological-questions" id="toc-biological-questions" class="nav-link" data-scroll-target="#biological-questions">Biological questions</a></li>
  <li><a href="#visualize-taxonomic-composition-of-communities" id="toc-visualize-taxonomic-composition-of-communities" class="nav-link" data-scroll-target="#visualize-taxonomic-composition-of-communities">Visualize taxonomic composition of communities</a></li>
  <li><a href="#community-diversity-alpha-diversity" id="toc-community-diversity-alpha-diversity" class="nav-link" data-scroll-target="#community-diversity-alpha-diversity">Community diversity (alpha diversity)</a></li>
  <li><a href="#community-composition-beta-diversity" id="toc-community-composition-beta-diversity" class="nav-link" data-scroll-target="#community-composition-beta-diversity">Community composition (beta diversity)</a></li>
  <li><a href="#differentially-abundant-taxa" id="toc-differentially-abundant-taxa" class="nav-link" data-scroll-target="#differentially-abundant-taxa">Differentially abundant taxa</a></li>
  <li><a href="#final-steps---clean-up-and-save-data-objects-and-workspace-1" id="toc-final-steps---clean-up-and-save-data-objects-and-workspace-1" class="nav-link" data-scroll-target="#final-steps---clean-up-and-save-data-objects-and-workspace-1">Final steps - clean up and save data objects and workspace</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="workshop-instructors" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Workshop instructors</h1>
<p><a href="https://kembellab.ca/">Dr.&nbsp;Steve Kembel</a>, Zihui Wang, and Salix Dubois</p>
<p><a href="https://uqam.ca/">Université du Québec à Montréal</a></p>
</section>
<section id="overview" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Overview</h1>
<p>This workshop will give an overview of the theory and practice of using amplicon sequencing approaches to study the diversity of microbial communities. In the first part of the workshop, we will discuss current methods for microbiome quantification using amplicon sequencing approaches. In the second part of the workshop, we will discuss normalization and diversity analysis approaches that can be used to quantify the diversity of microbial communities.</p>
<p>This workshop was developed with support from the <a href="https://bios2.usherbrooke.ca/">NSERC CREATE Computational Biodiversity Science and Services (BIOS²)</a> training program and the <a href="https://kembellab.ca/">Canada Research Chair in Plant Microbiomes</a>.</p>
</section>
<section id="workshop-materials" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Workshop materials</h1>
<section id="day-1---microbiome-quantification-using-amplicon-sequencing-approaches" class="level2">
<h2 class="anchored" data-anchor-id="day-1---microbiome-quantification-using-amplicon-sequencing-approaches">Day 1 - Microbiome quantification using amplicon sequencing approaches</h2>
<ul>
<li>Lecture - <a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-analysis-1-sequence-analysis.pdf">Microbiome quantification using amplicon sequencing approaches (PDF)</a></li>
<li>R practical - <a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-sequence-analysis.html">Microbiome sequence analysis workshop</a></li>
<li>Downloads
<ul>
<li><a href="https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077">Sequence data and SILVA database files (~350MB download from figshare)</a></li>
<li>R workspace <a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-sequence-analysis-workspace.RData">Microbiome-sequence-analysis-workspace.RData</a></li>
<li><a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-sequence-analysis.Rmd">R Markdown file</a> used to generate the R practical document</li>
</ul></li>
</ul>
</section>
<section id="day-2---data-normalization-and-ecological-analysis-of-microbiome-data" class="level2">
<h2 class="anchored" data-anchor-id="day-2---data-normalization-and-ecological-analysis-of-microbiome-data">Day 2 - Data normalization and ecological analysis of microbiome data</h2>
<ul>
<li>Lecture - <a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-analysis-2-ecological-analysis.pdf">Data normalization and ecological analysis of microbiome data (PDF)</a></li>
<li>R practical - <a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-ecological-analysis.html">Microbiome ecological analysis workshop</a></li>
<li>Downloads
<ul>
<li>Sample metadata <a href="http://kembellab.ca/microbiome-analysis-workshop/metadata-Qleaf_BACT.csv">metadata-Qleaf_BACT.csv</a></li>
<li>DADA2 ASV sequence table <a href="http://kembellab.ca/microbiome-analysis-workshop/seqtab.nochim.rds">seqtab.nochim.rds</a></li>
<li>DADA2 ASV taxonomic annotations <a href="http://kembellab.ca/microbiome-analysis-workshop/#:~:text=ASV%20taxonomic%20annotations-,taxa.sp.rds,-R%20workspace%20Microbiome">taxa.sp.rds</a></li>
</ul></li>
<li>R workspace <a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-ecological-analysis-workspace.RData">Microbiome-ecological-analysis-workspace.RData</a></li>
<li><a href="http://kembellab.ca/microbiome-analysis-workshop/Microbiome-ecological-analysis.Rmd">R Markdown file</a> used to generate the R practical document</li>
</ul>
</section>
</section>
<section id="requirements" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Requirements</h1>
<p>The workshop assumes basic familiarity with R/RStudio; practical exercises are based on the use of R scripts to analyse sequence data and resulting community data sets.</p>
<p>To be able to follow along with the practical exercises on your own computer, in addition to downloading the data files above, you will need to do the following:</p>
<p>Install the latest version of R for your operating system (version 4.2.0 as of May 2022): <a href="https://cran.r-project.org/">https://cran.r-project.org/</a></p>
<p>Install the latest version of RStudio for your operating system (version 2022.02.2+485 as of May 2022): <a href="https://www.rstudio.com/products/rstudio/download/">https://www.rstudio.com/products/rstudio/download/</a></p>
<p>Install the packages that we will use during the workshop by executing the following code in R version 4.2.0:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install packages from CRAN</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="at">pkgs =</span> <span class="fu">c</span>(<span class="st">"Rcpp"</span>, <span class="st">"RcppArmadillo"</span>, <span class="st">"picante"</span>, <span class="st">"ggpubr"</span>, <span class="st">"pheatmap"</span>), <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install packages from Bioconductor</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"dada2"</span>, <span class="at">version =</span> <span class="st">"3.15"</span>, <span class="at">update =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if the dada2 install returns a warning for BiocParallel, install from binary using this command:</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># BiocManager::install("BiocParallel", version = "3.15", type="binary", update = FALSE)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"DESeq2"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"phyloseq"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"ANCOMBC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="microbiome-quantification-using-amplicon-sequencing-approaches" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Microbiome quantification using amplicon sequencing approaches</h1>
<section id="about-the-data-set" class="level2">
<h2 class="anchored" data-anchor-id="about-the-data-set">About the data set</h2>
<p>In this workshop, we will be analyzing the bacterial communities found on leaves of sugar maple seedlings of different provenances planted at sites across eastern North America.</p>
<p>These data are taken from the article:</p>
<p>De Bellis, Laforest-Lapointe, Solarik, Gravel, and Kembel. 2022. Regional variation drives differences in microbial communities associated with sugar maple across a latitudinal range. Ecology (published online ahead of print). <a href="https://doi.org/10.1002/ecy.3727">doi:10.1002/ecy.3727</a></p>
<p>For this workshop, we will work with a subset of samples from six of the nine sites sampled for the article. These samples are located in three different biomes (temperate, mixed, and boreal forests). At each site, several sugar maple seedlings were planted and harvested, and we collected bacterial DNA from the leaves. Each sample thus represents the bacterial communities on the leaves of a single sugar maple seedling. For each seedling, we have associated metadata on the provenance of the seed, the site where the seed was planted, and the biome/stand type where the seed was planted. We’ll talk more about these samples and the biological hypotheses we want to test in day 2 of the workshop.</p>
<section id="data-file-setup-and-download" class="level3">
<h3 class="anchored" data-anchor-id="data-file-setup-and-download">Data file setup and download</h3>
<p>To follow along with the code, you will need to download the raw data (FASTQ sequence files) and the SILVA taxonomy files, and place a copy of these data sets in the working directory from which you are running the code.</p>
<p>The data files we will use for this workshop are available for download at the following URL: <a href="https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077">https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077</a>.</p>
<p>The sequence data in the folder rawdata-Qleaf_BACT consist of 74 compressed FASTQ files (2 files for each of 36 samples). These files were provided by the <a href="https://www.cermofc.uqam.ca/en/technological-platforms/genomics/">UQAM CERMO-FC Genomics Platform</a> where the samples were sequenced in a multiplexed run on an Illumina MiSeq. The samples were demultiplexed into separate files based on the barcode associated with each sample, so there is a separate pair of files for each sample. One file labelled R2 contains the forward read for the sample, the other file labelled R1 contains the reverse read for the sample.</p>
<p>If your samples were not automatically demultiplexed by the sequencing centre, you will instead have just two files which are normally labelled R2 for forward reads and R1 for reverse reads, and you should also receive information about the sequence barcode associated with each sample. You will need to demultiplex this file yourself by using the unique barcode associated with each sample to split the single large file containing all samples together into a separate file for each sample. It is easier to not have to do this step yourself, so I recommend asking your sequencing centre how they will provide the data and request that the data be provided demultiplexed with separate files for each sample. If you do need to do the multiplexing yourself, there are numerous tools available to carry out demultplexing, including <a href="http://qiime.org/">QIIME</a>, <a href="https://mothur.org/">mothur</a>, or the standalone <a href="https://github.com/yhwu/idemp">idemp</a> program.</p>
<p>After downloading the compressed file “rawdata-Qleaf_BACT.zip” (the file is around 150MB in size), you will need to unzip the file into a folder on your computer. I suggest you place this folder in the working directory from which you are running the code for the workshop.</p>
<p>The SILVA taxonomy reference database files we will use for this workshop are available for download at the same URL where we found the sequence data: <a href="https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077">https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077</a></p>
<p>After downloading the compressed file “SILVA138.1.zip” (the file is around 200MB in size), you will need to unzip the file into a folder on your computer. As for the raw data, I suggest you place this folder in the working directory from which you are running the code for the workshop.</p>
<p>This workshop uses the most recent version of the SILVA taxonomy currently available, which is version 138.1. There are up-to-date DADA2 formatted versions of the SILVA database along with other databases available at the <a href="https://benjjneb.github.io/dada2/training.html">DADA2 website</a>.</p>
</section>
<section id="install-the-dada2-package" class="level3">
<h3 class="anchored" data-anchor-id="install-the-dada2-package">Install the DADA2 package</h3>
<p>You will need to install the most recent version of the DADA2 R package. At the time of writing this workshop, this is DADA2 version 1.24.0. There are instructions for installing the DADA2 package <a href="https://benjjneb.github.io/dada2/dada-installation.html">here</a>. The command below works to install DADA2 version 1.24.0 using R version 4.2.0:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install dada2 if needed</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"dada2"</span>, <span class="at">version =</span> <span class="st">"3.15"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sequence-analysis-with-dada2" class="level2">
<h2 class="anchored" data-anchor-id="sequence-analysis-with-dada2">Sequence analysis with DADA2</h2>
<p>This workshop is based directly on the excellent <a href="https://benjjneb.github.io/dada2/tutorial.html">DADA2 tutorial</a>. I highly recommend following the DADA2 tutorial when working with your own data, it is constantly updated to incorporate the latest version of the analyses available in the package and has helpful tips for analysing your own data. The DADA2 tutorial goes into more depth about each of the steps in this analysis pipeline, and includes useful advice about each step of the pipeline. In this workshop, we have adapted the tutorial materials to run through the basic steps of sequence analysis to go from sequence files to an ecological matrix of ASV abundances in samples, and the taxonomic annotation of those ASVs.</p>
<p>We begin by loading the DADA2 package.</p>
<section id="load-package" class="level3">
<h3 class="anchored" data-anchor-id="load-package">Load package</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load library, check version</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dada2); <span class="fu">packageVersion</span>(<span class="st">"dada2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Rcpp</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] '1.22.0'</code></pre>
</div>
</div>
</section>
<section id="set-file-paths" class="level3">
<h3 class="anchored" data-anchor-id="set-file-paths">Set file paths</h3>
<p>We need to set file paths so DADA2 knows where to find the raw data FASTQ files. I recommend creating a RStudio project for this workshop and placing a copy of the folder with the raw data FASTQ files in the working directory; by default in RStudio the working directory is the folder where you created the project. The exact paths below will need to be changed depending on where you placed the raw data files.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set path to raw data FASTQ files</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># here we assume the raw data are in a folder named "rawdata-Qleaf_BACT"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># in the current working directory (the directory where we created our</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># RStudio project for this workshop, by default)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">"rawdata-Qleaf_BACT/"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># list the files found in the path - this should include 74 files with</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># names like '2017-11-miseq-trimmed_R1.fastq_BC.C2.3X2.fastq.gz"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "2017-11-miseq-trimmed_R1.fastq_AUC.C1.2X1.fastq.gz" 
 [2] "2017-11-miseq-trimmed_R1.fastq_AUC.C1.3.fastq.gz"   
 [3] "2017-11-miseq-trimmed_R1.fastq_AUC.N1.1.fastq.gz"   
 [4] "2017-11-miseq-trimmed_R1.fastq_AUC.N1.3.fastq.gz"   
 [5] "2017-11-miseq-trimmed_R1.fastq_AUC.N2.1.X1.fastq.gz"
 [6] "2017-11-miseq-trimmed_R1.fastq_AUC.N2.1X2.fastq.gz" 
 [7] "2017-11-miseq-trimmed_R1.fastq_AUC.N2.2.fastq.gz"   
 [8] "2017-11-miseq-trimmed_R1.fastq_AUC.S1.1.X2.fastq.gz"
 [9] "2017-11-miseq-trimmed_R1.fastq_AUC.S1X1.fastq.gz"   
[10] "2017-11-miseq-trimmed_R1.fastq_AUC.S2.2.fastq.gz"   
[11] "2017-11-miseq-trimmed_R1.fastq_BC.C1.2.fastq.gz"    
[12] "2017-11-miseq-trimmed_R1.fastq_BC.C2.1X1.fastq.gz"  
[13] "2017-11-miseq-trimmed_R1.fastq_BC.C2.3X2.fastq.gz"  
[14] "2017-11-miseq-trimmed_R1.fastq_BC.C2.3X2b.fastq.gz" 
[15] "2017-11-miseq-trimmed_R1.fastq_BC.N1.3X2.fastq.gz"  
[16] "2017-11-miseq-trimmed_R1.fastq_BC.N1.fastq.gz"      
[17] "2017-11-miseq-trimmed_R1.fastq_BC.N2.1.X3.fastq.gz" 
[18] "2017-11-miseq-trimmed_R1.fastq_BC.N2.1X1.fastq.gz"  
[19] "2017-11-miseq-trimmed_R1.fastq_BC.N2.1X2.fastq.gz"  
[20] "2017-11-miseq-trimmed_R1.fastq_PAR.C1.1.fastq.gz"   
[21] "2017-11-miseq-trimmed_R1.fastq_PAR.C1.2.fastq.gz"   
[22] "2017-11-miseq-trimmed_R1.fastq_PAR.C2.3.fastq.gz"   
[23] "2017-11-miseq-trimmed_R1.fastq_PAR.N1.3.fastq.gz"   
[24] "2017-11-miseq-trimmed_R1.fastq_QLbactNeg19.fastq.gz"
[25] "2017-11-miseq-trimmed_R1.fastq_QLbactNeg20.fastq.gz"
[26] "2017-11-miseq-trimmed_R1.fastq_S.M.C1.3X2.fastq.gz" 
[27] "2017-11-miseq-trimmed_R1.fastq_S.M.C2.3.fastq.gz"   
[28] "2017-11-miseq-trimmed_R1.fastq_S.M.C2.3X2.fastq.gz" 
[29] "2017-11-miseq-trimmed_R1.fastq_S.M.S1.1X1.fastq.gz" 
[30] "2017-11-miseq-trimmed_R1.fastq_SF.C1.3.fastq.gz"    
[31] "2017-11-miseq-trimmed_R1.fastq_SF.C2.2.fastq.gz"    
[32] "2017-11-miseq-trimmed_R1.fastq_SF.N2.3.fastq.gz"    
[33] "2017-11-miseq-trimmed_R1.fastq_SF.S1.3.fastq.gz"    
[34] "2017-11-miseq-trimmed_R1.fastq_T2.C1.1.fastq.gz"    
[35] "2017-11-miseq-trimmed_R1.fastq_T2.C2.3.fastq.gz"    
[36] "2017-11-miseq-trimmed_R1.fastq_T2.N1.1.fastq.gz"    
[37] "2017-11-miseq-trimmed_R1.fastq_T2.S2.1.fastq.gz"    
[38] "2017-11-miseq-trimmed_R2.fastq_AUC.C1.2X1.fastq.gz" 
[39] "2017-11-miseq-trimmed_R2.fastq_AUC.C1.3.fastq.gz"   
[40] "2017-11-miseq-trimmed_R2.fastq_AUC.N1.1.fastq.gz"   
[41] "2017-11-miseq-trimmed_R2.fastq_AUC.N1.3.fastq.gz"   
[42] "2017-11-miseq-trimmed_R2.fastq_AUC.N2.1.X1.fastq.gz"
[43] "2017-11-miseq-trimmed_R2.fastq_AUC.N2.1X2.fastq.gz" 
[44] "2017-11-miseq-trimmed_R2.fastq_AUC.N2.2.fastq.gz"   
[45] "2017-11-miseq-trimmed_R2.fastq_AUC.S1.1.X2.fastq.gz"
[46] "2017-11-miseq-trimmed_R2.fastq_AUC.S1X1.fastq.gz"   
[47] "2017-11-miseq-trimmed_R2.fastq_AUC.S2.2.fastq.gz"   
[48] "2017-11-miseq-trimmed_R2.fastq_BC.C1.2.fastq.gz"    
[49] "2017-11-miseq-trimmed_R2.fastq_BC.C2.1X1.fastq.gz"  
[50] "2017-11-miseq-trimmed_R2.fastq_BC.C2.3X2.fastq.gz"  
[51] "2017-11-miseq-trimmed_R2.fastq_BC.C2.3X2b.fastq.gz" 
[52] "2017-11-miseq-trimmed_R2.fastq_BC.N1.3X2.fastq.gz"  
[53] "2017-11-miseq-trimmed_R2.fastq_BC.N1.fastq.gz"      
[54] "2017-11-miseq-trimmed_R2.fastq_BC.N2.1.X3.fastq.gz" 
[55] "2017-11-miseq-trimmed_R2.fastq_BC.N2.1X1.fastq.gz"  
[56] "2017-11-miseq-trimmed_R2.fastq_BC.N2.1X2.fastq.gz"  
[57] "2017-11-miseq-trimmed_R2.fastq_PAR.C1.1.fastq.gz"   
[58] "2017-11-miseq-trimmed_R2.fastq_PAR.C1.2.fastq.gz"   
[59] "2017-11-miseq-trimmed_R2.fastq_PAR.C2.3.fastq.gz"   
[60] "2017-11-miseq-trimmed_R2.fastq_PAR.N1.3.fastq.gz"   
[61] "2017-11-miseq-trimmed_R2.fastq_QLbactNeg19.fastq.gz"
[62] "2017-11-miseq-trimmed_R2.fastq_QLbactNeg20.fastq.gz"
[63] "2017-11-miseq-trimmed_R2.fastq_S.M.C1.3X2.fastq.gz" 
[64] "2017-11-miseq-trimmed_R2.fastq_S.M.C2.3.fastq.gz"   
[65] "2017-11-miseq-trimmed_R2.fastq_S.M.C2.3X2.fastq.gz" 
[66] "2017-11-miseq-trimmed_R2.fastq_S.M.S1.1X1.fastq.gz" 
[67] "2017-11-miseq-trimmed_R2.fastq_SF.C1.3.fastq.gz"    
[68] "2017-11-miseq-trimmed_R2.fastq_SF.C2.2.fastq.gz"    
[69] "2017-11-miseq-trimmed_R2.fastq_SF.N2.3.fastq.gz"    
[70] "2017-11-miseq-trimmed_R2.fastq_SF.S1.3.fastq.gz"    
[71] "2017-11-miseq-trimmed_R2.fastq_T2.C1.1.fastq.gz"    
[72] "2017-11-miseq-trimmed_R2.fastq_T2.C2.3.fastq.gz"    
[73] "2017-11-miseq-trimmed_R2.fastq_T2.N1.1.fastq.gz"    
[74] "2017-11-miseq-trimmed_R2.fastq_T2.S2.1.fastq.gz"    </code></pre>
</div>
</div>
</section>
<section id="find-data-files-and-extract-sample-names" class="level3">
<h3 class="anchored" data-anchor-id="find-data-files-and-extract-sample-names">Find data files and extract sample names</h3>
<p>Now that we have the list of raw data FASTQ files, we need to process these file names to identify forward and reverse reads. For each sequence, the sequencer will create two files labelled R2 and R1. One of these files contains the forward reads, the other the reverse reads. Which file is which will depend on the protocol used to create sequencing libraries. In our case, the R2 files contain the forward reads, and the R1 files contain the reverse reads.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify forward and reverse reads</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Filenames containing R2 are forward reads, R1 are reverse reads</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>fnFs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path, <span class="at">pattern=</span><span class="st">"R2"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>fnRs <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">list.files</span>(path, <span class="at">pattern=</span><span class="st">"R1"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also need to process the filenames to extract and clean up the sample names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FASTQ filenames have format:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># BLABLA_R1.fastq_SAMPLENAME.fastq.gz</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract sample names from filenames</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Split filename at "_" character, the sample name is in the third chunk</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>sample.names <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">strsplit</span>(<span class="fu">basename</span>(fnFs), <span class="st">"_"</span>), <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">3</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove extra text from the end of filenames</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>sample.names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">".fastq.gz"</span>, <span class="st">""</span>, sample.names)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at sample names after processing</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>sample.names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "AUC.C1.2X1"  "AUC.C1.3"    "AUC.N1.1"    "AUC.N1.3"    "AUC.N2.1.X1"
 [6] "AUC.N2.1X2"  "AUC.N2.2"    "AUC.S1.1.X2" "AUC.S1X1"    "AUC.S2.2"   
[11] "BC.C1.2"     "BC.C2.1X1"   "BC.C2.3X2"   "BC.C2.3X2b"  "BC.N1.3X2"  
[16] "BC.N1"       "BC.N2.1.X3"  "BC.N2.1X1"   "BC.N2.1X2"   "PAR.C1.1"   
[21] "PAR.C1.2"    "PAR.C2.3"    "PAR.N1.3"    "QLbactNeg19" "QLbactNeg20"
[26] "S.M.C1.3X2"  "S.M.C2.3"    "S.M.C2.3X2"  "S.M.S1.1X1"  "SF.C1.3"    
[31] "SF.C2.2"     "SF.N2.3"     "SF.S1.3"     "T2.C1.1"     "T2.C2.3"    
[36] "T2.N1.1"     "T2.S2.1"    </code></pre>
</div>
</div>
<p>We now have the list of filenames for the forward and reverse reads, the list of sample names, and we know the sample name associated with each file.</p>
</section>
<section id="look-at-sequence-quality-profiles" class="level3">
<h3 class="anchored" data-anchor-id="look-at-sequence-quality-profiles">Look at sequence quality profiles</h3>
<p>The first step of working with our raw data is to look at the sequence quality profiles. These raw data FASTQ files were generated by sequencing a multiplexed library using the Illumina MiSeq sequencer. For this study, we used the Illumina V3 2x300nt sequencing chemistry, which sequences the first 300 nucleotides at the start (forward read) and end (reverse read) of each amplicon.</p>
<p>There is a quality score associated with each nucleotide known as the <a href="https://en.wikipedia.org/wiki/Phred_quality_score">Phred quality score</a>. This score indicates how confident we are in the identity of that nucleotide. Normally, the quality score should be above 30 (= 1 in 1000 chance of an incorrect base call) for much of the read, but it will begin to drop towards the end of the read. We want to identify where the quality begins to drop so we can trim out the low quality nucleotides.</p>
<p>We will visualize the forward and reverse read quality scores separately. Here, we begin by looking at the quality profile of forward reads for the first 9 samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot quality profile of forward reads</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnFs[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `&lt;scale&gt;` argument of `guides()` cannot be `FALSE`. Use "none" instead as
of ggplot2 3.3.4.
ℹ The deprecated feature was likely used in the dada2 package.
  Please report the issue at &lt;]8;;https://github.com/benjjneb/dada2/issueshttps://github.com/benjjneb/dada2/issues]8;;&gt;.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 937 rows containing missing values (`geom_tile()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the quality is quite good, but around 200-220 nucleotides it begins to decrease. It’s not a sharp drop (a “crash”) but the median quality starts to decline around 200 nucleotides and dips below a median quality of around 20 by around 230-240 nucleotides.</p>
<p>Now let’s look at the reverse reads.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot quality profile of reverse reads</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotQualityProfile</span>(fnRs[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 188 rows containing missing values (`geom_tile()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These are similar to the forward reads, but the quality stays high for longer. This is common (the R1 read tends to be of high quality than the R2). Here, the quality stays quite high almost all the way to the end of the read, although the median quality does begin to decline starting around 230-240 nucleotides.</p>
</section>
<section id="trimming-and-quality-control" class="level3">
<h3 class="anchored" data-anchor-id="trimming-and-quality-control">Trimming and quality control</h3>
<p>Now that we have visualized the quality of the reads, we need to make some decisions about where to trim the reads.</p>
<p>It is very important to trim barcode and primer nucleotides from the reads as they can cause problems when identifying ASVs. Our reads contain the 12 nucleotide barcode sequence at the beginning of each read that will need to be trimmed. In our case, we used the primers 799F and 1115R to amplify the bacterial 16S rRNA gene. These primers are 18 nucleotides (799F) and 16 nucleotides (1115R) in length, and are found after the barcode sequence at the beginning of each read. Sometimes FASTQ files will be supplied with the barcodes and/or primers already removed from the sequences; you will need to check or ask the sequencing centre about this for your own data. In our case we will need to remove the forward barcode + primer nucleotides (30 nucleotides) and the reverse barcode + primer nucleotides (28 nucleotides) from the beginning of each read.</p>
<p>We also need to trim the reads to remove low-quality nucleotides from the end of the reads. As we saw above, the quality of both the forward and reverse reads are quite good, but forward read quality did begin to decline around 200 nucleotides and reverse read quality declines slightly beginning around 230-240 nucleotides.</p>
<p>An important consideration when deciding where to trim our reads is that we want to be able to merge together the forward and reverse reads later in the pipeline. To do this, we need the reads to overlap with one another. To figure out whether our forward and reverse reads will overlap after trimming, we need to know the length of the amplicon that we sequenced. In our case, the 799F-1115R primers create an amplicon that is 316 nucleotides in length. Thus, we need to make sure that the total length of the forward and reverse reads that remains after trimming is longer than 316 nucleotides in order to have some overlapping nucleotides that can be used to merge the reads together. If the forward and reverse reads cannot be merged by overlap after trimming, it will not be possible to create a merged read that covers the full length of the amplicon. This is not a fatal problem but it can reduce accuracy of ASV binning (since we are missing data for a portion of the amplicon) and it makes taxonomic annotation more challenging. The overlapping portion of the reads also serves to increase confidence in the quality of ASVs, since for the overlapping portion we have two estimates of the nucleotide at each position which serves to reduce error and increase confidence in the base call at that position.</p>
<p>This is an important consideration when choosing what primers to use and what sequencing technology to use. You should aim to ensure that the total length of your forward and reverse reads is enough to cover the length of the region targeted by your primers, with as much overlap as possible to make merging the reads together easier. In our case, with an amplicon length of 312 nucleotides, and forward/reverse reads of around 300 nucleotides each, we will be sure to have lots of overlap, so we don’t have to worry too much if we need to trim our reads.</p>
<p>Now that we know the number of nucleotides to trim from the start and end of each sequence, we can now filter and trim our reads. Here, we will trim out barcode and primer nucleotides from the start of reads and low-quality nucleotides from the end of reads. We also filter out reads with low quality after trimming, as well as reads that contain N (unknown) nucleotides and reads that map to the phiX genome (a viral genome that is often added to sequencing runs to increase library quality).</p>
<p>This will create filtered versions of the FASTQ files in a new folder named dada2-filtered.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set filtered file folder paths and filenames</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>filt_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"dada2-filtered"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>filtFs <span class="ot">&lt;-</span> <span class="fu">file.path</span>(filt_path, <span class="fu">paste0</span>(sample.names, <span class="st">"_F_filt.fastq.gz"</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>filtRs <span class="ot">&lt;-</span> <span class="fu">file.path</span>(filt_path, <span class="fu">paste0</span>(sample.names, <span class="st">"_R_filt.fastq.gz"</span>))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter and trim reads</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># multithread argument = number of cores to use (set TRUE to use all)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># note need to trim out primers at the start of the reads</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># and trim the end of the reads when the quality crashes</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">filterAndTrim</span>(fnFs, filtFs, fnRs, filtRs, <span class="at">trimLeft =</span> <span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">28</span>),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">truncLen=</span><span class="fu">c</span>(<span class="dv">200</span>,<span class="dv">230</span>), <span class="at">maxN=</span><span class="dv">0</span>, <span class="at">maxEE=</span><span class="dv">2</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">truncQ=</span><span class="dv">2</span>, <span class="at">rm.phix=</span><span class="cn">TRUE</span>, <span class="at">compress=</span><span class="cn">TRUE</span>, </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">multithread=</span><span class="cn">TRUE</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inferring-asvs" class="level3">
<h3 class="anchored" data-anchor-id="inferring-asvs">Inferring ASVs</h3>
<p>Now that we have our trimmed quality-control sequences, we can infer the identity and abundance of ASVs in our sequence files.</p>
<p>The first step of this process is to learn the error rates of our sequences. DADA2 uses information about error rates to infer the identity of ASVs in the samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Learn error rates</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>errF <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtFs, <span class="at">multithread=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>103149200 total bases in 606760 reads from 32 samples will be used for learning the error rates.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>errR <span class="ot">&lt;-</span> <span class="fu">learnErrors</span>(filtRs, <span class="at">multithread=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>101062620 total bases in 500310 reads from 22 samples will be used for learning the error rates.</code></pre>
</div>
</div>
<p>Once we have learned the error rates, we do some bookkeeping to reduce the time required to infer ASVs by removing replicate sequences from each sample. A given FASTQ file might contain large numbers of identical sequences. We don’t need to analyse each of these sequences separately; we’ll dereplicate the file by removing duplicates of identical sequences. This keeps track of the number of duplicates so that at the end of our process we know the actual abundance of each of these identical sequences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dereplicate the filtered fastq files</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>derepFs <span class="ot">&lt;-</span> <span class="fu">derepFastq</span>(filtFs)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>derepRs <span class="ot">&lt;-</span> <span class="fu">derepFastq</span>(filtRs)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Name the derep-class objects by the sample names</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(derepFs) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(derepRs) <span class="ot">&lt;-</span> sample.names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to use the <a href="http://dx.doi.org/10.1038/nmeth.3869">DADA2 algorithm</a> to identify ASVs in our samples. DADA2 uses a model of the error rate in sequences to identify the unique amplicon sequence variants (ASVs) that are present in our samples.</p>
<p>When carrying out ASV binning and chimera identification, we have the option to pool together samples (the pool argument). There are different strategies for pooling samples together. It is quicker to bin ASVs on a per-sample basis, but this might miss extremely rare ASVs that occur with low abundance in multiple samples. By pooling samples together, we can increase our ability to accurately identify these rare ASVs. The downside is that pooling samples together takes more time since we not have to analyse a larger number of sequences at the same time. The “pseudo-pooling” option strikes a balance between these options and is the approach we’ll use today. There is an in-depth explanation of the different pooling options at the <a href="https://benjjneb.github.io/dada2/pseudo.html">DADA2 website</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Infer the sequence variants in each sample</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>dadaFs <span class="ot">&lt;-</span> <span class="fu">dada</span>(derepFs, <span class="at">err=</span>errF, <span class="at">pool=</span><span class="st">"pseudo"</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample 1 - 43893 reads in 4133 unique sequences.
Sample 2 - 1535 reads in 279 unique sequences.
Sample 3 - 342 reads in 80 unique sequences.
Sample 4 - 36815 reads in 4992 unique sequences.
Sample 5 - 6901 reads in 796 unique sequences.
Sample 6 - 69130 reads in 6170 unique sequences.
Sample 7 - 13883 reads in 1640 unique sequences.
Sample 8 - 35769 reads in 2874 unique sequences.
Sample 9 - 35178 reads in 3504 unique sequences.
Sample 10 - 49487 reads in 5858 unique sequences.
Sample 11 - 15594 reads in 1607 unique sequences.
Sample 12 - 28849 reads in 2366 unique sequences.
Sample 13 - 529 reads in 110 unique sequences.
Sample 14 - 29475 reads in 2956 unique sequences.
Sample 15 - 22328 reads in 1714 unique sequences.
Sample 16 - 17615 reads in 2171 unique sequences.
Sample 17 - 24895 reads in 3116 unique sequences.
Sample 18 - 31171 reads in 2974 unique sequences.
Sample 19 - 11127 reads in 1205 unique sequences.
Sample 20 - 20 reads in 16 unique sequences.
Sample 21 - 255 reads in 57 unique sequences.
Sample 22 - 25519 reads in 2519 unique sequences.
Sample 23 - 7057 reads in 645 unique sequences.
Sample 24 - 29 reads in 11 unique sequences.
Sample 25 - 86 reads in 23 unique sequences.
Sample 26 - 11570 reads in 1413 unique sequences.
Sample 27 - 21806 reads in 2227 unique sequences.
Sample 28 - 8836 reads in 1092 unique sequences.
Sample 29 - 500 reads in 108 unique sequences.
Sample 30 - 19733 reads in 2783 unique sequences.
Sample 31 - 347 reads in 94 unique sequences.
Sample 32 - 36486 reads in 5477 unique sequences.
Sample 33 - 22106 reads in 2394 unique sequences.
Sample 34 - 24618 reads in 2881 unique sequences.
Sample 35 - 608 reads in 124 unique sequences.
Sample 36 - 25074 reads in 3998 unique sequences.
Sample 37 - 22197 reads in 2188 unique sequences.

   selfConsist step 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>dadaRs <span class="ot">&lt;-</span> <span class="fu">dada</span>(derepRs, <span class="at">err=</span>errR, <span class="at">pool=</span><span class="st">"pseudo"</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample 1 - 43893 reads in 3352 unique sequences.
Sample 2 - 1535 reads in 196 unique sequences.
Sample 3 - 342 reads in 71 unique sequences.
Sample 4 - 36815 reads in 4930 unique sequences.
Sample 5 - 6901 reads in 557 unique sequences.
Sample 6 - 69130 reads in 5237 unique sequences.
Sample 7 - 13883 reads in 1296 unique sequences.
Sample 8 - 35769 reads in 2357 unique sequences.
Sample 9 - 35178 reads in 2961 unique sequences.
Sample 10 - 49487 reads in 4856 unique sequences.
Sample 11 - 15594 reads in 1250 unique sequences.
Sample 12 - 28849 reads in 2007 unique sequences.
Sample 13 - 529 reads in 83 unique sequences.
Sample 14 - 29475 reads in 2315 unique sequences.
Sample 15 - 22328 reads in 1413 unique sequences.
Sample 16 - 17615 reads in 1728 unique sequences.
Sample 17 - 24895 reads in 2801 unique sequences.
Sample 18 - 31171 reads in 2593 unique sequences.
Sample 19 - 11127 reads in 1113 unique sequences.
Sample 20 - 20 reads in 16 unique sequences.
Sample 21 - 255 reads in 48 unique sequences.
Sample 22 - 25519 reads in 2316 unique sequences.
Sample 23 - 7057 reads in 571 unique sequences.
Sample 24 - 29 reads in 8 unique sequences.
Sample 25 - 86 reads in 18 unique sequences.
Sample 26 - 11570 reads in 1256 unique sequences.
Sample 27 - 21806 reads in 1916 unique sequences.
Sample 28 - 8836 reads in 1008 unique sequences.
Sample 29 - 500 reads in 96 unique sequences.
Sample 30 - 19733 reads in 2245 unique sequences.
Sample 31 - 347 reads in 87 unique sequences.
Sample 32 - 36486 reads in 5014 unique sequences.
Sample 33 - 22106 reads in 2037 unique sequences.
Sample 34 - 24618 reads in 2683 unique sequences.
Sample 35 - 608 reads in 83 unique sequences.
Sample 36 - 25074 reads in 3689 unique sequences.
Sample 37 - 22197 reads in 1876 unique sequences.

   selfConsist step 2</code></pre>
</div>
</div>
</section>
<section id="merge-denoised-forward-and-reverse-reads" class="level3">
<h3 class="anchored" data-anchor-id="merge-denoised-forward-and-reverse-reads">Merge denoised forward and reverse reads</h3>
<p>Now that we have identified ASVs from our sequences, we can merge together the forward and reverse reads into a single sequence that will cover the full length of our amplicon. This approach works by looking for matching nucleotides in the overlapping portion of the forward and reverse reads.</p>
<p>As noted above, if your forward and reverse reads do not overlap, they cannot be merged. It is still possible to merge them by concatenating together the forward and reverse reads, but this approach makes it more difficult to do taxonomic annotation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the denoised forward and reverse reads:</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>mergers <span class="ot">&lt;-</span> <span class="fu">mergePairs</span>(dadaFs, derepFs, dadaRs, derepRs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="construct-sequence-table" class="level3">
<h3 class="anchored" data-anchor-id="construct-sequence-table">Construct sequence table</h3>
<p>We have identified ASVs and merged the forward and reverse reads into a single ASV. We can now construct the sequence table, which is a matrix of ASV abundances in each sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># construct sequence table</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>seqtab <span class="ot">&lt;-</span> <span class="fu">makeSequenceTable</span>(mergers)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># look at dimension of sequence table (# samples, # ASVs)</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(seqtab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   37 2540</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at length of ASVs</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">nchar</span>(<span class="fu">getSequences</span>(seqtab)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
295 296 297 298 299 300 301 302 303 304 305 306 307 308 312 318 
 12 113  73  99  82 458 264 697 484 109 140   1   5   1   1   1 </code></pre>
</div>
</div>
</section>
<section id="remove-chimeras" class="level3">
<h3 class="anchored" data-anchor-id="remove-chimeras">Remove chimeras</h3>
<p>The final step of processing the sequence files involves identifying and removing chimeric sequences. These are sequences that contain portions of two distinct organisms. Chimeric sequences can arise at different stages in the process of sequencing samples including during PCR and during sequencing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove chimeras</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">removeBimeraDenovo</span>(seqtab, <span class="at">method=</span><span class="st">"consensus"</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>, <span class="at">verbose=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Identified 1425 bimeras out of 2540 input sequences.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at dimension of sequence table (# samples, # ASVs) after chimera removal</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(seqtab.nochim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   37 1115</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what % of reads remain after chimera removal?</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(seqtab.nochim)<span class="sc">/</span><span class="fu">sum</span>(seqtab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9836811</code></pre>
</div>
</div>
</section>
<section id="tracking-read-fate-through-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="tracking-read-fate-through-the-pipeline">Tracking read fate through the pipeline</h3>
<p>Now we have completed the processing of our files. We can track how many reads per sample remain after the different steps of the process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary - track reads through the pipeline</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>getN <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">getUniques</span>(x))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>track <span class="ot">&lt;-</span> <span class="fu">cbind</span>(out, <span class="fu">sapply</span>(dadaFs, getN), <span class="fu">sapply</span>(mergers, getN), <span class="fu">rowSums</span>(seqtab), <span class="fu">rowSums</span>(seqtab.nochim))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(track) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"input"</span>, <span class="st">"filtered"</span>, <span class="st">"denoised"</span>, <span class="st">"merged"</span>, <span class="st">"tabled"</span>, <span class="st">"nonchim"</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(track) <span class="ot">&lt;-</span> sample.names</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(track)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            input filtered denoised merged tabled nonchim
AUC.C1.2X1  45852    43893    43836  43297  43297   43268
AUC.C1.3     1605     1535     1535   1532   1532    1522
AUC.N1.1      362      342      332    324    324     324
AUC.N1.3    38442    36815    36731  35069  35069   33707
AUC.N2.1.X1  7193     6901     6899   6857   6857    6854
AUC.N2.1X2  72307    69130    69116  68251  68251   68226</code></pre>
</div>
</div>
</section>
<section id="taxonomic-annotation" class="level3">
<h3 class="anchored" data-anchor-id="taxonomic-annotation">Taxonomic annotation</h3>
<p>Now we will annotate the taxonomic identity of each ASV by comparing its sequence with a reference database. Our data are bacterial 16S rRNA sequences so we’ll use the SILVA database for this taxonomic annotation. A version of the SILVA database formatted for use with DADA2 is available at the <a href="https://benjjneb.github.io/dada2/training.html">DADA2 website</a>, along with other databases for different barcode genes.</p>
<section id="higher-level-taxonomic-annotation" class="level4">
<h4 class="anchored" data-anchor-id="higher-level-taxonomic-annotation">Higher-level taxonomic annotation</h4>
<p>For taxonomic annotation at ranks from domains to genera, DADA2 uses the <a href="https://journals.asm.org/doi/10.1128/AEM.00062-07">RDP Naive Bayesian Classifier algorithm</a>. This algorithm compares each ASV sequence to the reference database. If the bootstrap confidence in the taxonomic annotation at each rank is 50% or greater, we assign that annotation to the ASV at that rank. If an ASV cannot be confidently identified at a given rank, there will be a NA value in the taxonomy table.</p>
<p>Note that this step can be time consuming, especially if you have a large number of ASVs to identify. Running this annotation step on a computer with numerous cores/threads will speed up the process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identify taxonomy</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>taxa <span class="ot">&lt;-</span> <span class="fu">assignTaxonomy</span>(seqtab.nochim, <span class="st">"SILVA138.1/silva_nr99_v138.1_train_set.fa.gz"</span>, <span class="at">multithread=</span><span class="cn">TRUE</span>, <span class="at">tryRC=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="species-level-taxonomic-annotation" class="level4">
<h4 class="anchored" data-anchor-id="species-level-taxonomic-annotation">Species-level taxonomic annotation</h4>
<p>We use the RDP Naive Bayesian Classifier algorithm for taxonomic annotations at ranks from domains to genera. This allows for annotations even if there is not an exact match between ASV sequences and sequences in the reference database. At the species level, we need a different strategy, since we do not want to identify an ASV as belonging to a species unless its sequence matches that species exactly. Note that this approach means that we cannot carry out species-level taxonomic annotation if we concatenated our sequences rather than merging them together into a single sequence.</p>
<p>This step can also be somewhat time consuming depending on the number of ASVs to be annotated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># exact species matching (won't work if concatenating sequences)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>taxa.sp <span class="ot">&lt;-</span> <span class="fu">addSpecies</span>(taxa,  <span class="st">"SILVA138.1/silva_species_assignment_v138.1.fa.gz"</span>, <span class="at">allowMultiple =</span> <span class="cn">TRUE</span>, <span class="at">tryRC =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have the taxonomic annotations, we can inspect them. We create a special version of the taxonomy table with the ASV names removed (the name of each ASV is its full sequence, so the names are very long).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the taxonomic assignments</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>taxa.print <span class="ot">&lt;-</span> taxa.sp <span class="co"># Removing sequence rownames for display only</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxa.print) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(taxa.print, <span class="at">n=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Kingdom    Phylum             Class                 Order             
 [1,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
 [2,] "Bacteria" "Cyanobacteria"    "Cyanobacteriia"      "Chloroplast"     
 [3,] "Bacteria" "Bacteroidota"     "Bacteroidia"         "Cytophagales"    
 [4,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
 [5,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
 [6,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
 [7,] "Bacteria" "Actinobacteriota" "Actinobacteria"      "Micrococcales"   
 [8,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
 [9,] "Bacteria" "Actinobacteriota" "Actinobacteria"      "Micrococcales"   
[10,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
[11,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
[12,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
[13,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
[14,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
[15,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
[16,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
[17,] "Bacteria" "Proteobacteria"   "Gammaproteobacteria" "Burkholderiales" 
[18,] "Bacteria" "Proteobacteria"   "Gammaproteobacteria" "Burkholderiales" 
[19,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Sphingomonadales"
[20,] "Bacteria" "Proteobacteria"   "Alphaproteobacteria" "Rhizobiales"     
      Family              Genus                           
 [1,] "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
 [2,] NA                  NA                              
 [3,] "Hymenobacteraceae" "Hymenobacter"                  
 [4,] "Sphingomonadaceae" "Sphingomonas"                  
 [5,] "Sphingomonadaceae" "Sphingomonas"                  
 [6,] "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
 [7,] "Microbacteriaceae" "Amnibacterium"                 
 [8,] "Sphingomonadaceae" "Sphingomonas"                  
 [9,] "Microbacteriaceae" "Frondihabitans"                
[10,] "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
[11,] "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
[12,] "Beijerinckiaceae"  "1174-901-12"                   
[13,] "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
[14,] "Sphingomonadaceae" "Sphingomonas"                  
[15,] "Sphingomonadaceae" "Sphingomonas"                  
[16,] "Sphingomonadaceae" "Sphingomonas"                  
[17,] "Oxalobacteraceae"  "Massilia"                      
[18,] "Oxalobacteraceae"  "Massilia"                      
[19,] "Sphingomonadaceae" "Sphingomonas"                  
[20,] "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
      Species                                        
 [1,] NA                                             
 [2,] NA                                             
 [3,] "arcticus/bucti/perfusus"                      
 [4,] "aerolata/faeni"                               
 [5,] NA                                             
 [6,] NA                                             
 [7,] NA                                             
 [8,] "ginsenosidivorax"                             
 [9,] "australicus/cladoniiphilus/peucedani/sucicola"
[10,] NA                                             
[11,] NA                                             
[12,] NA                                             
[13,] NA                                             
[14,] "faeni"                                        
[15,] "echinoides/glacialis/mucosissima/rhizogenes"  
[16,] NA                                             
[17,] NA                                             
[18,] "aurea/oculi"                                  
[19,] NA                                             
[20,] NA                                             </code></pre>
</div>
</div>
</section>
</section>
<section id="final-steps---clean-up-and-save-data-objects-and-workspace" class="level3">
<h3 class="anchored" data-anchor-id="final-steps---clean-up-and-save-data-objects-and-workspace">Final steps - clean up and save data objects and workspace</h3>
<p>We have now completed our analysis of the sequence files. We have created an ASV table seqtab.nochim that contains the error-corrected non-chimeric ASV sequences and their abundances in each sample. For each ASV we also have the taxonomic annotations of the ASV in the object taxa.sp. We will save these data objects to the file system, along with a copy of the entire workspace containing all the output of the analyses so far. We will use these files to continue our analyses in the next part of the workshop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Save sequence table and taxonomic annotations to individual files</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(seqtab.nochim, <span class="st">"seqtab.nochim.rds"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(taxa.sp, <span class="st">"taxa.sp.rds"</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Save entire R workspace to file</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">save.image</span>(<span class="st">"Microbiome-sequence-analysis-workspace.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="data-normalization-and-ecological-analysis-of-microbiome-data" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Data normalization and ecological analysis of microbiome data</h1>
<p>In this workshop, we will use the output of a DADA2 analysis of raw sequence data to explore the importance of different factors that influence the diversity and composition of microbial communities on leaves.</p>
<section id="about-the-data-set-1" class="level2">
<h2 class="anchored" data-anchor-id="about-the-data-set-1">About the data set</h2>
<p>In this workshop, we will be analyzing the bacterial communities found on leaves of sugar maple seedlings of different provenances planted at sites across eastern North America.</p>
<p>These data are taken from the article:</p>
<p>De Bellis, Laforest-Lapointe, Solarik, Gravel, and Kembel. 2022. Regional variation drives differences in microbial communities associated with sugar maple across a latitudinal range. Ecology (published online ahead of print). <a href="https://doi.org/10.1002/ecy.3727">doi:10.1002/ecy.3727</a></p>
<p>For this workshop, we will work with a subset of samples from six of the nine sites sampled for the article. These samples are located in three different biomes (temperate, mixed, and boreal forests). At each site, several sugar maple seedlings were planted and harvested, and we collected bacterial DNA from the leaves. Each sample thus represents the bacterial communities on the leaves of a single sugar maple seedling. For each seedling, we have associated metadata on the provenance of the seed, the site where the seed was planted, and the biome/stand type where the seed was planted.</p>
</section>
<section id="install-and-load-required-packages-and-data" class="level2">
<h2 class="anchored" data-anchor-id="install-and-load-required-packages-and-data">Install and load required packages and data</h2>
<p>For this part of the workshop we will need to install several R packages. The commands below should work to install these packages, you should make sure you have the latest version of R installed (version 4.2.0 at the time of writing this document).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install packages from CRAN</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="at">pkgs =</span> <span class="fu">c</span>(<span class="st">"Rcpp"</span>, <span class="st">"RcppArmadillo"</span>, <span class="st">"picante"</span>, <span class="st">"ggpubr"</span>, <span class="st">"pheatmap"</span>), <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install packages from Bioconductor</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"dada2"</span>, <span class="at">version =</span> <span class="st">"3.15"</span>, <span class="at">update =</span> <span class="cn">FALSE</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># if the dada2 install returns a warning for BiocParallel, install from binary using this command:</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"># BiocManager::install("BiocParallel", version = "3.15", type="binary", update = FALSE)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"DESeq2"</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"phyloseq"</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"ANCOMBC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To begin, we will load the required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">### load packages</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(picante)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DESeq2)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ANCOMBC)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phyloseq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="load-dada2-results" class="level3">
<h3 class="anchored" data-anchor-id="load-dada2-results">Load DADA2 results</h3>
<p>We will continue our analyses picking up where we left off at the end of day 1 of the workshop. We used the DADA2 package to identify ASVs and their abundances in samples, and to annotate ASVs taxonomically by comparing them to the SILVA rRNA database. We saved these data objects as files. You will need to place a copy of the files “seqtab.nochim.rds” and “taxa.sp.rds” in the working directory, and then we load them into our R workspace.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load sequence table (nonchimeric ASV abundances in samples)</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>seqtab.nochim <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"seqtab.nochim.rds"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co"># load taxonomic annotations (taxonomic ID of each ASV)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>taxa.sp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"taxa.sp.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-metadata" class="level3">
<h3 class="anchored" data-anchor-id="load-metadata">Load metadata</h3>
<p>The metadata file we will use for this workshop is available for download at the following URL: <a href="https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077">https://figshare.com/articles/dataset/Data_files_for_BIOS2_Microbiome_Analysis_Workshop/19763077</a>.</p>
<p>You will need to download the file “metadata-Qleaf_BACT.csv” and place a copy of this file in the working directory. Then we can load the metadata.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load metadata</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"metadata-Qleaf_BACT.csv"</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect metadata</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(metadata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Description    SampleType StandType TransplantedSite
ASH.S2.2       ASH.S2.2 Leaf.Bacteria    Boreal    Ashuapmushuan
ASH.N1.1.X1 ASH.N1.1.X1 Leaf.Bacteria    Boreal    Ashuapmushuan
ASH.N1.1.X3 ASH.N1.1.X3 Leaf.Bacteria    Boreal    Ashuapmushuan
ASH.N1.1X3   ASH.N1.1X3 Leaf.Bacteria    Boreal    Ashuapmushuan
ASH.C1.1       ASH.C1.1 Leaf.Bacteria    Boreal    Ashuapmushuan
ASH.C1.2       ASH.C1.2 Leaf.Bacteria    Boreal    Ashuapmushuan
            SeedSourceRegion SeedSourceOrigin TransplantedSiteLat
ASH.S2.2               South         Kentucky               48.81
ASH.N1.1.X1            North        Montmagny               48.81
ASH.N1.1.X3            North        Montmagny               48.81
ASH.N1.1X3             North        Montmagny               48.81
ASH.C1.1             Central     Pennsylvania               48.81
ASH.C1.2             Central     Pennsylvania               48.81
            TransplantedSiteLon SeedSourceOriginLat SeedSourceOriginLon
ASH.S2.2                 -72.77               38.26              -84.95
ASH.N1.1.X1              -72.77               46.95              -70.46
ASH.N1.1.X3              -72.77               46.95              -70.46
ASH.N1.1X3               -72.77               46.95              -70.46
ASH.C1.1                 -72.77               41.13              -77.62
ASH.C1.2                 -72.77               41.13              -77.62</code></pre>
</div>
</div>
<p>The metadata contains information about each sample, including the following columns:</p>
<ul>
<li>Description: the name of the sample (these match the names used on the sequence files)</li>
<li>SampleType: the samples we are working with are all leaf bacteria (we collected other types of data in the original study, but here we focus just on leaf bacteria)</li>
<li>StandType: the stand/biome type of the site where the seedling were planted. Either boreal, mixed, or temperate forest.</li>
<li>TransplantedSite: the site where the seedling was planted</li>
<li>SeedSourceRegion: the region from which the seed was collected</li>
<li>SeedSourceOrigin: the site from which the seed was collected</li>
<li>TransplantedSiteLat and TransplantedSiteLon: the latitude and longitude of the site where the seedling was transplanted</li>
</ul>
</section>
</section>
<section id="cleaning-and-summarizing-dada2-results" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-and-summarizing-dada2-results">Cleaning and summarizing DADA2 results</h2>
<p>Our first steps will be to do some cleaning up of the DADA2 results to make it easier to work with them. We create community and taxonomy objects that we will work with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># community object from nonchimeric ASV sequence table</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>comm <span class="ot">&lt;-</span> seqtab.nochim</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># taxonomy object - make sure order of ASVs match between community and taxonomy</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>taxo <span class="ot">&lt;-</span> taxa.sp[<span class="fu">colnames</span>(comm),]</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># keep metadata only for community samples</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> metadata[<span class="fu">rownames</span>(comm),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will also rename the ASVs in our community and taxonomy data objects. By default, ASVs are named by their full sequence. This makes it hard to look at these objects since the names are too long to display easily. We will replace the names of ASVs by “ASV_XXX” where XXX is a number from 1 to the number of observed ASVs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ASV names are their full sequences by default</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This makes it very hard to look at them (the names are too long)</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Store ASV sequence information and rename ASVs as "ASV_XXX"</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>ASV.sequence.info <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ASV.name=</span><span class="fu">paste0</span>(<span class="st">'ASV_'</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(comm)[<span class="dv">2</span>]),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">ASV.sequence=</span><span class="fu">colnames</span>(comm))</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(comm) <span class="ot">&lt;-</span> ASV.sequence.info<span class="sc">$</span>ASV.name</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxo) <span class="ot">&lt;-</span> ASV.sequence.info<span class="sc">$</span>ASV.name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exploring-community-data" class="level3">
<h3 class="anchored" data-anchor-id="exploring-community-data">Exploring community data</h3>
<p>Now we can begin to look at our data in more depth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># community - number of samples (rows) and ASVs (columns)</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(comm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   37 1115</code></pre>
</div>
</div>
<p>We have 37 samples and 1115 ASVs. If we look at our data objects, we can see the type of data in each of the different objects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at community data object</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(comm)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            ASV_1 ASV_2 ASV_3 ASV_4 ASV_5 ASV_6
AUC.C1.2X1  10335   158  3993  4092   584  3225
AUC.C1.3      123    98    15     0     3     3
AUC.N1.1       84    17    16     5     0     3
AUC.N1.3     4738   113   628  3978     0   329
AUC.N2.1.X1  1871  1853  1431    20    58     2
AUC.N2.1X2  19648  4200  6465   191  7221  2054</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at taxonomy object</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(taxo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Kingdom    Phylum           Class                 Order             
ASV_1 "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Rhizobiales"     
ASV_2 "Bacteria" "Cyanobacteria"  "Cyanobacteriia"      "Chloroplast"     
ASV_3 "Bacteria" "Bacteroidota"   "Bacteroidia"         "Cytophagales"    
ASV_4 "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Sphingomonadales"
ASV_5 "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Sphingomonadales"
ASV_6 "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Rhizobiales"     
      Family              Genus                           
ASV_1 "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
ASV_2 NA                  NA                              
ASV_3 "Hymenobacteraceae" "Hymenobacter"                  
ASV_4 "Sphingomonadaceae" "Sphingomonas"                  
ASV_5 "Sphingomonadaceae" "Sphingomonas"                  
ASV_6 "Beijerinckiaceae"  "Methylobacterium-Methylorubrum"
      Species                  
ASV_1 NA                       
ASV_2 NA                       
ASV_3 "arcticus/bucti/perfusus"
ASV_4 "aerolata/faeni"         
ASV_5 NA                       
ASV_6 NA                       </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at metadata object</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(metadata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Description    SampleType StandType TransplantedSite
AUC.C1.2X1   AUC.C1.2X1 Leaf.Bacteria     Mixed          Auclair
AUC.C1.3       AUC.C1.3 Leaf.Bacteria     Mixed          Auclair
AUC.N1.1       AUC.N1.1 Leaf.Bacteria     Mixed          Auclair
AUC.N1.3       AUC.N1.3 Leaf.Bacteria     Mixed          Auclair
AUC.N2.1.X1 AUC.N2.1.X1 Leaf.Bacteria     Mixed          Auclair
AUC.N2.1X2   AUC.N2.1X2 Leaf.Bacteria     Mixed          Auclair
            SeedSourceRegion SeedSourceOrigin TransplantedSiteLat
AUC.C1.2X1           Central     Pennsylvania               47.75
AUC.C1.3             Central     Pennsylvania               47.75
AUC.N1.1               North        Montmagny               47.75
AUC.N1.3               North        Montmagny               47.75
AUC.N2.1.X1            North   Rivere-du-Loup               47.75
AUC.N2.1X2             North   Rivere-du-Loup               47.75
            TransplantedSiteLon SeedSourceOriginLat SeedSourceOriginLon
AUC.C1.2X1               -68.08               41.13              -77.62
AUC.C1.3                 -68.08               41.13              -77.62
AUC.N1.1                 -68.08               46.95              -70.46
AUC.N1.3                 -68.08               46.95              -70.46
AUC.N2.1.X1              -68.08               47.73              -69.48
AUC.N2.1X2               -68.08               47.73              -69.48</code></pre>
</div>
</div>
</section>
<section id="subset-community-to-remove-host-dna" class="level3">
<h3 class="anchored" data-anchor-id="subset-community-to-remove-host-dna">Subset community to remove host DNA</h3>
<p>Before proceeding we need to remove host DNA and other contaminants and low-quality sequences. We should do this before rarefaction and subsetting samples since it could change the number of sequences per sample if there is a lot of non-target DNA. We will carry this step out first so that subsequent analyses don’t include these non-bacterial ASVs in any of the analyses.</p>
<p>A reminder that primer choice and the habitat you are studying will have a big effect on the amount of non-target DNA that is in your samples. Many commonly used primers (for example, the widely used Earth Microbiome Project 16S rRNA primers 515F–806R which target the V4 region of the 16S gene) will amplify not only free living bacteria, but also DNA from host cells including chloroplasts and mitochondria. If you are working with host-associated microbiomes you may want to consider using a different primer that will not amplify host DNA. For example, when quantifying plant-associated microbiomes we commonly use the 16S primer 799F-1115R which targets the V5 region of the 16S gene and does not amplify chloroplasts or mitochondria.</p>
<p>Because we used the 799F-1115R primers for this study, we do not expect to find much host DNA, but we should check anyways, since a few host DNA sequences might have been amplified anyways. This is a very important step of the data analysis process since host DNA is not part of the microbial community and should not be included in data analyses. Otherwise, the amount of host DNA in a sample will lead to changes in the abundance of ASVs that are not actually part of the bacterial community being targeted.</p>
<p>When using a primer that targets bacteria, host DNA and DNA of non-target organisms in the samples will typically show up ASVs annotated as belonging to a non-Bacteria domain (Archaea or Eukaryota), or the taxonomic order is “Chloroplast”, or the taxonomic family is “Mitochondria”.</p>
<p>First we check whether any of our sequence are classified into a domain other than the bacteria.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many ASVs are classified to different domains?</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(taxo[,<span class="st">"Kingdom"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Bacteria 
    1115 </code></pre>
</div>
</div>
<p>All of the ASVs are classified as belonging to the domain Bacteria. Now let’s check for chloroplasts and mitochondria.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many ASVs are classified as Chloroplasts?</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(taxo[,<span class="st">"Order"</span>])[<span class="st">"Chloroplast"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chloroplast 
         12 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># How many ASVs are classified as Mitochondria?</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(taxo[,<span class="st">"Family"</span>])[<span class="st">"Mitochondria"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mitochondria 
           2 </code></pre>
</div>
</div>
<p>There are only a few ASVs classified as chloroplasts and mitochondria. This is expected since we used a primer that should exclude this host DNA. We will remove these ASVs before continuing our analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove chloroplast and mitochondria ASVs from taxonomy table</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>taxo <span class="ot">&lt;-</span> <span class="fu">subset</span>(taxo, taxo[,<span class="st">"Order"</span>]<span class="sc">!=</span><span class="st">"Chloroplast"</span> <span class="sc">&amp;</span> taxo[,<span class="st">"Family"</span>]<span class="sc">!=</span><span class="st">"Mitochondria"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove these ASVs from the community matrix as well</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>comm <span class="ot">&lt;-</span> comm[,<span class="fu">rownames</span>(taxo)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you find a large number of ASVs classified as non-Bacteria, or as chloroplasts or mitochondria, you will need to remove them from your data set prior to further analysis. Sometimes this can mean that many of your samples will contain few sequences after removing the host DNA and non-bacterial ASVs. If this is the case, you can consider using a primer that will not amplify host DNA, or sequencing your samples more deeply so that enough bacterial DNA will remain after removing the host DNA. However, this latter approach will waste a lot of your sequences, and in some cases if your samples contain mostly host DNA it will be difficult to obtain enough bacterial sequences to carry out ecological analyses.</p>
</section>
<section id="summary-statistics" class="level3">
<h3 class="anchored" data-anchor-id="summary-statistics">Summary statistics</h3>
<p>To begin with, we can calculate summary statistics for our community and taxonomy data. We mentioned earlier that the number of sequences per sample (library size) is normalized, meaning we aimed to sequence approximately the same number of reads per sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of reads per sample</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rowSums</span>(comm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> AUC.C1.2X1    AUC.C1.3    AUC.N1.1    AUC.N1.3 AUC.N2.1.X1  AUC.N2.1X2 
      43110        1305         307       33424        4966       63971 
   AUC.N2.2 AUC.S1.1.X2    AUC.S1X1    AUC.S2.2     BC.C1.2   BC.C2.1X1 
      13344       19407       33599       45548        8670       25333 
  BC.C2.3X2  BC.C2.3X2b   BC.N1.3X2       BC.N1  BC.N2.1.X3   BC.N2.1X1 
        271       24140        7507       15009       22164       20475 
  BC.N2.1X2    PAR.C1.1    PAR.C1.2    PAR.C2.3    PAR.N1.3 QLbactNeg19 
      10486          13         161       23407        6927          27 
QLbactNeg20  S.M.C1.3X2    S.M.C2.3  S.M.C2.3X2  S.M.S1.1X1     SF.C1.3 
         84       10137       20858        8403         485       19081 
    SF.C2.2     SF.N2.3     SF.S1.3     T2.C1.1     T2.C2.3     T2.N1.1 
        273       31314       19664       23534         602       20712 
    T2.S2.1 
      21663 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize log10 number of reads per sample</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">log10</span>(<span class="fu">rowSums</span>(comm)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that most samples have at least 4000-10000 sequences/sample. But there are some samples with fewer reads. This includes both the negative control samples as well as some of the ‘real’ samples. We will need to remove samples with too few reads - we’ll return to this shortly.</p>
<p>We can also look at the number of sequences per ASV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># log10 of number of reads per ASV</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">log10</span>(<span class="fu">colSums</span>(comm)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that ASV abundances follow a roughly lognormal distribution, meaning that there are a few highly abundant ASVs, but most ASVs are rare. Most ASVs are represented by fewer than 100 sequences (10^2).</p>
</section>
<section id="remove-negative-controls-and-samples-with-low-quality-data" class="level3">
<h3 class="anchored" data-anchor-id="remove-negative-controls-and-samples-with-low-quality-data">Remove negative controls and samples with low-quality data</h3>
<p>One of the first steps of analysing ASV data sets is to remove control samples, as well as samples with too few sequences. We will also need to normalize our data to take into account the fact that samples differ in the number of sequences they contain.</p>
<section id="rarefaction-curves" class="level4">
<h4 class="anchored" data-anchor-id="rarefaction-curves">Rarefaction curves</h4>
<p>We will visualize the relationship between the number of sequences in each sample (“sample size” in the figures below) versus the number of ASVs they contain (“species” in the figures below). These rarefaction curves make it clear why we need to take the number of sequences per sample into account when we analyse sample diversity.</p>
<p>First we plot a rarefaction curve for all samples. Each curve shows how the number of ASVs per sample changes with number of sequences in a particular sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rarecurve</span>(comm, <span class="at">step=</span><span class="dv">200</span>, <span class="at">label=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>For these rarefaction curves, the key thing to look for is where ASV richness (number of ASVs per sample) reaches a plateau relative to the number of reads per sample. It does look like the samples we can see have reached a plateau of ASV richness. But it’s hard to see the curve for many of the samples because of the x-axis limits - a few samples with a lot of sequences make it hard to see the less diverse samples. Let’s zoom in to look just at the range from 0 to 5000 sequences/sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rarecurve</span>(comm, <span class="at">step=</span><span class="dv">200</span>, <span class="at">label=</span><span class="cn">TRUE</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we can see that the vast majority of samples reach a plateau in their ASV richness by around 3000-5000 sequences/sample. There are a few samples with very low numbers of both sequences and ASVs. We will now look at the composition of the communities in these different samples.</p>
</section>
<section id="visualize-community-composition" class="level4">
<h4 class="anchored" data-anchor-id="visualize-community-composition">Visualize community composition</h4>
<p>Another way to quickly visualize the composition of all of our samples is to do an ordination to visualize similarity in composition among samples. Here we will visualize a principal components analysis on Hellinger-transformed ASV abundance data. Normally we should normalize the data before doing any diversity analysis but here we just want a quick look at whether some samples have very different composition from the rest. We do a PCA analysis and then plot the ordination results, overlaying confidence ellipses around the samples from the different transplanted stand types/biomes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA on Hellinger-transformed community data</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>comm.pca <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(<span class="fu">decostand</span>(comm,<span class="st">"hellinger"</span>))</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot ordination results</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiplot</span>(comm.pca, <span class="at">display=</span><span class="st">"sites"</span>, <span class="at">type=</span><span class="st">"text"</span>,<span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiellipse</span>(comm.pca, metadata<span class="sc">$</span>StandType, <span class="at">label=</span><span class="cn">TRUE</span>,<span class="at">cex=</span><span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There are two things to note in this ordination figure. First, we can see that along the first axis there is a separation between the negative control samples and a few other samples that cluster with the negative controls, versus all the other samples. Second, we can see that the composition of the communities seems to differ among stand type/biome along the second axis, varying from boreal to mixed to temperate forests. We’ll return to this observation later, but for now the important thing is that we can see that there are some samples that are more similar to the negative control samples than they are to the other ‘real’ samples. Let’s visualize the number of sequences per sample (library size) mapped onto these ordination axes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Surface plot - plot number of sequences/sample (library size)</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ordisurf</span>(comm.pca, <span class="fu">rowSums</span>(comm), <span class="at">bubble=</span><span class="cn">TRUE</span>, <span class="at">cex=</span><span class="dv">2</span>,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">main=</span><span class="st">"Library size (sequences/sample)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that the common characteristic of the samples that cluster on the right side of the ordination plot, next to the negative control samples, is that these samples contain very few sequences.</p>
<p>There are several reasons why some samples contain few sequences, but in general this is an indication that these samples contain data of low quality and should be excluded from further analysis. This can be caused by low microbial biomass in the original samples, with some problem with the extraction or amplification of microbial DNA in these samples, or simply by chance. Regardless, the fact that the composition of the microbial communities in these samples is more similar to the negative controls than to the other ‘real’ samples means we need to get rid of these samples.</p>
<p>If many of your samples contain few sequences, this could indicate some problem with the protocol being used for sample processing and sequencing, or the normalization step of library preparation. It could also indicate low microbial biomass. In the data we are analysing here, I suspect that the problem with these samples was low microbial biomass. The maple seedlings from which we extracted microbial DNA were sometimes small with only 1-2 tiny leaves, which doesn’t contain enough bacterial cells to reliably extract and sequence their DNA. When microbial biomass in a sample is small, the potential importance of contaminant DNA increases. Regardless of the cause, we will have to exclude these samples.</p>
<p>Deciding what number of sequences to use as a cutoff when getting rid of samples with a low number of sequences will depend on the nature of your data set and your biological questions. You should always aim to ensure that you have enough reads per sample to reach a plateau in the rarefaction curve. Beyond that, you may want set a cutoff for a minimum number of reads per sample that ensures that you keep enough samples to have sufficient replicates in your different treatments.</p>
</section>
<section id="check-negative-controls" class="level4">
<h4 class="anchored" data-anchor-id="check-negative-controls">Check negative controls</h4>
<p>We sequenced negative controls in this study to ensure that our samples were not contaminated and that the sequences we obtained come from bacteria on leaves and not from some other step of the sample processing such as from the DNA extraction kits or during PCR. As we saw above, the inclusion of these negative control samples is useful because we can look at their composition to identify ‘real’ samples that might contain contaminants. As a final step, let’s look at the negative control samples to see what ASVs they contain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Abundance of ASVs in negative controls</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>comm[<span class="st">'QLbactNeg19'</span>,][comm[<span class="st">'QLbactNeg19'</span>,]<span class="sc">&gt;</span><span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ASV_1  ASV_44  ASV_77 ASV_138 
      1      11      11       4 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>comm[<span class="st">'QLbactNeg20'</span>,][comm[<span class="st">'QLbactNeg20'</span>,]<span class="sc">&gt;</span><span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ASV_8   ASV_30   ASV_77   ASV_91  ASV_418  ASV_625 ASV_1002 
       1        1        2        1       72        3        4 </code></pre>
</div>
</div>
<p>Our negative controls look clean - they contain only a few sequences (fewer than 100) belonging to a small number of ASVs. This is the type of result we are looking for, and we will remove these negative controls shortly when we remove low quality samples with small numbers of sequences. We can also look at the taxonomic identity of the ASVs that are present in the negative controls.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Taxonomic identity of ASVs present in negative controls</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>taxo[<span class="fu">names</span>(comm[<span class="st">'QLbactNeg19'</span>,][comm[<span class="st">'QLbactNeg19'</span>,]<span class="sc">&gt;</span><span class="dv">0</span>]),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Kingdom    Phylum           Class                 Order             
ASV_1   "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Rhizobiales"     
ASV_44  "Bacteria" "Proteobacteria" "Gammaproteobacteria" "Enterobacterales"
ASV_77  "Bacteria" "Firmicutes"     "Bacilli"             "Lactobacillales" 
ASV_138 "Bacteria" "Proteobacteria" "Gammaproteobacteria" "Enterobacterales"
        Family             Genus                           
ASV_1   "Beijerinckiaceae" "Methylobacterium-Methylorubrum"
ASV_44  "Shewanellaceae"   "Shewanella"                    
ASV_77  "Streptococcaceae" "Streptococcus"                 
ASV_138 "Shewanellaceae"   "Shewanella"                    
        Species                                               
ASV_1   NA                                                    
ASV_44  "algae/haliotis"                                      
ASV_77  "cristatus/gordonii/ictaluri/mitis/porcorum/sanguinis"
ASV_138 NA                                                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>taxo[<span class="fu">names</span>(comm[<span class="st">'QLbactNeg20'</span>,][comm[<span class="st">'QLbactNeg20'</span>,]<span class="sc">&gt;</span><span class="dv">0</span>]),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Kingdom    Phylum           Class                 Order             
ASV_8    "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Sphingomonadales"
ASV_30   "Bacteria" "Bacteroidota"   "Bacteroidia"         "Cytophagales"    
ASV_77   "Bacteria" "Firmicutes"     "Bacilli"             "Lactobacillales" 
ASV_91   "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Acetobacterales" 
ASV_418  "Bacteria" "Proteobacteria" "Gammaproteobacteria" "Xanthomonadales" 
ASV_625  "Bacteria" "Firmicutes"     "Bacilli"             "Lactobacillales" 
ASV_1002 "Bacteria" "Firmicutes"     "Bacilli"             "Staphylococcales"
         Family               Genus           
ASV_8    "Sphingomonadaceae"  "Sphingomonas"  
ASV_30   "Hymenobacteraceae"  "Hymenobacter"  
ASV_77   "Streptococcaceae"   "Streptococcus" 
ASV_91   "Acetobacteraceae"   "Roseomonas"    
ASV_418  "Rhodanobacteraceae" "Fulvimonas"    
ASV_625  "Streptococcaceae"   "Streptococcus" 
ASV_1002 "Staphylococcaceae"  "Staphylococcus"
         Species                                                                               
ASV_8    "ginsenosidivorax"                                                                    
ASV_30   NA                                                                                    
ASV_77   "cristatus/gordonii/ictaluri/mitis/porcorum/sanguinis"                                
ASV_91   NA                                                                                    
ASV_418  NA                                                                                    
ASV_625  "anginosus/mitis/oralis/pneumoniae/pseudopneumoniae"                                  
ASV_1002 "aureus/capitis/caprae/epidermidis/haemolyticus/saccharolyticus/saprophyticus/warneri"</code></pre>
</div>
</div>
</section>
</section>
<section id="subset-community-to-remove-low-sequence-number-samples" class="level3">
<h3 class="anchored" data-anchor-id="subset-community-to-remove-low-sequence-number-samples">Subset community to remove low sequence number samples</h3>
<p>Now that we have done some exploratory data analyses, we will take a subset of our communities remove the negative controls as well as samples with a low number of sequences.</p>
<p>When we looked at the rarefaction curves, it looked like most samples reached a plateau in number of ASVs per sequence by around 3000-5000 sequences/sample. When we looked at the distribution of number of sequences per sample, we saw that most samples contained at least 4000-5000 sequences. The samples that had fewer than that number of sequences were the ones that clustered with the negative control samples to the right of the ordination figure. Thus, we will set a cutoff of 4000 sequences per sample as a minimum to include a sample in further analysis. This will remove both the negative control samples and the samples of questionable quality that contained very few sequences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># what is the dimension of the full community data set</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(comm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   37 1027</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># take subset of communities with at least 4000 sequences</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>comm.sub <span class="ot">&lt;-</span> comm[<span class="fu">rowSums</span>(comm)<span class="sc">&gt;=</span><span class="dv">4000</span>,]</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># also take subset of ASVs present in the remaining samples</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>comm.sub <span class="ot">&lt;-</span> comm.sub[,<span class="fu">apply</span>(comm.sub,<span class="dv">2</span>,sum)<span class="sc">&gt;</span><span class="dv">0</span>]</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co"># what is the dimension of the subset community data set?</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(comm.sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   27 1008</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># subset metadata and taxonomy to match</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>metadata.sub <span class="ot">&lt;-</span> metadata[<span class="fu">rownames</span>(comm.sub),]</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>taxo.sub <span class="ot">&lt;-</span> taxo[<span class="fu">colnames</span>(comm.sub),]</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># descriptive stats for samples and ASVs</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co"># number of sequences per sample</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">rowSums</span>(comm.sub))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># log10 number of sequences per ASV</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">log10</span>(<span class="fu">colSums</span>(comm.sub)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-40-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="pca-on-subset-data" class="level4">
<h4 class="anchored" data-anchor-id="pca-on-subset-data">PCA on subset data</h4>
<p>Before we normalize the data, let’s do the same PCA analysis on Hellinger-transformed ASV abundances, this time only for the samples that remain after getting rid of those with fewer than 5000 sequences/sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>comm.sub.pca <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(<span class="fu">decostand</span>(comm.sub,<span class="st">"hellinger"</span>))</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot ordination results</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiplot</span>(comm.sub.pca, <span class="at">display=</span><span class="st">"sites"</span>, <span class="at">type=</span><span class="st">"text"</span>,<span class="at">cex=</span><span class="fl">0.5</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiellipse</span>(comm.sub.pca, metadata.sub<span class="sc">$</span>StandType, <span class="at">label=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This looks much better, there are no longer negative controls or ‘outlier’ samples that are highly distinct compositionally from the other sampes. We can still clearly see the gradient in composition from boreal-mixed-temperate stand types, which is now falling along the first two axes of the ordination. As mentioned previously, we now need to normalize the data to account for the remaining variation in sequence depth per sample.</p>
</section>
</section>
</section>
<section id="data-normalization-for-diversity-analysis" class="level2">
<h2 class="anchored" data-anchor-id="data-normalization-for-diversity-analysis">Data normalization for diversity analysis</h2>
<p>Data normalization for the analysis of microbiome data is a subject of great debate in the scientific literature. Different normalization approaches have been suggested to control for the compositional nature of microbiome data, to maximize statistical power, to account for variation in sequencing depth among samples, and to meet the assumptions of different statistical analysis methods.</p>
<p>I recommend rarefaction as an essential data normalization approach that is needed when analysing the ecological diversity based on amplicon sequencing data sets. Because samples differ in sequencing depth, and this sequencing depth variation is due to the way we prepare libraries for sequencing and not any biological attribute of samples, we need to control for this variation. Rarefaction involves randomly selecting the same number of sequences per sample so that we can compare diversity metrics among samples.</p>
<p>The simplest justification for rarefaction is that that most measures of diversity are sensitive to sampling intensity. For example, taxa richness increases as we increase the number of individuals we sample from a community. If we take the same community and sample 10 individuals from it, and then sample 1000 individuals, we will obviously find more species when we sample more individuals. This is the fundamental problem that rarefaction addresses - we want to separate variation in diversity caused by some biological process from variation in diversity that is due to variation in library size.</p>
<p>Simulation and empirical studies have shown that rarefaction outperforms other normalization approaches when samples differ in sequencing depth (e.g.&nbsp;Weiss et al.&nbsp;2017. Normalization and microbial differential abundance strategies depend upon data characteristics. Microbiome 5:27. <a href="https://doi.org/10.1186/s40168-017-0237-y">https://doi.org/10.1186/s40168-017-0237-y</a>).</p>
<p>Dr.&nbsp;Pat Schloss has an excellent <a href="https://www.youtube.com/playlist?list=PLmNrK_nkqBpJuhS93PYC-Xr5oqur7IIWf">series of videos on rarefaction</a> as part of his <a href="https://riffomonas.org/">Riffomonas</a> project where he demonstrates very clearly why rarefaction is necessary when calculating diversity from sequencing data sets.</p>
<section id="rarefaction" class="level3">
<h3 class="anchored" data-anchor-id="rarefaction">Rarefaction</h3>
<p>To rarefy our data, we will randomly select the same number of sequences per sample for all of our samples. Because we already excluded samples containing fewer than 4000 sequences, we know that we can rarefy the remaining samples to at least 4000 sequences. Let’s look at the rarefaction curve for our subset of samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What is the smallest number of sequences/sample for subset of samples?</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(<span class="fu">rowSums</span>(comm.sub))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4966</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rarefaction curve for subset of samples</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rarecurve</span>(comm.sub, <span class="at">step=</span><span class="dv">200</span>, <span class="at">label=</span><span class="cn">FALSE</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">8000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that nearly all samples have reached a plateau of ASV richness by around 3000-4000 sequences/sample. The sample with the smallest number of sequences remaining contains 4966 sequences. We will randomly rarefy our data to this number of sequences. This way, we can feel confident that our samples contain enough sequences to adequately quantify the diversity of ASVs present in the sample even after rarefaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomly rarefy samples</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>comm_rarfy <span class="ot">&lt;-</span> <span class="fu">rrarefy</span>(comm.sub, <span class="at">sample =</span> <span class="fu">min</span>(<span class="fu">rowSums</span>(comm.sub)))</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any ASVs whose abundance is 0 after rarefaction</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>comm_rarfy <span class="ot">&lt;-</span> comm_rarfy[,<span class="fu">colSums</span>(comm_rarfy)<span class="sc">&gt;</span><span class="dv">1</span>]</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Match ASV taxonomy to rarefied community</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>taxo_rarfy <span class="ot">&lt;-</span> taxo.sub[<span class="fu">colnames</span>(comm_rarfy),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="check-the-effect-of-rarefaction" class="level4">
<h4 class="anchored" data-anchor-id="check-the-effect-of-rarefaction">Check the effect of rarefaction</h4>
<p>Let’s check to see what effect rarefaction had on the ASV richness of samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rarefaction is not expected to have a major influence on the diversity (as rarefaction curves have reached the plateau).</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>richness_raw <span class="ot">&lt;-</span> <span class="fu">rowSums</span>((comm.sub<span class="sc">&gt;</span><span class="dv">0</span>)<span class="sc">*</span><span class="dv">1</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>richness_rarfy <span class="ot">&lt;-</span> <span class="fu">rowSums</span>((comm_rarfy<span class="sc">&gt;</span><span class="dv">0</span>)<span class="sc">*</span><span class="dv">1</span>)</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(richness_rarfy<span class="sc">~</span>richness_raw,<span class="at">xlab=</span><span class="st">'number of ASVs in raw data'</span>,<span class="at">ylab=</span><span class="st">'number of ASVs in rarefied data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This supports the idea that rarefaction is not expected to have a major influence on diversity, since we saw in the rarefaction curves that richness reaches a plateau below the threshold number of sequences that we used for rarefaction. However, now that we have normalized the number of reads per sample, any differences in diversity among samples are not due to potential differences in library size. We are ready to begin our diversity analyses. We will use the rarefied community data set for these analyses.</p>
</section>
</section>
</section>
<section id="community-analysis" class="level2">
<h2 class="anchored" data-anchor-id="community-analysis">Community analysis</h2>
<p>Before we dive into analysing the diversity of leaf bacterial communities on sugar maples, this is a good time to return to the biological questions we posed in the article from which the data are taken.</p>
<section id="biological-questions" class="level3">
<h3 class="anchored" data-anchor-id="biological-questions">Biological questions</h3>
<p>In the study for which these data were collected, we looked at different taxonomic groups (bacteria, fungi, mycorrhizal fungi) living on sugar maple leaves and roots. Here we will concentrate just on leaf bacteria.</p>
<p>Our aim was to assess the relative influence of host genotype (seed provenance) and environment (transplanted site and region) in structuring the microbiome of sugar maple seedlings. When analyzing the data, let’s keep focused on these biological questions to help guide our decisions about how to analyze the data. We can take different perspectives to respond to this question by looking at different aspects of diversity. And beyond specific tests of our biological hypotheses, it is also useful to carry out basic descriptive analysis of community structure in order to determine what organisms were living in our samples.</p>
<p>In the metadata, the variables StandType and TransplantedSite represent the region and site into which the seedlings were planted (environment), and the variables SeedSourceRegion and SeedSourceOrigin represent the region and site from which the seeds were collected (genotype).</p>
</section>
<section id="visualize-taxonomic-composition-of-communities" class="level3">
<h3 class="anchored" data-anchor-id="visualize-taxonomic-composition-of-communities">Visualize taxonomic composition of communities</h3>
<p>A fundamental question we can address using microbiome data is simply ‘who is there’? What are the abundant taxa in different samples?</p>
<section id="phylum-level-taxonomic-composition-of-samples" class="level4">
<h4 class="anchored" data-anchor-id="phylum-level-taxonomic-composition-of-samples">Phylum-level taxonomic composition of samples</h4>
<p>Remember that for each ASV, we have taxonomic annotations at different ranks. Here we’ll look at the relative abundance of bacterial phyla in each sample. We can repeat these analyses at different taxonomic ranks, but as we go to finer ranks there will be more ASVs with missing data because we could not confidently determine their taxonomic annotation, so there will be more unidentified taxa. Nearly all ASVs have an annotation at the phylum level. We first manipulate the ASV data to create a new data object of phylum abundances, and then we can visualize those abundances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># community data aggregation at a taxonomic level. e.g. phylum </span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># take the sum of each phylum in each sample</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>taxa.agg <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="fu">t</span>(comm_rarfy),<span class="at">by=</span><span class="fu">list</span>(taxo.sub[<span class="fu">colnames</span>(comm_rarfy),<span class="dv">2</span>]),<span class="at">FUN=</span>sum)</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># clean up resulting object</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(taxa.agg) <span class="ot">&lt;-</span> taxa.agg<span class="sc">$</span>Group<span class="fl">.1</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>phylum_data <span class="ot">&lt;-</span> <span class="fu">t</span>(taxa.agg[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co"># convert abundances to relative abundances</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>phylum_data <span class="ot">&lt;-</span> phylum_data<span class="sc">/</span><span class="fu">rowSums</span>(phylum_data)</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co"># remove rare phyla</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>phylum_data <span class="ot">&lt;-</span> phylum_data[,<span class="fu">colSums</span>(phylum_data)<span class="sc">&gt;</span><span class="fl">0.01</span>]</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co"># now reshape phylum data to long format</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>phylum_data <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(phylum_data)</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co"># rename columns</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(phylum_data)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'Samples'</span>,<span class="st">'Bacteria_phylum'</span>)</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="co"># now we can plot phylum relative abundance per sample</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(phylum_data, <span class="fu">aes</span>(Samples, <span class="at">weight =</span> value, <span class="at">fill =</span> Bacteria_phylum)) <span class="sc">+</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">width =</span> .<span class="dv">7</span>, <span class="at">position =</span> <span class="st">'fill'</span>) <span class="sc">+</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">y =</span> <span class="st">'Relative abundance (%)'</span>) <span class="sc">+</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">direction =</span> <span class="sc">-</span>1L) <span class="sc">+</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="phylum-level-composition-for-each-transplant-site" class="level4">
<h4 class="anchored" data-anchor-id="phylum-level-composition-for-each-transplant-site">Phylum-level composition for each transplant site</h4>
<p>It is also useful to see how taxonomic composition varies with respect to different variables we measured. For example, how does phylum-level taxonomic composition differ among different transplant sites?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># aggregate average phylum abundances per transplanted site</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>phylum_data_agg <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(phylum_data<span class="sc">$</span>value,<span class="at">by=</span><span class="fu">list</span>(metadata.sub[phylum_data<span class="sc">$</span>Samples,]<span class="sc">$</span>TransplantedSite,phylum_data<span class="sc">$</span>Bacteria_phylum),<span class="at">FUN=</span>mean)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co"># rename columns</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(phylum_data_agg) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'TransplantedSite'</span>,<span class="st">'Bacteria_phylum'</span>,<span class="st">'value'</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="co"># now we can plot phylum abundance by transplant site</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(phylum_data_agg, <span class="fu">aes</span>(TransplantedSite, <span class="at">weight =</span>value, <span class="at">fill =</span> Bacteria_phylum)) <span class="sc">+</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">width =</span> .<span class="dv">7</span>, <span class="at">position =</span> <span class="st">'fill'</span>) <span class="sc">+</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>( <span class="at">y =</span> <span class="st">'Relative abundance (%)'</span>) <span class="sc">+</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>(<span class="at">direction =</span> <span class="sc">-</span>1L) <span class="sc">+</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="community-diversity-alpha-diversity" class="level3">
<h3 class="anchored" data-anchor-id="community-diversity-alpha-diversity">Community diversity (alpha diversity)</h3>
<p>To look at how diversity differed among samples as a function of the different variables we are interested in, we’ll begin by looking at the alpha-diversity, or within-community diversity. Two commonly used measures of alpha diversity are ASV richness (the number of ASVs present in the sample), and the Shannon index, also sometimes referred to as Shannon diversity or Shannon diversity index, which measures both the number of taxa in the sample (ASV richness) as well as the equitability of their abundances (evenness).</p>
<section id="calculate-asv-richness-and-shannon-diversity-of-bacterial-community" class="level4">
<h4 class="anchored" data-anchor-id="calculate-asv-richness-and-shannon-diversity-of-bacterial-community">Calculate ASV richness and Shannon diversity of bacterial community</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate ASV richness</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate Shannon index</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>Shannon <span class="ot">&lt;-</span> <span class="fu">diversity</span>(comm_rarfy)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(richness_rarfy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(Shannon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-47-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="compare-bacterial-diversity-among-categories" class="level4">
<h4 class="anchored" data-anchor-id="compare-bacterial-diversity-among-categories">Compare bacterial diversity among categories</h4>
<p>We can ask how diversity differs with respect to seedling genotype and environment. Here, let’s ask specifically whether leaf bacterial alpha diversity differs between stand types. See Figure 2 of the article by De Bellis et al.&nbsp;2022 for a comparable analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame to hold alpha diversity values by stand type</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>div_standtype <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">richness=</span>richness_rarfy, <span class="at">Shannon=</span>Shannon, <span class="at">standtype=</span>metadata.sub<span class="sc">$</span>StandType)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set up analysis to compare diversity among different pairs of stand types</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>my_comparisons <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="fu">c</span>(<span class="st">"Mixed"</span>, <span class="st">"Boreal"</span>), <span class="fu">c</span>(<span class="st">"Mixed"</span>, <span class="st">"Temperate"</span>), <span class="fu">c</span>(<span class="st">"Boreal"</span>, <span class="st">"Temperate"</span>) )</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot ASV richness as a function of stand type</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggboxplot</span>(div_standtype, <span class="at">x =</span> <span class="st">"standtype"</span>, <span class="at">y =</span> <span class="st">"richness"</span>, <span class="at">hide.ns=</span>F,</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"standtype"</span>, <span class="at">palette =</span> <span class="st">"jco"</span>,<span class="at">add =</span> <span class="st">"jitter"</span>) <span class="sc">+</span> </span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>(<span class="at">comparisons =</span> my_comparisons,<span class="at">method =</span> <span class="st">"t.test"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot Shannon index as a function of stand type</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggboxplot</span>(div_standtype, <span class="at">x =</span> <span class="st">"standtype"</span>, <span class="at">y =</span> <span class="st">"Shannon"</span>,<span class="at">hide.ns=</span>F,</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"standtype"</span>, <span class="at">palette =</span> <span class="st">"jco"</span>,<span class="at">add =</span> <span class="st">"jitter"</span>)<span class="sc">+</span> </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_compare_means</span>(<span class="at">comparisons =</span> my_comparisons,<span class="at">method =</span> <span class="st">"t.test"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-48-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>These figures indicate that ASV richness does not differ significantly among pairs of stand types. However, the Shannon index does differ somewhat between temperate and boreal stands, where the Shannon index tends to be lower in boreal stands than in temperate stands. These analyses are limited somewhat by the sample size that remains after removing low quality samples; in the original article (De Bellis et al 2022) we compared more sites which increased sample size enough that we found a significant (P&lt;0.05) difference in the Shannon index between temperate and boreal stand types.</p>
</section>
<section id="bacterial-diversity-related-to-numeric-variables" class="level4">
<h4 class="anchored" data-anchor-id="bacterial-diversity-related-to-numeric-variables">Bacterial diversity related to numeric variables</h4>
<p>We can also ask if bacterial diversity differs with respect to numeric variables, for example with respect to latitude. To ask how richness varies with latitude, we will use a generalized linear model to take into account that richness counts are count data and thus are more likely to follow a Poisson distribution than a normal distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot richness versus latitude</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(richness_rarfy<span class="sc">~</span>metadata.sub<span class="sc">$</span>TransplantedSiteLat,<span class="at">xlab=</span><span class="st">'Latitude'</span>,<span class="at">ylab=</span><span class="st">'ASV richness'</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add best fit line</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">glm</span>(richness_rarfy<span class="sc">~</span>metadata.sub<span class="sc">$</span>TransplantedSiteLat), <span class="at">family=</span><span class="st">"poisson"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generalized linear model of richness vs. latitude</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">glm</span>(richness_rarfy<span class="sc">~</span>metadata.sub<span class="sc">$</span>TransplantedSiteLat, <span class="at">family=</span><span class="st">"poisson"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = richness_rarfy ~ metadata.sub$TransplantedSiteLat, 
    family = "poisson")

Deviance Residuals: 
    Min       1Q   Median       3Q      Max  
-8.3234  -2.7974   0.4008   2.0747   8.9199  

Coefficients:
                                 Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                       7.98399    0.59571  13.403  &lt; 2e-16 ***
metadata.sub$TransplantedSiteLat -0.06996    0.01246  -5.615 1.97e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 409.78  on 26  degrees of freedom
Residual deviance: 378.60  on 25  degrees of freedom
AIC: 555.3

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>ASV richness of leaf bacteria decreases with increasing latitude.</p>
<p>What about the Shannon index? Here we’ll fit a linear model since we expect the data to be normally distributed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot Shannon index versus latitude</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Shannon<span class="sc">~</span>metadata.sub<span class="sc">$</span>TransplantedSiteLat,<span class="at">xlab=</span><span class="st">'Latitude'</span>,<span class="at">ylab=</span><span class="st">'Shannon diversity'</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add best fit line</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="fu">lm</span>(Shannon<span class="sc">~</span>metadata.sub<span class="sc">$</span>TransplantedSiteLat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># linear model of Shannon index vs. latitude</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Shannon<span class="sc">~</span>metadata.sub<span class="sc">$</span>TransplantedSiteLat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Shannon ~ metadata.sub$TransplantedSiteLat)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.56982 -0.27830  0.07116  0.35948  1.11564 

Coefficients:
                                 Estimate Std. Error t value Pr(&gt;|t|)  
(Intercept)                        7.8728     3.6067   2.183   0.0387 *
metadata.sub$TransplantedSiteLat  -0.1030     0.0752  -1.370   0.1829  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5839 on 25 degrees of freedom
Multiple R-squared:  0.06983,   Adjusted R-squared:  0.03262 
F-statistic: 1.877 on 1 and 25 DF,  p-value: 0.1829</code></pre>
</div>
</div>
<p>The Shannon index of leaf bacteria decreases with increasing latitude, but the relationship is not statistically significant.</p>
</section>
</section>
<section id="community-composition-beta-diversity" class="level3">
<h3 class="anchored" data-anchor-id="community-composition-beta-diversity">Community composition (beta diversity)</h3>
<p>We can now look at the beta-diversity of the samples, which measures the between-community differences in composition.</p>
<p>Beta diversity approaches to studying composition involve calculating a measure of the compositional difference between pairs of communities (= beta diversity, dissimilarity, or distance). Then these distance metrics can be analysed using approaches such as ordination (to summarize the overall trends in community composition among samples) or PERMANOVA (to test whether groups of samples differ significantly in their composition).</p>
<p>There are a huge number of different beta diversity/dissimilarity metrics that have been used in ecology. There is an ongoing debate about the relative advantages and disadvantages of these beta diversity measures and approaches. There are several different beta diversity metrics and ordination approaches that work well based on simulation studies and empirical analysis. For those wanting to learn more about multivariate analysis and beta diversity approaches for the analysis of ecological communities, the book <a href="http://adn.biol.umontreal.ca/~numericalecology/numecolR/">“Numerical Ecology with R”</a> by Borcard, Gillet and Legendre is an excellent reference. Dr.&nbsp;Pierre Legendre also maintains a <a href="http://adn.biol.umontreal.ca/~numericalecology/documents_enseignement/index.html">website</a> with links to several <a href="http://adn.biol.umontreal.ca/~numericalecology/Trieste16/">excellent courses</a> that serve as a complete introduction to multivariate methods in ecology.</p>
<p>In this workshop we will focus on a few different beta diversity metrics and ordination approaches that have been shown to perform well in theory and practise when applied to ecological community data. How should you choose which of these approaches to your own data? This is not an easy question to answer, as long as you are using a method that works well with ecological community data, there are different reasons to prefer one method over another. Ultimately, it can be useful to try different approaches and see if you obtain similar results with your data.</p>
<section id="ordination---principal-components-analysis-pca" class="level4">
<h4 class="anchored" data-anchor-id="ordination---principal-components-analysis-pca">Ordination - Principal Components Analysis (PCA)</h4>
<p>Principal components analysis (PCA) is a commonly used approach to analysing multivariate data. PCA uses eigenanalysis of Euclidean distances among samples computed from ASV abundance data to identify the axes of correlated variation that explain the most possible variation in your multivariate data. These axes correspond to major gradients of changes in community composition. We typically focus on the first few axes of the PCA ordination, since these axes should capture the majority of the variation in community composition among samples.</p>
<p>It’s important to note that PCA should never be used to analyze untranformed ecological community data. PCA is based on the Euclidean distance among samples. Ecological community data violate many of the assumptions of PCA - recall that there are many zeroes in our matrix of ASV abundances, and the distribution of abundance values among ASVs is very non-normal. <a href="http://adn.biol.umontreal.ca/~numericalecology/Reprints/Legendre_&amp;_Gallagher.pdf">Legendre and Gallagher (2001)</a> showed that several transformations including the Chord and Hellinger transformation allow ecological community data matrices to be analyzed using PCA. Here we will use the Hellinger transformation to transform ASV abundances prior to analyzing them with a PCA ordination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Hellinger-transformed version of rarefied community data</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>comm_hel <span class="ot">&lt;-</span> <span class="fu">decostand</span>(comm_rarfy,<span class="at">method=</span><span class="st">'hellinger'</span>)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA analysis of Hellinger-transformed community data</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>comm_hel_PCA <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(comm_hel)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize variance in beta diversity explained by PCA axes</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(comm_hel_PCA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Importance of components:
                          PC1     PC2     PC3    PC4     PC5     PC6     PC7
Standard deviation     0.2599 0.20969 0.19519 0.1718 0.16095 0.15289 0.14424
Proportion of Variance 0.1497 0.09746 0.08445 0.0654 0.05742 0.05181 0.04612
Cumulative Proportion  0.1497 0.24712 0.33157 0.3970 0.45439 0.50620 0.55232
                           PC8    PC9    PC10    PC11    PC12    PC13    PC14
Standard deviation     0.13835 0.1327 0.12813 0.12268 0.12067 0.11446 0.11003
Proportion of Variance 0.04242 0.0390 0.03639 0.03336 0.03228 0.02904 0.02684
Cumulative Proportion  0.59474 0.6338 0.67014 0.70350 0.73577 0.76481 0.79165
                          PC15    PC16    PC17    PC18    PC19    PC20    PC21
Standard deviation     0.10440 0.10234 0.09813 0.09351 0.09258 0.09083 0.08976
Proportion of Variance 0.02416 0.02321 0.02134 0.01938 0.01900 0.01829 0.01786
Cumulative Proportion  0.81581 0.83902 0.86037 0.87975 0.89875 0.91704 0.93490
                          PC22    PC23    PC24    PC25    PC26      PC27
Standard deviation     0.08279 0.08176 0.07641 0.07181 0.06955 2.431e-16
Proportion of Variance 0.01519 0.01482 0.01294 0.01143 0.01072 0.000e+00
Cumulative Proportion  0.95009 0.96491 0.97785 0.98928 1.00000 1.000e+00</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot PCA results</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiplot</span>(comm_hel_PCA, <span class="at">display =</span> <span class="st">'sites'</span>, <span class="at">type =</span> <span class="st">'text'</span>,<span class="at">cex=</span><span class="fl">0.8</span>, <span class="at">main=</span><span class="st">"PCA on Hellinger transformed data"</span>)</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ellipses around samples from different stand types</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiellipse</span>(comm_hel_PCA, metadata.sub<span class="sc">$</span>StandType, <span class="at">label=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The PCA ordination diagram indicates the overall compositional similarity of samples. Samples that are close together in the ordination space contain similar ASVs with similar abundances. We can see that the gradient in community composition among different stand types is visible along the first two axes. Samples from each stand type tend to contain compositionally similar leaf bacterial communities.</p>
<p>Recall that when we were first looking at the composition of communities in our samples (prior to subsetting and rarefaction), we obtained a similar looking result. As noted, because we used a rarefaction threshold that was sufficient for the rarefaction curves of the samples to reach a plateau in ASV richness, we do not expect major differences between the analysis of rarefied versus non-rarefied data. However, by analyzing the rarefied data we are now confident that the differences in composition among the samples are due to true differences in community composition and not due to differences in library size among samples.</p>
</section>
<section id="ordination---non-metric-multidimensional-scaling-nmds" class="level4">
<h4 class="anchored" data-anchor-id="ordination---non-metric-multidimensional-scaling-nmds">Ordination - Non-metric Multidimensional Scaling (NMDS)</h4>
<p>Another commonly used ordination approach in ecology is non-metric multidimensional scaling (NMDS). NMDS can be used with any beta diversity distance metric. Unlike PCA, NMDS is not based on eigenanalysis of the distance metric. Rather, NMDS uses an algorithm to find an ordination of samples in a few dimensions that represents as best as possible the rank transformed pairwise distances among samples measured with the original distance metric. When carrying out a NMDS analysis, rather than obtaining many PCA axes, the user specifies how many axes to identify. NMDS analysis is based on a heuristic algorithm that may give slightly different results when run multiple times on the same data, whereas PCA has a unique analytical solution.</p>
<p>NMDS can be used with any distance metric. Commonly in microbial ecology it is used with the Bray-Curtis distance. The Bray-Curtis distance, like the Hellinger distance, has been shown to perform well compared with other distance measures (<a href="https://link.springer.com/article/10.1007/BF00038687">Faith et al.&nbsp;1987</a>, Gallagher and Legendre 2001).</p>
<p>Here we’ll calculate a NMDS ordination using Bray-Curtis distance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NMDS ordination based on Bray-Curtis distances</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>comm_NMDS <span class="ot">&lt;-</span> <span class="fu">metaMDS</span>(comm_hel, <span class="at">distance=</span><span class="st">"bray"</span>, <span class="at">trace=</span><span class="cn">FALSE</span>)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiplot</span>(comm_NMDS, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">type =</span> <span class="st">'text'</span>, <span class="at">display=</span><span class="st">'sites'</span>)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ordiellipse</span>(comm_NMDS, metadata.sub<span class="sc">$</span>StandType, <span class="at">label=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co"># overlay the direction of latitude effect on bacteria community composition</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>ef <span class="ot">&lt;-</span> <span class="fu">envfit</span>(comm_NMDS, metadata.sub<span class="sc">$</span>TransplantedSiteLat)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ef<span class="sc">$</span>vectors<span class="sc">$</span>arrows)<span class="ot">=</span><span class="st">'Latitude'</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we can see that the NMDS ordination based on Bray-Curtis distances among samples looks quite similar to the PCA ordination, with community composition differing among different stand types. We have also added an arrow indicating the correlation between latitude and the ordination axes, which also supports the idea that communities vary as we move from boreal stands in the north to temperate stands in the south.</p>
</section>
<section id="permanova" class="level4">
<h4 class="anchored" data-anchor-id="permanova">PERMANOVA</h4>
<p>Ordination analyses allow us to visualize how the composition of communities differs among samples and how it relates to different variables in a qualitative way. For example, we can see from the ordination diagrams above that it seems that community composition differs among stand types. We can statistically test whether stand types differ in composition using permutational multivariate analysis of variance (PERMANOVA). A PERMANOVA works in a way similar to an ANOVA, but with multivariate compositional data. PERMANOVA tests indicate whether community composition (beta diversity) differs among groups of samples.</p>
<p>Here we can first use a PERMANOVA to test whether community composition differs among stand types. As with ordination methods, a PERMANOVA can be run on any distance metric. Let’s try computing a PERMANOVA using both Hellinger distance (used for the PCA) and Bray-Curtis distance (used for the NMDS).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set number of permutations for PERMANOVA</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>perm <span class="ot">&lt;-</span> <span class="fu">how</span>(<span class="at">nperm =</span> <span class="dv">999</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co"># PERMANOVA on Hellinger-transformed Euclidean distances</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="fu">adonis2</span>(<span class="at">formula =</span> <span class="fu">dist</span>(comm_hel) <span class="sc">~</span> StandType, <span class="at">data =</span> metadata.sub, <span class="at">permutations =</span> perm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

adonis2(formula = dist(comm_hel) ~ StandType, data = metadata.sub, permutations = perm)
          Df SumOfSqs      R2      F Pr(&gt;F)    
StandType  2   1.8390 0.15678 2.2311  0.001 ***
Residual  24   9.8911 0.84322                  
Total     26  11.7301 1.00000                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PERMANOVA on Bray-Curtis distances</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">adonis2</span>(<span class="at">formula =</span> <span class="fu">vegdist</span>(comm_rarfy, <span class="at">method=</span><span class="st">"bray"</span>) <span class="sc">~</span> StandType, <span class="at">data =</span> metadata.sub, <span class="at">permutations =</span> perm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

adonis2(formula = vegdist(comm_rarfy, method = "bray") ~ StandType, data = metadata.sub, permutations = perm)
          Df SumOfSqs      R2      F Pr(&gt;F)    
StandType  2   0.9716 0.17856 2.6085  0.001 ***
Residual  24   4.4697 0.82144                  
Total     26   5.4413 1.00000                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Both of these analyses indicate that community composition differs significantly among stand types, explaining around 16-18% of variation in the distance metric.</p>
<p>PERMANOVA can also be used to test more complex experimental designs. Here, let’s replicate the analyses by De Bellis et al.&nbsp;(2022). We used PERMANOVA on Bray-Curtis distances to measure the relative importance of transplanted region and site (environment) versus origin region and site (genotype) in determining the composition of leaf bacterial communities. Site is nested within region for both variable types, which we represent using “/” in the formula (region/site).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>permanova.bc <span class="ot">&lt;-</span> <span class="fu">adonis2</span>(<span class="at">formula =</span> <span class="fu">vegdist</span>(comm_rarfy, <span class="at">method=</span><span class="st">"bray"</span>) <span class="sc">~</span> StandType<span class="sc">/</span>TransplantedSite <span class="sc">*</span> SeedSourceRegion<span class="sc">/</span>SeedSourceOrigin, <span class="at">data =</span> metadata.sub, <span class="at">permutations =</span> perm)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(permanova.bc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Permutation test for adonis under reduced model
Terms added sequentially (first to last)
Permutation: free
Number of permutations: 999

adonis2(formula = vegdist(comm_rarfy, method = "bray") ~ StandType/TransplantedSite * SeedSourceRegion/SeedSourceOrigin, data = metadata.sub, permutations = perm)
                                                             Df SumOfSqs
StandType                                                     2   0.9716
SeedSourceRegion                                              2   0.2277
StandType:TransplantedSite                                    3   0.6410
StandType:SeedSourceRegion                                    3   0.5562
StandType:TransplantedSite:SeedSourceRegion                   3   0.7350
StandType:TransplantedSite:SeedSourceRegion:SeedSourceOrigin  5   1.1043
Residual                                                      8   1.2056
Total                                                        26   5.4413
                                                                  R2      F
StandType                                                    0.17856 3.2236
SeedSourceRegion                                             0.04184 0.7554
StandType:TransplantedSite                                   0.11780 1.4177
StandType:SeedSourceRegion                                   0.10222 1.2302
StandType:TransplantedSite:SeedSourceRegion                  0.13507 1.6256
StandType:TransplantedSite:SeedSourceRegion:SeedSourceOrigin 0.20294 1.4654
Residual                                                     0.22157       
Total                                                        1.00000       
                                                             Pr(&gt;F)    
StandType                                                     0.001 ***
SeedSourceRegion                                              0.835    
StandType:TransplantedSite                                    0.058 .  
StandType:SeedSourceRegion                                    0.191    
StandType:TransplantedSite:SeedSourceRegion                   0.019 *  
StandType:TransplantedSite:SeedSourceRegion:SeedSourceOrigin  0.031 *  
Residual                                                               
Total                                                                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>This analysis shows that, as mentioned by De Bellis et al.&nbsp;(2022), stand type of planting was the most important variable explaining variation in leaf bacterial community composition. There was a marginally significant variation among transplanted sites. There were also significant interactions among transplant region and site as a function of seed source region and seed source site of origin, indicating that the leaf bacterial communities of some genotypes respond differently to different environments. Taken together, this analysis indicates that environment (transplant region and site) have a greater impact on the composition of leaf bacterial communities than genotype, although there is also an interaction between genotype and environment.</p>
</section>
</section>
<section id="differentially-abundant-taxa" class="level3">
<h3 class="anchored" data-anchor-id="differentially-abundant-taxa">Differentially abundant taxa</h3>
<p>By analyzing alpha and beta diversity, we have determined that some groups of samples differ in their diversity and composition. But measures of diversity look at the entire community. We may also be interested in knowing which individual taxa differ in abundance among groups of samples. To address this question we can use differential abundance analysis. There are many methods that can be used for differential abundance analysis, and as for other ecological analysis there is active debate about which methods should be used to detect differences in taxa abundances between groups of samples.</p>
<p>Differential abundance analysis allows you to identify differentially abundant taxa between two groups. There are many methods for this type of analysis such as ALDEx2, ANCOM-BC, and DESeq2. Several recent articles have compared the performance of these differential abundance approaches when applied to microbiome data (<a href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-020-02104-1">Calgaro et al.&nbsp;(2020)</a>, <a href="https://www.nature.com/articles/s41467-022-28034-z">Nearing et al.&nbsp;(2022)</a>), finding that some methods perform better than others, but also finding that different methods are sensitive to different aspects of data structure and with differing statistical power and sensitivity. Here we will compare two different methods for detecting differentially abundant taxa.</p>
<p>Having seen a clear difference in leaf bacterial community composition between temperate and boreal forest stand types, we may ask which bacterial ASVs are differentially abundant between temperate versus boreal forest stand types.</p>
<section id="deseq2" class="level4">
<h4 class="anchored" data-anchor-id="deseq2">DESeq2</h4>
<p>The DESeq2 approach (<a href="https://doi.org/10.1186/s13059-014-0550-8">Love et al.&nbsp;2014. Genome Biol 15:550</a>) models taxa abundances using a negative binomial distribution to detect taxa that are differentially abundant between groups. This approach was initially developed for gene expression analyses, but it is commonly used in the analysis of differential taxa abundances in microbial ecology.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># conduct DESeq analysis of ASV abundances between temperate and boreal stand types</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We add a pseudocount (+1) to each abundance value to avoid zeroes</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>countdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ASV=</span><span class="fu">colnames</span>(comm_rarfy),<span class="fu">t</span>(comm_rarfy<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>metas <span class="ot">&lt;-</span> metadata.sub</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>metas<span class="sc">$</span>StandType <span class="ot">&lt;-</span> <span class="fu">relevel</span>(<span class="fu">as.factor</span>(metas<span class="sc">$</span>StandType),<span class="at">ref=</span><span class="st">'Boreal'</span>)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>dds <span class="ot">&lt;-</span> <span class="fu">DESeqDataSetFromMatrix</span>(<span class="at">countData=</span>countdata, </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colData=</span>metas,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design=</span><span class="sc">~</span>StandType, <span class="at">tidy =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>converting counts to integer mode</code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dds2 <span class="ot">&lt;-</span> <span class="fu">DESeq</span>(dds, <span class="at">fitType=</span><span class="st">"local"</span>, <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">results</span>(dds2, <span class="at">name=</span><span class="st">"StandType_Temperate_vs_Boreal"</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co">#coef of differently abundant ASV between temperate and boreal forest</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res[<span class="fu">order</span>(res<span class="sc">$</span>padj),])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log2 fold change (MLE): StandType Temperate vs Boreal 
Wald test p-value: StandType Temperate vs Boreal 
DataFrame with 6 rows and 6 columns
        baseMean log2FoldChange     lfcSE      stat      pvalue        padj
       &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
ASV_8  102.71993        6.31596  1.070810   5.89830 3.67260e-09 1.31686e-06
ASV_37  16.25372        5.24749  0.906315   5.78992 7.04201e-09 1.31686e-06
ASV_94   8.43527        4.85485  0.860202   5.64385 1.66291e-08 2.07309e-06
ASV_26  29.32340        5.88306  1.086821   5.41309 6.19468e-08 5.79203e-06
ASV_22  36.19921        5.19054  0.994117   5.22126 1.77713e-07 1.32929e-05
ASV_44  20.59886       -5.09305  1.001330  -5.08629 3.65139e-07 2.27603e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Number of significantly different ASVs (adjusted_p_value&lt;0.05)</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(res[<span class="fu">is.na</span>(res<span class="sc">$</span>padj)<span class="sc">==</span>F<span class="sc">&amp;</span>res<span class="sc">$</span>padj<span class="sc">&lt;</span><span class="fl">0.05</span>,])[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 77</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>sig_des <span class="ot">&lt;-</span> <span class="fu">rownames</span>(res[<span class="fu">is.na</span>(res<span class="sc">$</span>padj)<span class="sc">==</span>F<span class="sc">&amp;</span>res<span class="sc">$</span>padj<span class="sc">&lt;</span><span class="fl">0.05</span>,])</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co"># show the distribution of these marker ASV in a heatmap</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>metatoshow <span class="ot">&lt;-</span> <span class="fu">subset</span>(metas,<span class="sc">!</span>metas<span class="sc">$</span>StandType<span class="sc">%in%</span><span class="st">'Mixed'</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>datatoshow <span class="ot">&lt;-</span> comm_rarfy[<span class="fu">rownames</span>(metatoshow),<span class="fu">rownames</span>(res[<span class="fu">order</span>(res<span class="sc">$</span>padj),])[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>]]</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>annotation_col <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">standtype =</span> <span class="fu">as.factor</span>(metatoshow<span class="sc">$</span>StandType))</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(annotation_col)<span class="ot">=</span><span class="fu">rownames</span>(datatoshow)</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">t</span>(datatoshow),<span class="at">scale=</span> <span class="st">"row"</span>, <span class="at">annotation_col =</span> annotation_col,<span class="at">cluster_cols =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="ancom-bc" class="level4">
<h4 class="anchored" data-anchor-id="ancom-bc">ANCOM-BC</h4>
<p>The ANCOM-BC approach (<a href="https://www.nature.com/articles/s41467-020-17041-7">Lin and Peddada. 2020. Nat. Comm. 35:14</a>) detects differentially abundant taxa by analysis of compositions of microbiomes with bias correction. <a href="https://www.nature.com/articles/s41467-022-28034-z">Nearing et al.&nbsp;(2022)</a> found this method to be among the best-performing methods for detection of differentially abundant taxa.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># conduct ANCOM-BC analysis of differentially abundant taxa between boreal/temperate stand types</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>ASV <span class="ot">&lt;-</span> <span class="fu">otu_table</span>(countdata[,<span class="sc">-</span><span class="dv">1</span>],taxa_are_rows<span class="ot">&lt;-</span>T)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>TAX <span class="ot">&lt;-</span> <span class="fu">tax_table</span>(<span class="fu">as.matrix</span>(taxo.sub))</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>META <span class="ot">&lt;-</span> <span class="fu">sample_data</span>(metas)</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>phyloseqobj <span class="ot">=</span> <span class="fu">phyloseq</span>(ASV, TAX, META)</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>ancob <span class="ot">&lt;-</span> <span class="fu">ancombc</span>(<span class="at">phyloseq=</span>phyloseqobj,<span class="at">formula=</span><span class="st">'StandType'</span>,<span class="at">p_adj_method =</span> <span class="st">"holm"</span>, <span class="at">zero_cut =</span> <span class="fl">0.90</span>, <span class="at">lib_cut =</span> <span class="dv">1000</span>,</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">group =</span> <span class="st">'StandType'</span>, <span class="at">struc_zero =</span> <span class="cn">TRUE</span>, <span class="at">neg_lb =</span> F,</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">tol =</span> <span class="fl">1e-5</span>, <span class="at">max_iter =</span> <span class="dv">100</span>, <span class="at">conserve =</span> <span class="cn">TRUE</span>,</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="at">global =</span> <span class="cn">TRUE</span>)</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>res_ancob <span class="ot">&lt;-</span> ancob<span class="sc">$</span>res</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a><span class="co">#show coefficients of differential abundance test between temperate vs. boreal</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>coef_ancob <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beta=</span>res_ancob<span class="sc">$</span>beta<span class="sc">$</span>StandTypeTemperate,<span class="at">se=</span>res_ancob<span class="sc">$</span>se<span class="sc">$</span>StandTypeTemperate,<span class="at">W=</span>res_ancob<span class="sc">$</span>W<span class="sc">$</span>StandTypeTemperate,</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">p_val=</span>res_ancob<span class="sc">$</span>p_val<span class="sc">$</span>StandTypeTemperate,<span class="at">p_adj=</span>res_ancob<span class="sc">$</span>q_val<span class="sc">$</span>StandTypeTemperate,<span class="at">sign_dif=</span>res_ancob<span class="sc">$</span>diff_abn<span class="sc">$</span>StandTypeTemperate,</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">row.names =</span> <span class="fu">rownames</span>(res_ancob<span class="sc">$</span>beta))</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>coef_ancob <span class="ot">&lt;-</span> coef_ancob[<span class="fu">order</span>(coef_ancob<span class="sc">$</span>p_adj),]</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coef_ancob)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              beta        se         W        p_val        p_adj sign_dif
ASV_44  -2.2721929 0.4081187 -5.567481 2.584489e-08 2.101189e-05     TRUE
ASV_22   2.5469174 0.5179469  4.917333 8.773119e-07 7.123773e-04     TRUE
ASV_11   2.2662741 0.4980824  4.549998 5.364645e-06 4.350727e-03     TRUE
ASV_101 -1.8558870 0.4108073 -4.517658 6.252726e-06 5.064708e-03     TRUE
ASV_37   2.3964439 0.5694741  4.208170 2.574473e-05 2.082749e-02     TRUE
ASV_129  0.4651886 0.1182296  3.934619 8.332862e-05 6.732952e-02    FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Number of significantly different ASVs (adjusted p_value&lt;0.05)</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(coef_ancob[coef_ancob<span class="sc">$</span>p_adj<span class="sc">&lt;</span><span class="fl">0.05</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>sig_ancob <span class="ot">&lt;-</span> <span class="fu">rownames</span>(coef_ancob[<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(coef_ancob[coef_ancob<span class="sc">$</span>p_adj<span class="sc">&lt;</span><span class="fl">0.05</span>,])[<span class="dv">1</span>],])</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># show the significant ASVs</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>metatoshow <span class="ot">&lt;-</span> <span class="fu">subset</span>(metas,<span class="sc">!</span>metas<span class="sc">$</span>StandType<span class="sc">%in%</span><span class="st">'Mixed'</span>)</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>datatoshow <span class="ot">&lt;-</span> comm_rarfy[<span class="fu">rownames</span>(metatoshow),sig_ancob]</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>annotation_col <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">standtype =</span> <span class="fu">as.factor</span>(metatoshow<span class="sc">$</span>StandType))</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(annotation_col)<span class="ot">=</span><span class="fu">rownames</span>(datatoshow)</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">t</span>(datatoshow),<span class="at">scale=</span> <span class="st">"row"</span>, <span class="at">annotation_col =</span> annotation_col,<span class="at">cluster_cols =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="comparing-differentially-abundant-taxa-among-methods" class="level4">
<h4 class="anchored" data-anchor-id="comparing-differentially-abundant-taxa-among-methods">Comparing differentially abundant taxa among methods</h4>
<p>In a comparison between boreal and temperate forest stand types, ANCOM-BC and DESeq2 detected different numbers of differentially abundant ASVs. As noted earlier, there is still debate about which methods perform best for differentially abundant taxa detection. While DESeq2 and ANCOM identified differentially abundant taxa that are potentially unique to each method, there may be some ASVs that were detected as differentially abundant using both methods. This type of cross-method comparison can help us to identify statistically robust results - if taxa are differentially abundant enough to be detected by multiple methods, they should differ strongly in their abundance between groups. Let’s look at the distribution of these differentially abundant ASVs identified by both methods.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># identify significantly differentially abundant ASVs according to both methods</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>sig_both <span class="ot">&lt;-</span> sig_des[sig_des<span class="sc">%in%</span>sig_ancob]</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>sig_both</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ASV_11"  "ASV_22"  "ASV_37"  "ASV_44"  "ASV_101"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show the distribution of these differentially abundant ASVs</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>metatoshow <span class="ot">&lt;-</span> <span class="fu">subset</span>(metas,<span class="sc">!</span>metas<span class="sc">$</span>StandType<span class="sc">%in%</span><span class="st">'Mixed'</span>)</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>datatoshow <span class="ot">&lt;-</span> comm_rarfy[<span class="fu">rownames</span>(metatoshow),sig_both]</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>annotation_col <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">standtype =</span> <span class="fu">as.factor</span>(metatoshow<span class="sc">$</span>StandType))</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(annotation_col)<span class="ot">=</span><span class="fu">rownames</span>(datatoshow)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">t</span>(datatoshow),<span class="at">scale=</span> <span class="st">"row"</span>, <span class="at">annotation_col =</span> annotation_col,<span class="at">cluster_cols =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also inspect the taxonomic annotations of these differentially abundant ASVs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>taxo_rarfy[sig_both,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Kingdom    Phylum           Class                 Order             
ASV_11  "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Rhizobiales"     
ASV_22  "Bacteria" "Bacteroidota"   "Bacteroidia"         "Cytophagales"    
ASV_37  "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Sphingomonadales"
ASV_44  "Bacteria" "Proteobacteria" "Gammaproteobacteria" "Enterobacterales"
ASV_101 "Bacteria" "Proteobacteria" "Alphaproteobacteria" "Rhizobiales"     
        Family              Genus                            Species         
ASV_11  "Beijerinckiaceae"  "Methylobacterium-Methylorubrum" NA              
ASV_22  "Hymenobacteraceae" "Hymenobacter"                   NA              
ASV_37  "Sphingomonadaceae" "Sphingomonas"                   NA              
ASV_44  "Shewanellaceae"    "Shewanella"                     "algae/haliotis"
ASV_101 "Beijerinckiaceae"  "Methylocella"                   NA              </code></pre>
</div>
</div>
</section>
</section>
<section id="final-steps---clean-up-and-save-data-objects-and-workspace-1" class="level3">
<h3 class="anchored" data-anchor-id="final-steps---clean-up-and-save-data-objects-and-workspace-1">Final steps - clean up and save data objects and workspace</h3>
<p>We have now completed our ecological analyses of leaf bacterial communities. You may want to save the R workspace containing all the different data objects so that you can reload it in the future without having to re-run the analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Save entire R workspace to file</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save.image</span>(<span class="st">"Microbiome-ecological-analysis-workspace.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>