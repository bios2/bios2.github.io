<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Spatial Statistics in Ecology, Part 4</title>

  <meta property="description" itemprop="description" content="Introduction to spatial statistics offered by Philippe Marchand to BIOS2 Fellows in January 2021. In the previous parts, we saw how to account for spatial dependence in linear regression models with either geostatistical models (also called Gaussian processes) or spatial autocorrelation models (CAR/SAR). In this last part, we will see how to combine these features with more complex regression models, in particular generalized linear mixed models (GLMM)."/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-01-21"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-01-21"/>
  <meta name="article:author" content="Philippe Marchand"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Spatial Statistics in Ecology, Part 4"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Introduction to spatial statistics offered by Philippe Marchand to BIOS2 Fellows in January 2021. In the previous parts, we saw how to account for spatial dependence in linear regression models with either geostatistical models (also called Gaussian processes) or spatial autocorrelation models (CAR/SAR). In this last part, we will see how to combine these features with more complex regression models, in particular generalized linear mixed models (GLMM)."/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Spatial Statistics in Ecology, Part 4"/>
  <meta property="twitter:description" content="Introduction to spatial statistics offered by Philippe Marchand to BIOS2 Fellows in January 2021. In the previous parts, we saw how to account for spatial dependence in linear regression models with either geostatistical models (also called Gaussian processes) or spatial autocorrelation models (CAR/SAR). In this last part, we will see how to combine these features with more complex regression models, in particular generalized linear mixed models (GLMM)."/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","categories","date","output"]}},"value":[{"type":"character","attributes":{},"value":["Spatial Statistics in Ecology, Part 4"]},{"type":"character","attributes":{},"value":["Introduction to spatial statistics offered by Philippe Marchand to BIOS2 Fellows in January 2021. In the previous parts, we saw how to account for spatial dependence in linear regression models with either geostatistical models (also called Gaussian processes) or spatial autocorrelation models (CAR/SAR). In this last part, we will see how to combine these features with more complex regression models, in particular generalized linear mixed models (GLMM).\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation"]}},"value":[{"type":"character","attributes":{},"value":["Philippe Marchand"]},{"type":"character","attributes":{},"value":["Université du Québec en Abitibi-Témiscamingue"]}]}]},{"type":"character","attributes":{},"value":["Technical","English"]},{"type":"character","attributes":{},"value":["01-21-2021"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","toc_float"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"logical","attributes":{},"value":[true]}]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["data/gambia_pred.csv","data/gambia.csv","data/rls_covid.dbf","data/rls_covid.prj","data/rls_covid.shp","data/rls_covid.shx","spatial-statistics-in-ecology-part-4_files/anchor-4.2.2/anchor.min.js","spatial-statistics-in-ecology-part-4_files/bowser-1.9.3/bowser.min.js","spatial-statistics-in-ecology-part-4_files/distill-2.2.21/template.v2.js","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-14-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-14-2.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-15-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-17-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-18-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-22-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-23-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-3-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-8-1.png","spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-9-1.png","spatial-statistics-in-ecology-part-4_files/header-attrs-2.7/header-attrs.js","spatial-statistics-in-ecology-part-4_files/jquery-1.11.3/jquery.min.js","spatial-statistics-in-ecology-part-4_files/popper-2.6.0/popper.min.js","spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy-bundle.umd.min.js","spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy-light-border.css","spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy.css","spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy.umd.min.js","spatial-statistics-in-ecology-part-4_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="spatial-statistics-in-ecology-part-4_files/header-attrs-2.7/header-attrs.js"></script>
  <script src="spatial-statistics-in-ecology-part-4_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="spatial-statistics-in-ecology-part-4_files/popper-2.6.0/popper.min.js"></script>
  <link href="spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="spatial-statistics-in-ecology-part-4_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="spatial-statistics-in-ecology-part-4_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="spatial-statistics-in-ecology-part-4_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="spatial-statistics-in-ecology-part-4_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="spatial-statistics-in-ecology-part-4_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Spatial Statistics in Ecology, Part 4","description":"Introduction to spatial statistics offered by Philippe Marchand to BIOS2 Fellows in January 2021. In the previous parts, we saw how to account for spatial dependence in linear regression models with either geostatistical models (also called Gaussian processes) or spatial autocorrelation models (CAR/SAR). In this last part, we will see how to combine these features with more complex regression models, in particular generalized linear mixed models (GLMM).","authors":[{"author":"Philippe Marchand","authorURL":"#","affiliation":"Université du Québec en Abitibi-Témiscamingue","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-01-21T00:00:00.000+00:00","citationText":"Marchand, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Spatial Statistics in Ecology, Part 4</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt=tag">Technical</div>
<div class="dt=tag">English</div>
</div>
<!--/radix_placeholder_categories-->
<p><p>Introduction to spatial statistics offered by Philippe Marchand to BIOS2 Fellows in January 2021. In the previous parts, we saw how to account for spatial dependence in linear regression models with either geostatistical models (also called Gaussian processes) or spatial autocorrelation models (CAR/SAR). In this last part, we will see how to combine these features with more complex regression models, in particular generalized linear mixed models (GLMM).</p></p>
</div>

<div class="d-byline">
  Philippe Marchand  (Université du Québec en Abitibi-Témiscamingue)
  
<br/>01-21-2021
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#glmm-with-spatial-gaussian-process">GLMM with spatial Gaussian process</a>
<ul>
<li><a href="#data">Data</a></li>
<li><a href="#non-spatial-glmm">Non-spatial GLMM</a></li>
<li><a href="#spatial-glmm-with-spamm">Spatial GLMM with spaMM</a></li>
<li><a href="#gaussian-process-models-vs.-smoothing-splines">Gaussian process models vs. smoothing splines</a></li>
<li><a href="#bayesian-methods-for-glmms-with-gaussian-processes">Bayesian methods for GLMMs with Gaussian processes</a></li>
</ul></li>
<li><a href="#glmm-with-spatial-autoregression">GLMM with spatial autoregression</a></li>
<li><a href="#reference">Reference</a></li>
</ul>
</nav>
</div>
<h1 id="glmm-with-spatial-gaussian-process">GLMM with spatial Gaussian process</h1>
<h2 id="data">Data</h2>
<p>The <code>gambia</code> dataset found in the <em>geoR</em> package presents the results of a study of malaria prevalence among children of 65 villages in The Gambia. We will use a slightly transformed version of the data found in the file <a href="data/gambia.csv">gambia.csv</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://www.leg.ufpr.br/geoR'>geoR</a></span><span class='op'>)</span>

<span class='va'>gambia</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/utils/read.table.html'>read.csv</a></span><span class='op'>(</span><span class='st'>"data/gambia.csv"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/geoR/man/head.html'>head</a></span><span class='op'>(</span><span class='va'>gambia</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  id_village        x        y pos  age netuse treated green phc
1          1 349.6313 1458.055   1 1783      0       0 40.85   1
2          1 349.6313 1458.055   0  404      1       0 40.85   1
3          1 349.6313 1458.055   0  452      1       0 40.85   1
4          1 349.6313 1458.055   1  566      1       0 40.85   1
5          1 349.6313 1458.055   0  598      1       0 40.85   1
6          1 349.6313 1458.055   1  590      1       0 40.85   1</code></pre>
</div>
<p>Here are the fields in that dataset:</p>
<ul>
<li><em>id_village</em>: Identifier of the village.</li>
<li><em>x</em> and <em>y</em>: Spatial coordinates of the village (in kilometers, based on UTM coordinates).</li>
<li><em>pos</em>: Binary response, whether the child tested positive for malaria.</li>
<li><em>age</em>: Age of the child in days.</li>
<li><em>netuse</em>: Whether or not the child sleeps under a bed net.</li>
<li><em>treated</em>: Whether or not the bed net is treated.</li>
<li><em>green</em>: Remote sensing based measure of greenness of vegetation (measured at the village level).</li>
<li><em>phc</em>: Presence or absence of a public health centre for the village.</li>
</ul>
<p>We can count the number of positive cases and total children tested by village to map the fraction of positive cases (or prevalence, <em>prev</em>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Create village-level dataset</span>
<span class='va'>gambia_agg</span> <span class='op'>&lt;-</span> <span class='fu'>group_by</span><span class='op'>(</span><span class='va'>gambia</span>, <span class='va'>id_village</span>, <span class='va'>x</span>, <span class='va'>y</span>, <span class='va'>green</span>, <span class='va'>phc</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>summarize</span><span class='op'>(</span>pos <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='va'>pos</span><span class='op'>)</span>, total <span class='op'>=</span> <span class='fu'>n</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>prev <span class='op'>=</span> <span class='va'>pos</span> <span class='op'>/</span> <span class='va'>total</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/geoR/man/head.html'>head</a></span><span class='op'>(</span><span class='va'>gambia_agg</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 6 x 8
  id_village     x     y green   phc   pos total  prev
       &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
1          1  350. 1458.  40.8     1    17    33 0.515
2          2  359. 1460.  40.8     1    19    63 0.302
3          3  360. 1460.  40.1     0     7    17 0.412
4          4  364. 1497.  40.8     0     8    24 0.333
5          5  366. 1460.  40.8     0    10    26 0.385
6          6  367. 1463.  40.8     0     7    18 0.389</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>gambia_agg</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>color <span class='op'>=</span> <span class='va'>prev</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_path</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>gambia.borders</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span> <span class='op'>/</span> <span class='fl'>1000</span>, y <span class='op'>=</span> <span class='va'>y</span> <span class='op'>/</span> <span class='fl'>1000</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_fixed</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_color_viridis_c</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-3-1.png" width="624" /></p>
</div>
<p>We use the <code>gambia.borders</code> dataset from the <em>geoR</em> package to trace the country boundaries with <code>geom_path</code>. Since those boundaries are in meters, we divide by 1000 to get the same scale as our points. We also use <code>coord_fixed</code> to ensure a 1:1 aspect ratio between the axes and use the <code>viridis</code> color scale, which makes it easier to visualize a continuous variable compared with the default gradient scale in <em>ggplot2</em>.</p>
<p>Based on this map, there seems to be spatial correlation in malaria prevalence, with the eastern cluster of villages showing more high prevalence values (yellow-green) and the middle cluster showing more low prevalence values (purple).</p>
<h2 id="non-spatial-glmm">Non-spatial GLMM</h2>
<p>For this first example, we will ignore the spatial aspect of the data and model the presence of malaria (<em>pos</em>) as a function of the use of a bed net (<em>netuse</em>) and the presence of a public health centre (<em>phc</em>). Since we have a binary response, we need to use a logistic regression model (a GLM). Since we have predictors at both the individual and village level, and we expect that children of the same village have more similar probabilities of having malaria even after accounting for those predictors, we need to add a random effect of the village. The result is a GLMM that we fit using the <code>glmer</code> function in the <em>lme4</em> package.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/lme4/lme4/'>lme4</a></span><span class='op'>)</span>

<span class='va'>mod_glmm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/lme4/man/glmer.html'>glmer</a></span><span class='op'>(</span><span class='va'>pos</span> <span class='op'>~</span> <span class='va'>netuse</span> <span class='op'>+</span> <span class='va'>phc</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>id_village</span><span class='op'>)</span>, 
                  data <span class='op'>=</span> <span class='va'>gambia</span>, family <span class='op'>=</span> <span class='va'>binomial</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>mod_glmm</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace
  Approximation) [glmerMod]
 Family: binomial  ( logit )
Formula: pos ~ netuse + phc + (1 | id_village)
   Data: gambia

     AIC      BIC   logLik deviance df.resid 
  2428.0   2450.5  -1210.0   2420.0     2031 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.1286 -0.7120 -0.4142  0.8474  3.3434 

Random effects:
 Groups     Name        Variance Std.Dev.
 id_village (Intercept) 0.8149   0.9027  
Number of obs: 2035, groups:  id_village, 65

Fixed effects:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   0.1491     0.2297   0.649   0.5164    
netuse       -0.6044     0.1442  -4.190 2.79e-05 ***
phc          -0.4985     0.2604  -1.914   0.0556 .  
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Correlation of Fixed Effects:
       (Intr) netuse
netuse -0.422       
phc    -0.715 -0.025</code></pre>
</div>
<p>According to these results, both <em>netuse</em> and <em>phc</em> result in a decrease of malaria prevalence, although the effect of <em>phc</em> is not significant at a threshold <span class="math inline">\(\alpha = 0.05\)</span>. The intercept (0.149) is the logit of the probability of malaria presence for a child with no bednet and no public health centre, but it is the mean intercept across all villages, and there is a lot of variation between villages, based on the random effect standard deviation of 0.90. We can get the estimated intercept for each village with the function <code>coef</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/geoR/man/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/coef.html'>coef</a></span><span class='op'>(</span><span class='va'>mod_glmm</span><span class='op'>)</span><span class='op'>$</span><span class='va'>id_village</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>  (Intercept)     netuse        phc
1  0.93727515 -0.6043602 -0.4984835
2  0.09204843 -0.6043602 -0.4984835
3  0.22500620 -0.6043602 -0.4984835
4 -0.46271089 -0.6043602 -0.4984835
5  0.13680037 -0.6043602 -0.4984835
6 -0.03723346 -0.6043602 -0.4984835</code></pre>
</div>
<p>So for example, the intercept for village 1 is around 0.94, equivalent to a probability of 72%:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='fl'>0.937</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 0.7184933</code></pre>
</div>
<p>while the intercept in village 2 is equivalent to a probability of 52%:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='fl'>0.092</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] 0.5229838</code></pre>
</div>
<p>The <a href="https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html">DHARMa package</a> provides a general method for checking whether the residuals of a GLMM are distributed according to the specified model and whether there is any residual trend. The package works by simulating replicates of each observation according to the fitted model and then determining a “standardized residual”, which is the relative position of the observed value with respect to the simulated values, e.g. 0 if the observation is smaller than all the simulations, 0.5 if it is in the middle, etc. If the model represents the data well, each value of the standardized residual between 0 and 1 should be equally likely, so the standardized residuals should produce a uniform distribution between 0 and 1.</p>
<p>The <code>simulateResiduals</code> function performs the calculation of the standardized residuals, then the <code>plot</code> function plots the diagnostic graphs with the results of certain tests.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://florianhartig.github.io/DHARMa/'>DHARMa</a></span><span class='op'>)</span>
<span class='va'>res_glmm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/DHARMa/man/simulateResiduals.html'>simulateResiduals</a></span><span class='op'>(</span><span class='va'>mod_glmm</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>res_glmm</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-8-1.png" width="624" /></p>
</div>
<p>The graph on the left is a quantile-quantile plot of standardized residuals. The results of three statistical tests also also shown: a Kolmogorov-Smirnov (<em>KS</em>) test which checks whether there is a deviation from the theoretical distribution, a dispersion test that checks whether there is underdispersion or overdispersion, and an outlier test based on the number of residuals that are more extreme than all the simulations. Here, we get a significant result for the outliers, though the message indicates that this result might have an inflated type I error rate in this case.</p>
<p>On the right, we generally get a graph of standardized residuals (in <em>y</em>) as a function of the rank of the predicted values, in order to check for any leftover trend in the residual. Here, the predictions are binned by quartile, so it might be better to instead aggregate the predictions and residuals by village, which we can do with the <code>recalculateResiduals</code> function.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/DHARMa/man/recalculateResiduals.html'>recalculateResiduals</a></span><span class='op'>(</span><span class='va'>res_glmm</span>, group <span class='op'>=</span> <span class='va'>gambia</span><span class='op'>$</span><span class='va'>id_village</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-9-1.png" width="624" /></p>
</div>
<p>The plot to the right now shows individual points, along with a quantile regression for the 1st quartile, the median and the 3rd quartile. In theory, these three curves should be horizontal straight lines (no leftover trend in the residuals vs. predictions). The curve for the 3rd quartile (in red) is significantly different from a horizontal line, which could indicate some systematic effect that is missing from the model.</p>
<h2 id="spatial-glmm-with-spamm">Spatial GLMM with spaMM</h2>
<p>The <em>spaMM</em> (spatial mixed models) package is a relatively new R package that can perform approximate maximum likelihood estimation of parameters for GLMM with spatial dependence, modelled either as a Gaussian process or with a CAR (we will see the latter in the last section). The package implements different algorithms, but there is a single <code>fitme</code> function that chooses the appropriate algorithm for each model type. For example, here is the same (non-spatial) model as above fit with <em>spaMM</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://www.r-project.org'>spaMM</a></span><span class='op'>)</span>

<span class='va'>mod_spamm_glmm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/fitme.html'>fitme</a></span><span class='op'>(</span><span class='va'>pos</span> <span class='op'>~</span> <span class='va'>netuse</span> <span class='op'>+</span> <span class='va'>phc</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>id_village</span><span class='op'>)</span>,
                        data <span class='op'>=</span> <span class='va'>gambia</span>, family <span class='op'>=</span> <span class='va'>binomial</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/summary.HL.html'>summary</a></span><span class='op'>(</span><span class='va'>mod_spamm_glmm</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>formula: pos ~ netuse + phc + (1 | id_village)
Estimation of lambda by Laplace ML approximation (p_v).
Estimation of fixed effects by Laplace ML approximation (p_v).
family: binomial( link = logit ) 
 ------------ Fixed effects (beta) ------------
            Estimate Cond. SE t-value
(Intercept)   0.1491   0.2287  0.6519
netuse       -0.6045   0.1420 -4.2567
phc          -0.4986   0.2593 -1.9231
 --------------- Random effects ---------------
Family: gaussian( link = identity ) 
           --- Variance parameters (&#39;lambda&#39;):
lambda = var(u) for u ~ Gaussian; 
   id_village  :  0.8151  
             --- Coefficients for log(lambda):
      Group        Term Estimate Cond.SE
 id_village (Intercept)  -0.2045  0.2008
# of obs: 2035; # of groups: id_village, 65 
 ------------- Likelihood values  -------------
                        logLik
p_v(h) (marginal L): -1210.016</code></pre>
</div>
<p>Note that the estimates of the fixed effects as well as the variance of random effects are nearly identical to those obtained by <code>glmer</code> above.</p>
<p>We can now use <em>spaMM</em> to fit the same model with the addition of spatial correlations between villages. In the formula of the model, this is represented as a random effect <code>Matern(1 | x + y)</code>, which means that the intercepts are spatially correlated between villages following a Matérn correlation function of coordinates (<em>x, y</em>). The Matérn function is a flexible function for spatial correlation that includes a shape parameter <span class="math inline">\(\nu\)</span> (<code>nu</code>), so that when <span class="math inline">\(\nu = 0.5\)</span> it is equivalent to the exponential correlation but as <span class="math inline">\(\nu\)</span> grows to large values, it approaches a Gaussian correlation. We could let the function estimate <span class="math inline">\(\nu\)</span>, but here we will fix it to 0.5 with the <code>fixed</code> argument of <code>fitme</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mod_spamm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/fitme.html'>fitme</a></span><span class='op'>(</span><span class='va'>pos</span> <span class='op'>~</span> <span class='va'>netuse</span> <span class='op'>+</span> <span class='va'>phc</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/Matern.corr.html'>Matern</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>x</span> <span class='op'>+</span> <span class='va'>y</span><span class='op'>)</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>id_village</span><span class='op'>)</span>,
                   data <span class='op'>=</span> <span class='va'>gambia</span>, family <span class='op'>=</span> <span class='va'>binomial</span>, fixed <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>nu <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/summary.HL.html'>summary</a></span><span class='op'>(</span><span class='va'>mod_spamm</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>formula: pos ~ netuse + phc + Matern(1 | x + y) + (1 | id_village)
Estimation of lambda and corrPars by Laplace ML approximation (p_v).
Estimation of fixed effects by Laplace ML approximation (p_v).
family: binomial( link = logit ) 
 ------------ Fixed effects (beta) ------------
            Estimate Cond. SE t-value
(Intercept)  0.06861   0.3351  0.2047
netuse      -0.51719   0.1407 -3.6758
phc         -0.44416   0.2052 -2.1648
 --------------- Random effects ---------------
Family: gaussian( link = identity ) 
                   --- Correlation parameters:
      1.nu      1.rho 
0.50000000 0.05128915 
           --- Variance parameters (&#39;lambda&#39;):
lambda = var(u) for u ~ Gaussian; 
   x + y  :  0.6421 
   id_village  :  0.1978  
             --- Coefficients for log(lambda):
      Group        Term Estimate Cond.SE
      x + y (Intercept)   -0.443  0.2919
 id_village (Intercept)    -1.62  0.3166
# of obs: 2035; # of groups: x + y, 65; id_village, 65 
 ------------- Likelihood values  -------------
                        logLik
p_v(h) (marginal L): -1197.968</code></pre>
</div>
<p>Let’s first check the random effects of the model. The spatial correlation function has a parameter <code>rho</code> equal to 0.0513. This parameter in <em>spaMM</em> is the inverse of the range, so here the range of exponential correlation is 1/0.0513 or around 19.5 km. There are now two variance prameters, the one identified as <code>x + y</code> is the long-range variance (i.e. sill) for the exponential correlation model whereas the one identified as <code>id_village</code> shows the non-spatially correlated portion of the variation between villages.</p>
<p>In fact, while we left the random effects <code>(1 | id_village)</code> in the formula to represent the non-spatial portion of variation between villages, we could also represent this with a nugget effect in the geostatistical model. In both cases, it would represent the idea that even two villages very close to each other would have different baseline prevalences in the model.</p>
<p>By default, the <code>Matern</code> function has no nugget effect, but we can add one by specifying a non-zero <code>Nugget</code> in the initial parameter list <code>init</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mod_spamm2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/fitme.html'>fitme</a></span><span class='op'>(</span><span class='va'>pos</span> <span class='op'>~</span> <span class='va'>netuse</span> <span class='op'>+</span> <span class='va'>phc</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/Matern.corr.html'>Matern</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>x</span> <span class='op'>+</span> <span class='va'>y</span><span class='op'>)</span>,
                    data <span class='op'>=</span> <span class='va'>gambia</span>, family <span class='op'>=</span> <span class='va'>binomial</span>, fixed <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>nu <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span>,
                    init <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>Nugget <span class='op'>=</span> <span class='fl'>0.1</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/summary.HL.html'>summary</a></span><span class='op'>(</span><span class='va'>mod_spamm2</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>formula: pos ~ netuse + phc + Matern(1 | x + y)
Estimation of lambda and corrPars by Laplace ML approximation (p_v).
Estimation of fixed effects by Laplace ML approximation (p_v).
family: binomial( link = logit ) 
 ------------ Fixed effects (beta) ------------
            Estimate Cond. SE t-value
(Intercept)  0.06861   0.3352  0.2047
netuse      -0.51719   0.1407 -3.6758
phc         -0.44416   0.2052 -2.1648
 --------------- Random effects ---------------
Family: gaussian( link = identity ) 
                   --- Correlation parameters:
      1.nu   1.Nugget      1.rho 
0.50000000 0.23551424 0.05128739 
           --- Variance parameters (&#39;lambda&#39;):
lambda = var(u) for u ~ Gaussian; 
   x + y  :  0.8399  
             --- Coefficients for log(lambda):
 Group        Term Estimate Cond.SE
 x + y (Intercept)  -0.1744  0.2146
# of obs: 2035; # of groups: x + y, 65 
 ------------- Likelihood values  -------------
                        logLik
p_v(h) (marginal L): -1197.968</code></pre>
</div>
<p>As you can see, all estimates are the same, except that the variance of the spatial portion (sill) is now 0.84 and the nugget is equal to a fraction 0.235 of that sill, so a variance of 0.197, which is the same as the <code>id_village</code> random effect in the version above. Thus the two formulations are equivalent.</p>
<p>Now, recall the coefficients we obtained for the non-spatial GLMM:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/summary.HL.html'>summary</a></span><span class='op'>(</span><span class='va'>mod_glmm</span><span class='op'>)</span><span class='op'>$</span><span class='va'>coefficients</span>
</code></pre>
</div>
<pre><code>              Estimate Std. Error    z value     Pr(&gt;|z|)
(Intercept)  0.1490596  0.2297164  0.6488855 5.164124e-01
netuse      -0.6043602  0.1442451 -4.1898129 2.791846e-05
phc         -0.4984835  0.2604289 -1.9140866 5.560909e-02</code></pre>
</div>
<p>In the spatial version, both fixed effects have moved slightly towards zero, but the standard error of the effect of <code>phc</code> has decreased. It is interesting that the inclusion of spatial dependence has allowed us to estimate more precisely the effect of having a public health centre in the village. This would not always be the case: for a predictor that is also strongly correlated in space, spatial correlation in the response makes it harder to estimate the effect of this predictor, since it is confounded with the spatial effect. However, for a predictor that is not correlated in space, including the spatial effect reduces the residual (non-spatial) variance and may thus increase the precision of the predictor’s effect.</p>
<p>The <em>spaMM</em> package is also compatible with <em>DHARMa</em> for residual diagnostics. (You can in fact ignore the warning that it is not in the class of supported models, this is due to using the <code>fitme</code> function rather than a specific algorithm function in <em>spaMM</em>.)</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res_spamm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/DHARMa/man/simulateResiduals.html'>simulateResiduals</a></span><span class='op'>(</span><span class='va'>mod_spamm2</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/plot.HL.html'>plot</a></span><span class='op'>(</span><span class='va'>res_spamm</span><span class='op'>)</span>
</code></pre>
</div>
<img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-14-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/plot.HL.html'>plot</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/DHARMa/man/recalculateResiduals.html'>recalculateResiduals</a></span><span class='op'>(</span><span class='va'>res_spamm</span>, group <span class='op'>=</span> <span class='va'>gambia</span><span class='op'>$</span><span class='va'>id_village</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-14-2.png" width="624" /></p>
</div>
<p>Finally, while we will show how to make and visualize spatial predictions below, we can produce a quick map of the estimated spatial effects in a <em>spaMM</em> model with the <code>filled.mapMM</code> function.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/mapMM.html'>filled.mapMM</a></span><span class='op'>(</span><span class='va'>mod_spamm2</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-15-1.png" width="624" /></p>
</div>
<h2 id="gaussian-process-models-vs.-smoothing-splines">Gaussian process models vs. smoothing splines</h2>
<p>If you are familiar with generalized additive models (GAM), you might think that the spatial variation in malaria prevalence (as shown in the map above) could be represented by a 2D smoothing spline (as a function of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>) within a GAM.</p>
<p>The code below fits the GAM equivalent of our Gaussian process GLMM above with the <code>gam</code> function in the <em>mgcv</em> package. The spatial effect is represented by the 2D spline <code>s(x, y)</code> whereas the non-spatial random effect of village is represented by <code>s(id_village, bs = "re")</code>, which is the same as <code>(1 | id_village)</code> in the previous models. Note that for the <code>gam</code> function, categorical variables must be explicitly converted to factors.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>mgcv</span><span class='op'>)</span>
<span class='va'>gambia</span><span class='op'>$</span><span class='va'>id_village</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>gambia</span><span class='op'>$</span><span class='va'>id_village</span><span class='op'>)</span>
<span class='va'>mod_gam</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>gam</a></span><span class='op'>(</span><span class='va'>pos</span> <span class='op'>~</span> <span class='va'>netuse</span> <span class='op'>+</span> <span class='va'>phc</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>id_village</span>, bs <span class='op'>=</span> <span class='st'>"re"</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span>, 
               data <span class='op'>=</span> <span class='va'>gambia</span>, family <span class='op'>=</span> <span class='va'>binomial</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>To visualize the 2D spline, we will use the <a href="https://fromthebottomoftheheap.net/2018/10/23/introducing-gratia/"><em>gratia</em> package</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://gavinsimpson.github.io/gratia/'>gratia</a></span><span class='op'>)</span>
<span class='fu'><a href='https://gavinsimpson.github.io/gratia/reference/draw.html'>draw</a></span><span class='op'>(</span><span class='va'>mod_gam</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-17-1.png" width="624" /></p>
</div>
<p>Note that the plot of the spline <code>s(x, y)</code> (top right) does not extend too far from the locations of the data (other areas are blank). In this graph, we can also see that the village random effects follow the expected Gaussian distribution (top left).</p>
<p>Next, we will use both the spatial GLMM from the previous section and this GAMM to predict the mean prevalence on a spatial grid of points contained in the file <a href="data/gambia_pred.csv">gambia_pred.csv</a>. The graph below adds those prediction points (in black) on the previous map of the data points.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gambia_pred</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/utils/read.table.html'>read.csv</a></span><span class='op'>(</span><span class='st'>"data/gambia_pred.csv"</span><span class='op'>)</span>

<span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>gambia_agg</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>gambia_pred</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>color <span class='op'>=</span> <span class='va'>prev</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_path</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>gambia.borders</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span> <span class='op'>/</span> <span class='fl'>1000</span>, y <span class='op'>=</span> <span class='va'>y</span> <span class='op'>/</span> <span class='fl'>1000</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_fixed</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_color_viridis_c</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-18-1.png" width="624" /></p>
</div>
<p>To make predictions from the GAMM model at those points, the code below goes through the following steps:</p>
<ul>
<li><p>All predictors in the model must be in the prediction data frame, so we add constant values of <em>netuse</em> and <em>phc</em> (both equal to 1) for all points. Thus, we will make predictions of malaria prevalence in the case where a net is used and a public health centre is present. We also add a constant <em>id_village</em>, although it will not be used in predictions (see below).</p></li>
<li><p>We call the <code>predict</code> function on the output of <code>gam</code> to produce predictions at the new data points (argument <code>newdata</code>), including standard errors (<code>se.fit = TRUE</code>) and excluding the village random effects, so the prediction is made for an “average village”. The resulting object <code>gam_pred</code> will have columns <code>fit</code> (mean prediction) and <code>se.fit</code> (standard error). Those predictions and standard errors are on the link (logit) scale.</p></li>
<li><p>We add the original prediction data frame to <code>gam_pred</code> with <code>cbind</code>.</p></li>
<li><p>We add columns for the mean prediction and 50% confidence interval boundaries (mean <span class="math inline">\(\pm\)</span> 0.674 standard error), converted from the logit scale to the probability scale with <code>plogis</code>. We choose a 50% interval since a 95% interval may be too wide here to contrast the different predictions on the map at the end of this section.</p></li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gambia_pred</span> <span class='op'>&lt;-</span> <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>gambia_pred</span>, netuse <span class='op'>=</span> <span class='fl'>1</span>, phc <span class='op'>=</span> <span class='fl'>1</span>, id_village <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>

<span class='va'>gam_pred</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>mod_gam</span>, newdata <span class='op'>=</span> <span class='va'>gambia_pred</span>, se.fit <span class='op'>=</span> <span class='cn'>TRUE</span>, 
                    exclude <span class='op'>=</span> <span class='st'>"s(id_village)"</span><span class='op'>)</span>
<span class='va'>gam_pred</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span><span class='op'>(</span><span class='va'>gambia_pred</span>, <span class='fu'><a href='https://rdrr.io/r/base/as.data.frame.html'>as.data.frame</a></span><span class='op'>(</span><span class='va'>gam_pred</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>gam_pred</span> <span class='op'>&lt;-</span> <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>gam_pred</span>, pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span>, 
                   lo <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>0.674</span> <span class='op'>*</span> <span class='va'>se.fit</span><span class='op'>)</span>, <span class='co'># 50% CI</span>
                   hi <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>0.674</span> <span class='op'>*</span> <span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><em>Note</em>: The reason we do not make predictions directly on the probability (response) scale is that the normal formula for confidence intervals applies more accurately on the logit scale. Adding a certain number of standard errors around the mean on the probability scale would lead to less accurate intervals and maybe even confidence intervals outside the possible range (0, 1) for a probability.</p>
<p>We apply the same strategy to make predictions from the <em>spaMM</em> spatial GLMM model. There are a few differences in the <code>predict</code> method compared with the GAMM case.</p>
<ul>
<li><p>The argument <code>binding = "fit"</code> means that mean predictions (<code>fit</code> column) will be attached to the prediction dataset and returned as <code>spamm_pred</code>.</p></li>
<li><p>The <code>variances = list(linPred = TRUE)</code> tells <code>predict</code> to calculate the variance of the linear predictor (so the square of the standard error). However, it appears as an attribute <code>predVar</code> in the output data frame rather than a <code>se.fit</code> column, so we move it to a column on the next line.</p></li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>spamm_pred</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>mod_spamm</span>, newdata <span class='op'>=</span> <span class='va'>gambia_pred</span>, type <span class='op'>=</span> <span class='st'>"link"</span>,
                      binding <span class='op'>=</span> <span class='st'>"fit"</span>, variances <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>linPred <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>spamm_pred</span><span class='op'>$</span><span class='va'>se.fit</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/attr.html'>attr</a></span><span class='op'>(</span><span class='va'>spamm_pred</span>, <span class='st'>"predVar"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>spamm_pred</span> <span class='op'>&lt;-</span> <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>spamm_pred</span>, pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>)</span>, 
                     lo <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>fit</span> <span class='op'>-</span> <span class='fl'>0.674</span> <span class='op'>*</span> <span class='va'>se.fit</span><span class='op'>)</span>,
                     hi <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Logistic.html'>plogis</a></span><span class='op'>(</span><span class='va'>fit</span> <span class='op'>+</span> <span class='fl'>0.674</span> <span class='op'>*</span> <span class='va'>se.fit</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Finally, we combine both sets of predictions as different rows of a <code>pred_all</code> dataset with <code>bind_rows</code>. The name of the dataset each prediction originates from (<code>gam</code> or <code>spamm</code>) will appear in the “model” column (argument <code>.id</code>). To simplify production of the next plot, we then use <code>pivot_longer</code> in the <em>tidyr</em> package to change the three columns “pred”, “lo” and “hi” to two columns, “stat” and “value” (<code>pred_tall</code> has thus three rows for every row in <code>pred_all</code>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>pred_all</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span>gam <span class='op'>=</span> <span class='va'>gam_pred</span>, spamm <span class='op'>=</span> <span class='va'>spamm_pred</span>, .id <span class='op'>=</span> <span class='st'>"model"</span><span class='op'>)</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyr.tidyverse.org'>tidyr</a></span><span class='op'>)</span>
<span class='va'>pred_tall</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tidyr.tidyverse.org/reference/pivot_longer.html'>pivot_longer</a></span><span class='op'>(</span><span class='va'>pred_all</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>pred</span>, <span class='va'>lo</span>, <span class='va'>hi</span><span class='op'>)</span>, names_to <span class='op'>=</span> <span class='st'>"stat"</span>,
                          values_to <span class='op'>=</span> <span class='st'>"value"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Having done these steps, we can finally look at the prediction maps (mean, lower and upper bounds of the 50% confidence interval) with <code>ggplot</code>. The original data points are shown in red.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>pred_tall</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>color <span class='op'>=</span> <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>gambia_agg</span>, color <span class='op'>=</span> <span class='st'>"red"</span>, size <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>coord_fixed</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>facet_grid</span><span class='op'>(</span><span class='va'>stat</span><span class='op'>~</span><span class='va'>model</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>scale_color_viridis_c</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_minimal</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-22-1.png" width="624" /></p>
</div>
<p>While both models agree that there is a higher prevalence near the eastern cluster of villages, the GAMM also estimates a higher prevalence at a few points (western edge and around the center) where there is no data. This is an artifact of the shape of the spline fit around the data points, since a spline is meant to fit a global, although nonlinear, trend. In contrast, the geostatistical model represents the spatial effect as local correlations and reverts to the overall mean prevalence when far from any data points, which is a safer assumption. This is one reason to choose a geostatistical / Gaussian process model in this case.</p>
<h2 id="bayesian-methods-for-glmms-with-gaussian-processes">Bayesian methods for GLMMs with Gaussian processes</h2>
<p>Bayesian models provide a flexible framework to express models with complex dependence structure among the data, including spatial dependence. However, fitting a Gaussian process model with a fully Bayesian approach can be slow, due the need to compute a spatial covariance matrix between all point pairs at each iteration.</p>
<p>The INLA (integrated nested Laplace approximation) method performs an approximate calculation of the Bayesian posterior distribution, which makes it suitable for spatial regression problems. We do not cover it in this course, but I recommend the textbook by Paula Moraga (in the references section below) that provides worked examples of using INLA for various geostatistical and areal data models, in the context of epidemiology, including models with both space and time dependence. The book presents the same Gambia malaria data as an example of a geostatistical dataset, which inspired its use in this course.</p>
<h1 id="glmm-with-spatial-autoregression">GLMM with spatial autoregression</h1>
<p>We return to the last example of the previous part, where we modelled the rate of COVID-19 cases (cases / 1000) for administrative health network divisions (RLS) in Quebec as a function of their population density. The rate is given by the “taux_1k” column in the <code>rls_covid</code> shapefile.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r-spatial.github.io/sf/'>sf</a></span><span class='op'>)</span>
<span class='va'>rls_covid</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_read.html'>read_sf</a></span><span class='op'>(</span><span class='st'>"data/rls_covid.shp"</span><span class='op'>)</span>
<span class='va'>rls_covid</span> <span class='op'>&lt;-</span> <span class='va'>rls_covid</span><span class='op'>[</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>rls_covid</span><span class='op'>$</span><span class='va'>dens_pop</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>rls_covid</span><span class='op'>[</span><span class='st'>"taux_1k"</span><span class='op'>]</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="spatial-statistics-in-ecology-part-4_files/figure-html5/unnamed-chunk-23-1.png" width="624" /></p>
</div>
<p>Previously, we modelled the logarithm of this rate as a linear function of the logarithm of population density, with the residual variance correlated among neighbouring units via a CAR (conditional autoregression) structure, as shown in the code below.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/r-spatial/spdep/'>spdep</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/r-spatial/spatialreg/'>spatialreg</a></span><span class='op'>)</span>

<span class='va'>rls_nb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spdep/man/poly2nb.html'>poly2nb</a></span><span class='op'>(</span><span class='va'>rls_covid</span><span class='op'>)</span>
<span class='va'>rls_w</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spdep/man/nb2listw.html'>nb2listw</a></span><span class='op'>(</span><span class='va'>rls_nb</span>, style <span class='op'>=</span> <span class='st'>"B"</span><span class='op'>)</span>

<span class='va'>car_lm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spdep/man/spdep-deprecated.html'>spautolm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>taux_1k</span><span class='op'>)</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>dens_pop</span><span class='op'>)</span>, data <span class='op'>=</span> <span class='va'>rls_covid</span>,
                   listw <span class='op'>=</span> <span class='va'>rls_w</span>, family <span class='op'>=</span> <span class='st'>"CAR"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/summary.HL.html'>summary</a></span><span class='op'>(</span><span class='va'>car_lm</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>
Call: 
spautolm(formula = log(taux_1k) ~ log(dens_pop), data = rls_covid, 
    listw = rls_w, family = &quot;CAR&quot;)

Residuals:
      Min        1Q    Median        3Q       Max 
-1.201858 -0.254084 -0.053348  0.281482  1.427053 

Coefficients: 
              Estimate Std. Error z value  Pr(&gt;|z|)
(Intercept)   1.702068   0.168463 10.1035 &lt; 2.2e-16
log(dens_pop) 0.206623   0.032848  6.2903 3.169e-10

Lambda: 0.15762 LR test value: 23.991 p-value: 9.6771e-07 
Numerical Hessian standard error of lambda: 0.0050486 

Log likelihood: -80.68953 
ML residual variance (sigma squared): 0.2814, (sigma: 0.53048)
Number of observations: 95 
Number of parameters estimated: 4 
AIC: 169.38</code></pre>
</div>
<p>As a reminder, the <code>poly2nb</code> function in the <em>spdep</em> package creates a list of neighbours based on bordering polygons in a shapefile, then the <code>nb2listw</code> converts it to a list of weights, here binary weights (<code>style = "B"</code>) so that each bordering region receives the same weight of 1 in the autoregressive model.</p>
<p>Instead of using the rates, it would be possible to model the cases directly (column “cas” in the dataset) with a Poisson regression, which is appropriate for count data. To account for the fact that if the risk per person were equal, cases would be proportional to population, we can add the unit’s population <code>pop</code> as an <em>offset</em> in the Poisson regression. Therefore, the model would look like: <code>cas ~ log(dens_pop) + offset(log(pop))</code>. Note that since the Poisson regression uses a logarithmic link, that model with <code>log(pop)</code> as an offset assumes that <code>log(cas / pop)</code> (so the log rate) is proportional to <code>log(dens_pop)</code>, just like the linear model above, but it has the advantage of modelling the stochasticity of the raw data (the number of cases) directly with a Poisson distribution.</p>
<p>We do not have the population in this data, but we can estimate it from the cases and the rate (cases / 1000) as follows:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rls_covid</span><span class='op'>$</span><span class='va'>pop</span> <span class='op'>&lt;-</span> <span class='va'>rls_covid</span><span class='op'>$</span><span class='va'>cas</span> <span class='op'>/</span> <span class='va'>rls_covid</span><span class='op'>$</span><span class='va'>taux_1k</span> <span class='op'>*</span> <span class='fl'>1000</span>
</code></pre>
</div>
</div>
<p>To define a CAR model in <em>spaMM</em>, we need a weights matrix rather than a list of weights as in the <em>spatialreg</em> package. Fortunately, the <em>spdep</em> package also includes a function <code>nb2mat</code> to convert the neighbours list to a matrix of weights, here again using binary weights. To avoid a warning, we specify the row and column names of that matrix to be equal to the IDs associated with each unit (<code>RLS_code</code>). Then, we add a term <code>adjacency(1 | RLS_code)</code> to the model to specify that the residual variation between different groups defined by <code>RLS_code</code> is spatially correlated with a CAR structure (here, each group has only one observation since we have one data point by RLS unit).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://www.r-project.org'>spaMM</a></span><span class='op'>)</span>

<span class='va'>rls_mat</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spdep/man/nb2mat.html'>nb2mat</a></span><span class='op'>(</span><span class='va'>rls_nb</span>, style <span class='op'>=</span> <span class='st'>"B"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>rownames</a></span><span class='op'>(</span><span class='va'>rls_mat</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>rls_covid</span><span class='op'>$</span><span class='va'>RLS_code</span>
<span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>rls_mat</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='va'>rls_covid</span><span class='op'>$</span><span class='va'>RLS_code</span>

<span class='va'>rls_spamm</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/fitme.html'>fitme</a></span><span class='op'>(</span><span class='va'>cas</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>dens_pop</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/stats/offset.html'>offset</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>pop</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/autoregressive.html'>adjacency</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>RLS_code</span><span class='op'>)</span>,
                   data <span class='op'>=</span> <span class='va'>rls_covid</span>, adjMatrix <span class='op'>=</span> <span class='va'>rls_mat</span>, family <span class='op'>=</span> <span class='va'>poisson</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/spaMM/man/summary.HL.html'>summary</a></span><span class='op'>(</span><span class='va'>rls_spamm</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>formula: cas ~ log(dens_pop) + offset(log(pop)) + adjacency(1 | RLS_code)
Estimation of lambda and corrPars by Laplace ML approximation (p_v).
Estimation of fixed effects by Laplace ML approximation (p_v).
family: poisson( link = log ) 
 ------------ Fixed effects (beta) ------------
              Estimate Cond. SE t-value
(Intercept)    -5.1620  0.16858 -30.621
log(dens_pop)   0.1999  0.03267   6.118
 --------------- Random effects ---------------
Family: gaussian( link = identity ) 
                   --- Correlation parameters:
    1.rho 
0.1576786 
           --- Variance parameters (&#39;lambda&#39;):
lambda = var(u) for u ~ Gaussian; 
   RLS_code  :  0.266  
             --- Coefficients for log(lambda):
    Group        Term Estimate Cond.SE
 RLS_code (Intercept)   -1.324  0.1473
# of obs: 95; # of groups: RLS_code, 95 
 ------------- Likelihood values  -------------
                        logLik
p_v(h) (marginal L): -709.3234</code></pre>
</div>
<p>Note that the spatial correlation coefficient <code>rho</code> (0.158) is similar to the equivalent quantity in the <code>spautolm</code> model above, where it was called <code>Lambda</code>. The effect of <code>log(dens_pop)</code> is also approximately 0.2 in both models.</p>
<h1 id="reference">Reference</h1>
<p>Moraga, Paula (2019) Geospatial Health Data: Modeling and Visualization with R-INLA and Shiny. Chapman &amp; Hall/CRC Biostatistics Series. Available online at <a href="https://www.paulamoraga.com/book-geospatial/">https://www.paulamoraga.com/book-geospatial/</a>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
